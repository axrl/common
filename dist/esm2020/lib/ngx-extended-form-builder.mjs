import { FormGroup, FormArray, FormControl } from "@angular/forms";
import { Observable } from "rxjs";
function getValidatorsOrNull(key, keysValidator, addLift = false) {
    const result = keysValidator && keysValidator.has(key) ? keysValidator.get(key) : null;
    if (addLift) {
        if (result && Array.isArray(result)) {
            result.push(liftErrors);
            return result;
        }
        else {
            return result ? result : [liftErrors];
        }
    }
    else {
        return result;
    }
    ;
}
function makeFormGroup(source, internalKey, keysValidator, asyncKeysValidator) {
    return source instanceof FormGroup ? source : Object.entries(source).reduce((accumulator, entry) => {
        const key = entry[0];
        const value = entry[1];
        if (!(value instanceof Observable)) {
            accumulator.addControl(key, !!value && value instanceof FormControl || value instanceof FormGroup || value instanceof FormArray ?
                value :
                makeForm(value, makeNewMainFormValidatorsMap(key, keysValidator), makeNewMainFormValidatorsMap(key, asyncKeysValidator)));
        }
        ;
        return accumulator;
    }, new FormGroup({}, getValidatorsOrNull(internalKey, keysValidator, true), getValidatorsOrNull(internalKey, asyncKeysValidator, false)));
}
function makeNewMainFormValidatorsMap(key, oldMap) {
    if (!oldMap || key === 'mainFormValidators' || key === 'mainFormValidatorsItems') {
        return oldMap;
    }
    else {
        if (!oldMap.has(key) && !oldMap.has(`${key}Items`)) {
            return new Map(Array.from(oldMap.entries()).filter(item => item[0] !== 'mainFormValidators' && item[0] !== 'mainFormValidatorsItems').map(([entryKey, entryValue]) => [entryKey.startsWith(`${key}.`) ? entryKey.replace(`${key}.`, '') : entryKey, entryValue]));
        }
        else {
            const filterPredicate = oldMap.has('mainFormValidators') ?
                oldMap.has('mainFormValidatorsItems') ?
                    (item) => item[0] !== key && item[0] !== 'mainFormValidators' && item[0] !== 'mainFormValidatorsItems' :
                    (item) => item[0] !== key && item[0] !== 'mainFormValidators' :
                oldMap.has('mainFormValidatorsItems') ?
                    (item) => item[0] !== key && item[0] !== 'mainFormValidatorsItems' :
                    (item) => item[0] !== key;
            const newMainValidatorsArray = oldMap.has(key) ?
                oldMap.has(`${key}Items`) ?
                    [
                        ['mainFormValidators', oldMap.get(key)],
                        ['mainFormValidatorsItems', oldMap.get(`${key}Items`)]
                    ] :
                    [
                        ['mainFormValidators', oldMap.get(key)],
                    ] :
                oldMap.has(`${key}Items`) ?
                    [
                        ['mainFormValidatorsItems', oldMap.get(`${key}Items`)]
                    ] :
                    [];
            return new Map([
                ...newMainValidatorsArray,
                ...Array.from(oldMap.entries()).filter(filterPredicate).map(([entryKey, entryValue]) => [entryKey.startsWith(`${key}.`) ? entryKey.replace(`${key}.`, '') : entryKey, entryValue])
            ]);
        }
        ;
    }
    ;
}
export function makeForm(source, keysValidator, asyncKeysValidator) {
    const form = !!source && (typeof source === 'object' || typeof source === 'function') ?
        source instanceof Array ?
            new FormArray(source.map(item => {
                const itemForm = makeForm(item, makeNewMainFormValidatorsMap('mainFormValidatorsItems', keysValidator), makeNewMainFormValidatorsMap('mainFormValidatorsItems', asyncKeysValidator));
                return itemForm;
            }), getValidatorsOrNull('mainFormValidators', keysValidator, true), getValidatorsOrNull('mainFormValidators', asyncKeysValidator, false)) :
            makeFormGroup(source, 'mainFormValidators', keysValidator, asyncKeysValidator) :
        new FormControl(!!source && typeof source == 'string' && (source.includes('0001-01-01') || source.includes('1970-01-01')) ? null : source, getValidatorsOrNull('mainFormValidators', keysValidator, false), getValidatorsOrNull('mainFormValidators', asyncKeysValidator, false));
    return form;
}
;
function liftErrors(control) {
    if (control instanceof FormControl) {
        return null;
    }
    else {
        const allControls = control instanceof FormGroup ?
            Object.values(control.controls) :
            control instanceof FormArray ?
                control.controls :
                [];
        const invalidControls = allControls.filter(control => control.status === 'INVALID');
        return invalidControls.length === 0 ? null : invalidControls.reduce((accumulator, current) => {
            if (current.errors) {
                addValidationErrors(current.errors, accumulator);
            }
            ;
            return accumulator;
        }, {});
    }
}
export function liftValidationErrors(control) {
    const allControls = control instanceof FormGroup ?
        Object.values(control.controls) :
        control instanceof FormArray ?
            control.controls :
            [];
    const invalidControls = allControls.filter(control => control.status === 'INVALID');
    const errors = invalidControls.length === 0 ? {} : invalidControls.reduce((accumulator, current) => {
        if (current.errors) {
            addValidationErrors(current.errors, accumulator);
        }
        ;
        const innerErrors = liftValidationErrors(current);
        if (innerErrors) {
            addValidationErrors(innerErrors, accumulator);
        }
        ;
        return accumulator;
    }, {});
    return Object.values(errors).length === 0 ? null : errors;
}
;
function addValidationErrors(additionErrors, currentErrors) {
    Object.entries(additionErrors).forEach(entry => currentErrors[entry[0]] = entry[1]);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LWV4dGVuZGVkLWZvcm0tYnVpbGRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3Byb2plY3RzL25neC1leHRlbmRlZC1mb3JtLWJ1aWxkZXIvc3JjL2xpYi9uZ3gtZXh0ZW5kZWQtZm9ybS1idWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRW5FLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFbEMsU0FBUyxtQkFBbUIsQ0FDMUIsR0FBVyxFQUFFLGFBQThCLEVBQUUsVUFBbUIsS0FBSztJQUVyRSxNQUFNLE1BQU0sR0FBRyxhQUFhLElBQUksYUFBYSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO0lBQ3ZGLElBQUksT0FBTyxFQUFFO1FBQ1gsSUFBSSxNQUFNLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUNsQixNQUFPLENBQUMsSUFBSSxDQUFlLFVBQVUsQ0FBQyxDQUFDO1lBQ3hELE9BQVcsTUFBTSxDQUFDO1NBQ25CO2FBQU07WUFDTCxPQUFPLE1BQU0sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBSSxDQUFFLFVBQVUsQ0FBRSxDQUFDO1NBQzVDO0tBQ0Y7U0FBTTtRQUNMLE9BQU8sTUFBTSxDQUFDO0tBQ2Y7SUFBQSxDQUFDO0FBQ0osQ0FBQztBQUVELFNBQVMsYUFBYSxDQUNwQixNQUFXLEVBQ1gsV0FBbUIsRUFDbkIsYUFBaUQsRUFDakQsa0JBQTJEO0lBRTNELE9BQU8sTUFBTSxZQUFZLFNBQVMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLE1B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QUUsQ0FBQyxDQUFFLENBQ2xELENBQUM7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRm9ybUdyb3VwLCBGb3JtQXJyYXksIEZvcm1Db250cm9sIH0gZnJvbSBcIkBhbmd1bGFyL2Zvcm1zXCI7XG5pbXBvcnQgdHlwZSB7IFZhbGlkYXRvckZuLCBWYWxpZGF0aW9uRXJyb3JzLCBBYnN0cmFjdENvbnRyb2wsIEFzeW5jVmFsaWRhdG9yRm4gfSBmcm9tIFwiQGFuZ3VsYXIvZm9ybXNcIjtcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tIFwicnhqc1wiO1xuXG5mdW5jdGlvbiBnZXRWYWxpZGF0b3JzT3JOdWxsPFQgZXh0ZW5kcyBWYWxpZGF0b3JGbltdIHwgQXN5bmNWYWxpZGF0b3JGbltdIHwgbnVsbD4oXG4gIGtleTogc3RyaW5nLCBrZXlzVmFsaWRhdG9yPzogTWFwPHN0cmluZywgVD4sIGFkZExpZnQ6IGJvb2xlYW4gPSBmYWxzZVxuKTogVCB8IHVuZGVmaW5lZCB8IG51bGwge1xuICBjb25zdCByZXN1bHQgPSBrZXlzVmFsaWRhdG9yICYmIGtleXNWYWxpZGF0b3IuaGFzKGtleSkgPyBrZXlzVmFsaWRhdG9yLmdldChrZXkpIDogbnVsbDtcbiAgaWYgKGFkZExpZnQpIHtcbiAgICBpZiAocmVzdWx0ICYmIEFycmF5LmlzQXJyYXkocmVzdWx0KSkge1xuICAgICAgKDxWYWxpZGF0b3JGbltdPiByZXN1bHQpLnB1c2goPFZhbGlkYXRvckZuPiBsaWZ0RXJyb3JzKTtcbiAgICAgIHJldHVybiA8VD4gcmVzdWx0O1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gcmVzdWx0ID8gcmVzdWx0IDogPFQ+WyBsaWZ0RXJyb3JzIF07XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH07XG59XG5cbmZ1bmN0aW9uIG1ha2VGb3JtR3JvdXA8VD4oXG4gIHNvdXJjZTogYW55LFxuICBpbnRlcm5hbEtleTogc3RyaW5nLFxuICBrZXlzVmFsaWRhdG9yPzogTWFwPHN0cmluZywgVmFsaWRhdG9yRm5bXSB8IG51bGw+LFxuICBhc3luY0tleXNWYWxpZGF0b3I/OiBNYXA8c3RyaW5nLCBBc3luY1ZhbGlkYXRvckZuW10gfCBudWxsPlxuKTogRm9ybUdyb3VwPHsgWyBLIGluIGtleW9mIFQgXTogQWJzdHJhY3RDb250cm9sPGFueSwgYW55PjsgfT4ge1xuICByZXR1cm4gc291cmNlIGluc3RhbmNlb2YgRm9ybUdyb3VwID8gc291cmNlIDogT2JqZWN0LmVudHJpZXMoc291cmNlKS5yZWR1Y2UoXG4gICAgKGFjY3VtdWxhdG9yOiBGb3JtR3JvdXAsIGVudHJ5OiBbIHN0cmluZywgdW5rbm93biBdKSA9PiB7XG4gICAgICBjb25zdCBrZXkgPSBlbnRyeVsgMCBdO1xuICAgICAgY29uc3QgdmFsdWUgPSBlbnRyeVsgMSBdO1xuICAgICAgaWYgKCEodmFsdWUgaW5zdGFuY2VvZiBPYnNlcnZhYmxlKSkge1xuICAgICAgICBhY2N1bXVsYXRvci5hZGRDb250cm9sKFxuICAgICAgICAgIGtleSxcbiAgICAgICAgICAhIXZhbHVlICYmIHZhbHVlIGluc3RhbmNlb2YgRm9ybUNvbnRyb2wgfHwgdmFsdWUgaW5zdGFuY2VvZiBGb3JtR3JvdXAgfHwgdmFsdWUgaW5zdGFuY2VvZiBGb3JtQXJyYXkgP1xuICAgICAgICAgICAgdmFsdWUgOlxuICAgICAgICAgICAgbWFrZUZvcm0oXG4gICAgICAgICAgICAgIHZhbHVlLFxuICAgICAgICAgICAgICBtYWtlTmV3TWFpbkZvcm1WYWxpZGF0b3JzTWFwKGtleSwga2V5c1ZhbGlkYXRvciksXG4gICAgICAgICAgICAgIG1ha2VOZXdNYWluRm9ybVZhbGlkYXRvcnNNYXAoa2V5LCBhc3luY0tleXNWYWxpZGF0b3IpLFxuICAgICAgICAgICAgKVxuICAgICAgICApO1xuICAgICAgfTtcbiAgICAgIHJldHVybiBhY2N1bXVsYXRvcjtcbiAgICB9LCBuZXcgRm9ybUdyb3VwKHt9LFxuICAgICAgZ2V0VmFsaWRhdG9yc09yTnVsbChpbnRlcm5hbEtleSwga2V5c1ZhbGlkYXRvciwgdHJ1ZSksXG4gICAgICBnZXRWYWxpZGF0b3JzT3JOdWxsKGludGVybmFsS2V5LCBhc3luY0tleXNWYWxpZGF0b3IsIGZhbHNlKVxuICAgIClcbiAgKTtcbn1cblxuZnVuY3Rpb24gbWFrZU5ld01haW5Gb3JtVmFsaWRhdG9yc01hcDxUIGV4dGVuZHMgVmFsaWRhdG9yRm5bXSB8IEFzeW5jVmFsaWRhdG9yRm5bXSB8IG51bGw+KFxuICBrZXk6IHN0cmluZywgb2xkTWFwPzogTWFwPHN0cmluZywgVD4sXG4pOiBNYXA8c3RyaW5nLCBUPiB8IHVuZGVmaW5lZCB7XG4gIGlmICghb2xkTWFwIHx8IGtleSA9PT0gJ21haW5Gb3JtVmFsaWRhdG9ycycgfHwga2V5ID09PSAnbWFpbkZvcm1WYWxpZGF0b3JzSXRlbXMnKSB7XG4gICAgcmV0dXJuIG9sZE1hcDtcbiAgfSBlbHNlIHtcbiAgICBpZiAoIW9sZE1hcC5oYXMoa2V5KSAmJiAhb2xkTWFwLmhhcyhgJHsga2V5IH1JdGVtc2ApKSB7XG4gICAgICByZXR1cm4gbmV3IE1hcDxzdHJpbmcsIFQ+KFxuICAgICAgICBBcnJheS5mcm9tKFxuICAgICAgICAgIG9sZE1hcC5lbnRyaWVzKClcbiAgICAgICAgKS5maWx0ZXIoXG4gICAgICAgICAgaXRlbSA9PiBpdGVtWyAwIF0gIT09ICdtYWluRm9ybVZhbGlkYXRvcnMnICYmIGl0ZW1bIDAgXSAhPT0gJ21haW5Gb3JtVmFsaWRhdG9yc0l0ZW1zJ1xuICAgICAgICApLm1hcChcbiAgICAgICAgICAoWyBlbnRyeUtleSwgZW50cnlWYWx1ZSBdKSA9PiBbIGVudHJ5S2V5LnN0YXJ0c1dpdGgoYCR7IGtleSB9LmApID8gZW50cnlLZXkucmVwbGFjZShgJHsga2V5IH0uYCwgJycpIDogZW50cnlLZXksIGVudHJ5VmFsdWUgXVxuICAgICAgICApXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBmaWx0ZXJQcmVkaWNhdGUgPSBvbGRNYXAuaGFzKCdtYWluRm9ybVZhbGlkYXRvcnMnKSA/XG4gICAgICAgIG9sZE1hcC5oYXMoJ21haW5Gb3JtVmFsaWRhdG9yc0l0ZW1zJykgP1xuICAgICAgICAgIChpdGVtOiBbIHN0cmluZywgVCBdKSA9PiBpdGVtWyAwIF0gIT09IGtleSAmJiBpdGVtWyAwIF0gIT09ICdtYWluRm9ybVZhbGlkYXRvcnMnICYmIGl0ZW1bIDAgXSAhPT0gJ21haW5Gb3JtVmFsaWRhdG9yc0l0ZW1zJyA6XG4gICAgICAgICAgKGl0ZW06IFsgc3RyaW5nLCBUIF0pID0+IGl0ZW1bIDAgXSAhPT0ga2V5ICYmIGl0ZW1bIDAgXSAhPT0gJ21haW5Gb3JtVmFsaWRhdG9ycycgOlxuICAgICAgICBvbGRNYXAuaGFzKCdtYWluRm9ybVZhbGlkYXRvcnNJdGVtcycpID9cbiAgICAgICAgICAoaXRlbTogWyBzdHJpbmcsIFQgXSkgPT4gaXRlbVsgMCBdICE9PSBrZXkgJiYgaXRlbVsgMCBdICE9PSAnbWFpbkZvcm1WYWxpZGF0b3JzSXRlbXMnIDpcbiAgICAgICAgICAoaXRlbTogWyBzdHJpbmcsIFQgXSkgPT4gaXRlbVsgMCBdICE9PSBrZXk7XG4gICAgICBjb25zdCBuZXdNYWluVmFsaWRhdG9yc0FycmF5OiBbIHN0cmluZywgVCBdW10gPSBvbGRNYXAuaGFzKGtleSkgP1xuICAgICAgICBvbGRNYXAuaGFzKGAkeyBrZXkgfUl0ZW1zYCkgP1xuICAgICAgICAgIFtcbiAgICAgICAgICAgIFsgJ21haW5Gb3JtVmFsaWRhdG9ycycsIG9sZE1hcC5nZXQoa2V5KSEgXSxcbiAgICAgICAgICAgIFsgJ21haW5Gb3JtVmFsaWRhdG9yc0l0ZW1zJywgb2xkTWFwLmdldChgJHsga2V5IH1JdGVtc2ApISBdXG4gICAgICAgICAgXSA6XG4gICAgICAgICAgW1xuICAgICAgICAgICAgWyAnbWFpbkZvcm1WYWxpZGF0b3JzJywgb2xkTWFwLmdldChrZXkpISBdLFxuICAgICAgICAgIF0gOlxuICAgICAgICBvbGRNYXAuaGFzKGAkeyBrZXkgfUl0ZW1zYCkgP1xuICAgICAgICAgIFtcbiAgICAgICAgICAgIFsgJ21haW5Gb3JtVmFsaWRhdG9yc0l0ZW1zJywgb2xkTWFwLmdldChgJHsga2V5IH1JdGVtc2ApISBdXG4gICAgICAgICAgXSA6XG4gICAgICAgICAgW107XG4gICAgICByZXR1cm4gbmV3IE1hcDxzdHJpbmcsIFQ+KFtcbiAgICAgICAgLi4ubmV3TWFpblZhbGlkYXRvcnNBcnJheSxcbiAgICAgICAgLi4uQXJyYXkuZnJvbShcbiAgICAgICAgICBvbGRNYXAuZW50cmllcygpXG4gICAgICAgICkuZmlsdGVyKGZpbHRlclByZWRpY2F0ZSkubWFwPFsgc3RyaW5nLCBUIF0+KFxuICAgICAgICAgIChbIGVudHJ5S2V5LCBlbnRyeVZhbHVlIF0pID0+IFsgZW50cnlLZXkuc3RhcnRzV2l0aChgJHsga2V5IH0uYCkgPyBlbnRyeUtleS5yZXBsYWNlKGAkeyBrZXkgfS5gLCAnJykgOiBlbnRyeUtleSwgZW50cnlWYWx1ZSBdXG4gICAgICAgIClcbiAgICAgIF0pO1xuICAgIH07XG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtYWtlRm9ybTxULFxuICBSIGV4dGVuZHMgKFxuICAgIFQgZXh0ZW5kcyBBcnJheTxpbmZlciBVPiA/IEZvcm1BcnJheTxcbiAgICAgIFUgZXh0ZW5kcyBBcnJheTxhbnk+ID8gRm9ybUFycmF5PEFic3RyYWN0Q29udHJvbDxVLCBVPj4gOlxuICAgICAgVSBleHRlbmRzIHN0cmluZyB8IG51bWJlciB8IGJvb2xlYW4gfCBzeW1ib2wgfCBudWxsIHwgdW5kZWZpbmVkID8gRm9ybUNvbnRyb2w8VSB8IG51bGw+IDogRm9ybUdyb3VwPHsgWyBLIGluIGtleW9mIFUgXTogQWJzdHJhY3RDb250cm9sPFVbIEsgXSwgVVsgSyBdPjsgfT5cbiAgICA+IDogVCBleHRlbmRzIHN0cmluZyB8IG51bWJlciB8IGJvb2xlYW4gfCBzeW1ib2wgfCBudWxsIHwgdW5kZWZpbmVkID8gRm9ybUNvbnRyb2w8VCB8IG51bGw+IDogRm9ybUdyb3VwPHsgWyBLIGluIGtleW9mIFQgXTogQWJzdHJhY3RDb250cm9sPFRbIEsgXSwgVFsgSyBdPjsgfT5cbiAgKT4oXG4gICAgc291cmNlOiBULFxuICAgIGtleXNWYWxpZGF0b3I/OiBNYXA8c3RyaW5nLCBWYWxpZGF0b3JGbltdIHwgbnVsbD4sXG4gICAgYXN5bmNLZXlzVmFsaWRhdG9yPzogTWFwPHN0cmluZywgQXN5bmNWYWxpZGF0b3JGbltdIHwgbnVsbD4sXG4pOiBSIHtcbiAgY29uc3QgZm9ybSA9ICEhc291cmNlICYmICh0eXBlb2Ygc291cmNlID09PSAnb2JqZWN0JyB8fCB0eXBlb2Ygc291cmNlID09PSAnZnVuY3Rpb24nKSA/XG4gICAgc291cmNlIGluc3RhbmNlb2YgQXJyYXkgP1xuICAgICAgbmV3IEZvcm1BcnJheShcbiAgICAgICAgc291cmNlLm1hcChcbiAgICAgICAgICBpdGVtID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGl0ZW1Gb3JtID0gbWFrZUZvcm0oXG4gICAgICAgICAgICAgIGl0ZW0sXG4gICAgICAgICAgICAgIG1ha2VOZXdNYWluRm9ybVZhbGlkYXRvcnNNYXAoJ21haW5Gb3JtVmFsaWRhdG9yc0l0ZW1zJywga2V5c1ZhbGlkYXRvciksXG4gICAgICAgICAgICAgIG1ha2VOZXdNYWluRm9ybVZhbGlkYXRvcnNNYXAoJ21haW5Gb3JtVmFsaWRhdG9yc0l0ZW1zJywgYXN5bmNLZXlzVmFsaWRhdG9yKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHJldHVybiBpdGVtRm9ybTtcbiAgICAgICAgICB9KSxcbiAgICAgICAgZ2V0VmFsaWRhdG9yc09yTnVsbCgnbWFpbkZvcm1WYWxpZGF0b3JzJywga2V5c1ZhbGlkYXRvciwgdHJ1ZSksXG4gICAgICAgIGdldFZhbGlkYXRvcnNPck51bGwoJ21haW5Gb3JtVmFsaWRhdG9ycycsIGFzeW5jS2V5c1ZhbGlkYXRvciwgZmFsc2UpXG4gICAgICApIDpcbiAgICAgIG1ha2VGb3JtR3JvdXAoc291cmNlLCAnbWFpbkZvcm1WYWxpZGF0b3JzJywga2V5c1ZhbGlkYXRvciwgYXN5bmNLZXlzVmFsaWRhdG9yKSA6XG4gICAgbmV3IEZvcm1Db250cm9sPFQgfCBudWxsPihcbiAgICAgICEhc291cmNlICYmIHR5cGVvZiBzb3VyY2UgPT0gJ3N0cmluZycgJiYgKHNvdXJjZS5pbmNsdWRlcygnMDAwMS0wMS0wMScpIHx8IHNvdXJjZS5pbmNsdWRlcygnMTk3MC0wMS0wMScpKSA/IG51bGwgOiBzb3VyY2VcbiAgICAgICxcbiAgICAgIGdldFZhbGlkYXRvcnNPck51bGwoJ21haW5Gb3JtVmFsaWRhdG9ycycsIGtleXNWYWxpZGF0b3IsIGZhbHNlKSxcbiAgICAgIGdldFZhbGlkYXRvcnNPck51bGwoJ21haW5Gb3JtVmFsaWRhdG9ycycsIGFzeW5jS2V5c1ZhbGlkYXRvciwgZmFsc2UpXG4gICAgKTtcbiAgcmV0dXJuIDxSPiBmb3JtO1xufTtcblxuZnVuY3Rpb24gbGlmdEVycm9ycyhjb250cm9sOiBBYnN0cmFjdENvbnRyb2wpOiBWYWxpZGF0aW9uRXJyb3JzIHwgbnVsbCB7XG4gIGlmIChjb250cm9sIGluc3RhbmNlb2YgRm9ybUNvbnRyb2wpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfSBlbHNlIHtcbiAgICBjb25zdCBhbGxDb250cm9scyA9IGNvbnRyb2wgaW5zdGFuY2VvZiBGb3JtR3JvdXAgP1xuICAgICAgT2JqZWN0LnZhbHVlcyhjb250cm9sLmNvbnRyb2xzKSA6XG4gICAgICBjb250cm9sIGluc3RhbmNlb2YgRm9ybUFycmF5ID9cbiAgICAgICAgY29udHJvbC5jb250cm9scyA6XG4gICAgICAgIFtdO1xuICAgIGNvbnN0IGludmFsaWRDb250cm9scyA9IGFsbENvbnRyb2xzLmZpbHRlcihjb250cm9sID0+IGNvbnRyb2wuc3RhdHVzID09PSAnSU5WQUxJRCcpO1xuICAgIHJldHVybiBpbnZhbGlkQ29udHJvbHMubGVuZ3RoID09PSAwID8gbnVsbCA6IGludmFsaWRDb250cm9scy5yZWR1Y2UoXG4gICAgICAoYWNjdW11bGF0b3IsIGN1cnJlbnQpID0+IHtcbiAgICAgICAgaWYgKGN1cnJlbnQuZXJyb3JzKSB7XG4gICAgICAgICAgYWRkVmFsaWRhdGlvbkVycm9ycyhjdXJyZW50LmVycm9ycywgYWNjdW11bGF0b3IpO1xuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gYWNjdW11bGF0b3I7XG4gICAgICB9LCA8VmFsaWRhdGlvbkVycm9ycz4ge31cbiAgICApO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBsaWZ0VmFsaWRhdGlvbkVycm9ycyhjb250cm9sOiBBYnN0cmFjdENvbnRyb2wpOiBWYWxpZGF0aW9uRXJyb3JzIHwgbnVsbCB7XG4gIGNvbnN0IGFsbENvbnRyb2xzID0gY29udHJvbCBpbnN0YW5jZW9mIEZvcm1Hcm91cCA/XG4gICAgT2JqZWN0LnZhbHVlcyhjb250cm9sLmNvbnRyb2xzKSA6XG4gICAgY29udHJvbCBpbnN0YW5jZW9mIEZvcm1BcnJheSA/XG4gICAgICBjb250cm9sLmNvbnRyb2xzIDpcbiAgICAgIFtdO1xuICBjb25zdCBpbnZhbGlkQ29udHJvbHMgPSBhbGxDb250cm9scy5maWx0ZXIoY29udHJvbCA9PiBjb250cm9sLnN0YXR1cyA9PT0gJ0lOVkFMSUQnKTtcbiAgY29uc3QgZXJyb3JzOiBWYWxpZGF0aW9uRXJyb3JzID0gaW52YWxpZENvbnRyb2xzLmxlbmd0aCA9PT0gMCA/IHt9IDogaW52YWxpZENvbnRyb2xzLnJlZHVjZShcbiAgICAoYWNjdW11bGF0b3IsIGN1cnJlbnQpID0+IHtcbiAgICAgIGlmIChjdXJyZW50LmVycm9ycykge1xuICAgICAgICBhZGRWYWxpZGF0aW9uRXJyb3JzKGN1cnJlbnQuZXJyb3JzLCBhY2N1bXVsYXRvcik7XG4gICAgICB9O1xuICAgICAgY29uc3QgaW5uZXJFcnJvcnMgPSBsaWZ0VmFsaWRhdGlvbkVycm9ycyhjdXJyZW50KTtcbiAgICAgIGlmIChpbm5lckVycm9ycykge1xuICAgICAgICBhZGRWYWxpZGF0aW9uRXJyb3JzKGlubmVyRXJyb3JzLCBhY2N1bXVsYXRvcik7XG4gICAgICB9O1xuICAgICAgcmV0dXJuIGFjY3VtdWxhdG9yO1xuICAgIH0sIDxWYWxpZGF0aW9uRXJyb3JzPiB7fVxuICApO1xuICByZXR1cm4gT2JqZWN0LnZhbHVlcyhlcnJvcnMpLmxlbmd0aCA9PT0gMCA/IG51bGwgOiBlcnJvcnM7XG59O1xuXG5mdW5jdGlvbiBhZGRWYWxpZGF0aW9uRXJyb3JzKGFkZGl0aW9uRXJyb3JzOiBWYWxpZGF0aW9uRXJyb3JzLCBjdXJyZW50RXJyb3JzOiBWYWxpZGF0aW9uRXJyb3JzKSB7XG4gIE9iamVjdC5lbnRyaWVzKGFkZGl0aW9uRXJyb3JzKS5mb3JFYWNoKFxuICAgIGVudHJ5ID0+IGN1cnJlbnRFcnJvcnNbIGVudHJ5WyAwIF0gXSA9IGVudHJ5WyAxIF1cbiAgKTtcbn0iXX0=