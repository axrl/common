import { FormGroup, FormArray, FormControl } from "@angular/forms";
import { Observable } from "rxjs";
function getValidatorsOrNull(key, keysValidator, addLift = false) {
    const result = keysValidator && keysValidator.has(key) ? keysValidator.get(key) : null;
    if (addLift) {
        if (result && Array.isArray(result)) {
            result.push(liftErrors);
            return result;
        }
        else {
            return result ? result : [liftErrors];
        }
    }
    else {
        return result;
    }
    ;
}
function makeFormGroup(source, internalKey, keysValidator, asyncKeysValidator) {
    return source instanceof (FormGroup) ?
        source :
        Object.entries(source).reduce((accumulator, entry) => {
            const key = entry[0];
            const value = entry[1];
            if (!(value instanceof Observable)) {
                accumulator.addControl(key, !!value && (value instanceof FormGroup || value instanceof FormArray || value instanceof FormControl) ?
                    value :
                    makeForm(value, makeNewmainMap(key, keysValidator), makeNewmainMap(key, asyncKeysValidator)));
            }
            ;
            return accumulator;
        }, new FormGroup({}, getValidatorsOrNull(internalKey, keysValidator, true), getValidatorsOrNull(internalKey, asyncKeysValidator, false)));
}
function makeNewmainMap(key, oldMap) {
    if (!oldMap || key === 'main' || key === 'mainItems') {
        return oldMap;
    }
    else {
        if (!oldMap.has(key) && !oldMap.has(`${key}Items`)) {
            return new Map(Array.from(oldMap.entries()).filter(item => item[0] !== 'main' && item[0] !== 'mainItems').map(([entryKey, entryValue]) => [entryKey.startsWith(`${key}.`) ? entryKey.replace(`${key}.`, '') : entryKey, entryValue]));
        }
        else {
            const filterPredicate = oldMap.has('main') ?
                oldMap.has('mainItems') ?
                    (item) => item[0] !== key && item[0] !== 'main' && item[0] !== 'mainItems' :
                    (item) => item[0] !== key && item[0] !== 'main' :
                oldMap.has('mainItems') ?
                    (item) => item[0] !== key && item[0] !== 'mainItems' :
                    (item) => item[0] !== key;
            const newMainValidatorsArray = oldMap.has(key) ?
                oldMap.has(`${key}Items`) ?
                    [
                        ['main', oldMap.get(key)],
                        ['mainItems', oldMap.get(`${key}Items`)]
                    ] :
                    [
                        ['main', oldMap.get(key)],
                    ] :
                oldMap.has(`${key}Items`) ?
                    [
                        ['mainItems', oldMap.get(`${key}Items`)]
                    ] :
                    [];
            return new Map([
                ...newMainValidatorsArray,
                ...Array.from(oldMap.entries()).filter(filterPredicate).map(([entryKey, entryValue]) => [entryKey.startsWith(`${key}.`) ? entryKey.replace(`${key}.`, '') : entryKey, entryValue])
            ]);
        }
        ;
    }
    ;
}
/**
@function makeForm<T>
  Фабричная функция для создания Angular Reactive Form.
В отличие от стандартного FormBuilder - а в пакете @angular/forms, при создании формы из сложных объектов,
сохраняется вложенность контролов - каждый вложенный объект превращается во вложенную FormGroup,
  обычные свойства объектов становятся FormControl - ами, а массивы - FormArray - ми.
При этом создаваемая форма имеет более строгую типизацию.

  ВАЖНО!
   Чтобы избежать ошибки переполнения стэка вызовов в рекурсивном процессе создания формы, для любых;
Observable - значений(в т.ч., к примеру, Subject * и EventEmitter) соответствующий элемент формы не создается.
 * @param source  источник данных типа T для создания формы.
 * @param keysValidator объект Map с конфигурацией синхронных валидаторов контролов формы.
 * В качестве ключей могут быть указаны следующие значения:
 *  PropertyesKeys<T> - строковые ключи в типе T, включая строковые ключи всех вложенных типов, разделенные "." - точкой.
    Например имеется такой тип:
    ```ts
                    interface User {
                      firstname: string;
                      lastname: string;
                      phone:  {
                        code: string;
                        number: string;
                        }
                      };
    ```
    Для формы, которая будет создана из объекта User в конфигурации валидаторов названия контролов можно будет указать так:
    `lastname` или`phone`, или`phone.code`.

   'main' - специальное значение, являющееся признаком того, что массив валидаторов необходимо
    назначить самому объекту формы, а не вложеным контролам.

   'mainItems' - используется только если source является массивом. Специальное значение, являющееся признаком того,
  что массив валидаторов необходимо назначить для всех элементов массива FormArray.
 * @param asyncKeysValidator объект Map, аналогичный keysValidator, но для асинхронных валидаторов
 * @returns объект типизированной формы - FormGroup, FormArray или FormControl в зависимости от типа значения source.
 */
export function makeForm(source, keysValidator, asyncKeysValidator) {
    const form = !!source && (typeof source === 'object' || typeof source === 'function') ?
        source instanceof (Array) ?
            new FormArray(source.map((item) => {
                const itemForm = makeForm(item, makeNewmainMap('mainItems', keysValidator), makeNewmainMap('mainItems', asyncKeysValidator));
                return itemForm;
            }), getValidatorsOrNull('main', keysValidator, true), getValidatorsOrNull('main', asyncKeysValidator, false)) :
            makeFormGroup(source, 'main', keysValidator, asyncKeysValidator) :
        new FormControl(!!source && typeof source == 'string' && (source.includes('0001-01-01') || source.includes('1970-01-01')) ? null : source, getValidatorsOrNull('main', keysValidator, false), getValidatorsOrNull('main', asyncKeysValidator, false));
    return form;
}
;
function liftErrors(control) {
    if (control instanceof FormControl) {
        return null;
    }
    else {
        const allControls = control instanceof FormGroup ?
            Object.values(control.controls) :
            control instanceof FormArray ?
                control.controls :
                [];
        const invalidControls = allControls.filter(control => control.status === 'INVALID');
        return invalidControls.length === 0 ? null : invalidControls.reduce((accumulator, current) => {
            if (current.errors) {
                addValidationErrors(current.errors, accumulator);
            }
            ;
            return accumulator;
        }, {});
    }
}
export function liftValidationErrors(control) {
    const allControls = control instanceof FormGroup ?
        Object.values(control.controls) :
        control instanceof FormArray ?
            control.controls :
            [];
    const invalidControls = allControls.filter(control => control.status === 'INVALID');
    const errors = invalidControls.length === 0 ? {} : invalidControls.reduce((accumulator, current) => {
        if (current.errors) {
            addValidationErrors(current.errors, accumulator);
        }
        ;
        const innerErrors = liftValidationErrors(current);
        if (innerErrors) {
            addValidationErrors(innerErrors, accumulator);
        }
        ;
        return accumulator;
    }, {});
    return Object.values(errors).length === 0 ? null : errors;
}
;
function addValidationErrors(additionErrors, currentErrors) {
    Object.entries(additionErrors).forEach(entry => currentErrors[entry[0]] = entry[1]);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LWV4dGVuZGVkLWZvcm0tYnVpbGRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3Byb2plY3RzL25neC1leHRlbmRlZC1mb3JtLWJ1aWxkZXIvc3JjL2xpYi9uZ3gtZXh0ZW5kZWQtZm9ybS1idWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRW5FLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUErRGxDLFNBQVMsbUJBQW1CLENBQzFCLEdBQVcsRUFBRSxhQUE4QixFQUFFLFVBQW1CLEtBQUs7SUFFckUsTUFBTSxNQUFNLEdBQUcsYUFBYSxJQUFJLGFBQWEsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUN2RixJQUFJLE9BQU8sRUFBRTtRQUNYLElBQUksTUFBTSxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDbEIsTUFBTyxDQUFDLElBQUksQ0FBZSxVQUFVLENBQUMsQ0FBQztZQUN4RCxPQUFXLE1BQU0sQ0FBQztTQUNuQjthQUFNO1lBQ0wsT0FBTyxNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUksQ0FBRSxVQUFVLENBQUUsQ0FBQztTQUM1QztLQUNGO1NBQU07UUFDTCxPQUFPLE1BQU0sQ0FBQztLQUNmO0lBQUEsQ0FBQztBQUNKLENBQUM7QUFFRCxTQUFTLGFBQWEsQ0FDcEIsTUFBUyxFQUNULFdBQW1CLEVBQ25CLGFBQTJELEVBQzNELGtCQUFxRTtJQUVyRSxPQUFPLE1BQU0sYUFBWSxTQUE0RCxDQUFBLENBQUMsQ0FBQztRQUNyRixNQUFNLENBQUMsQ0FBQztRQUNtQyxNQUFNLENBQUMsT0FB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LENBQUUsQ0FBQyxDQUFFLENBQUUsR0FBRyxLQUFLLENBQUUsQ0FBQyxDQUFFLENBQ2xELENBQUM7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRm9ybUdyb3VwLCBGb3JtQXJyYXksIEZvcm1Db250cm9sIH0gZnJvbSBcIkBhbmd1bGFyL2Zvcm1zXCI7XG5pbXBvcnQgdHlwZSB7IFZhbGlkYXRvckZuLCBWYWxpZGF0aW9uRXJyb3JzLCBBc3luY1ZhbGlkYXRvckZuLCBBYnN0cmFjdENvbnRyb2wgfSBmcm9tIFwiQGFuZ3VsYXIvZm9ybXNcIjtcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tIFwicnhqc1wiO1xuXG4vKipcbiAqINCS0YHQv9C+0LzQvtCz0LDRgtC10LvRjNC90LDRjyDRg9GC0LjQu9C40YLQsCDRgtC40L/QsC5cbiAqINCd0LAg0LLRhdC+0LQg0L/RgNC40L3QuNC80LDQtdGCINC90LXQutC40Lkg0YLQuNC/IFQsINCy0L7Qt9Cy0YDQsNGJ0LDQtdGCINGB0L/QuNGB0L7QuiDRgtC+0LvRjNC60L4g0YHRgtGA0L7QutC+0LLRi9GFINC60LvRjtGH0LXQuSDRjdGC0L7Qs9C+INGC0LjQv9CwLCDQv9GA0Lgg0Y3RgtC+0Lwg0LfQvdCw0YfQtdC90LjRjyDRjdGC0LjRhSDQutC70Y7Rh9C10Lkg0L3QtSDRj9Cy0LvRj9GO0YLRgdGPIE9ic2VydmFibGUuXG4gKi9cbmV4cG9ydCB0eXBlIFN0cmluZ0tleXM8VD4gPSB7XG4gIFsgSyBpbiBrZXlvZiBUIF06IFRbIEsgXSBleHRlbmRzIE9ic2VydmFibGU8dW5rbm93bj4gP1xuICBuZXZlciA6XG4gIEsgZXh0ZW5kcyBzdHJpbmcgP1xuICBLIDogbmV2ZXI7XG59WyBrZXlvZiBUIF07XG5cbi8qKlxuICog0JLRgdC/0L7QvNC+0LPQsNGC0LXQu9GM0L3Ri9C5IGFsaWFzLdGC0LjQvyDQutC70Y7Rh9C10Lkg0LIg0L7QsdGK0LXQutGC0LUgTWFwLCDRgdC+0LTQtdGA0LbQsNGJ0LXQvCDQutC+0L3RhNC40LPRg9GA0LDRhtC40Y4g0LLQsNC70LjQtNCw0YLQvtGA0L7QsiDQutC+0L3RgtGA0L7Qu9C+0LIuXG4gKi9cbmV4cG9ydCB0eXBlIENvbnRyb2xzTmFtZXM8VD4gPSBUIGV4dGVuZHMgQXJyYXk8aW5mZXIgVT4gP1xuICAnbWFpbicgfCAnbWFpbkl0ZW1zJyB8IGBtYWluSXRlbXMuJHsgUHJvcGVydHllc0tleXM8VT4gfWAgOlxuICBUIGV4dGVuZHMgT2JzZXJ2YWJsZTx1bmtub3duPiA/XG4gIG5ldmVyIDpcbiAgJ21haW4nIHwgUHJvcGVydHllc0tleXM8VD47XG4vKipcbiAqINCS0YHQv9C+0LzQvtCz0LDRgtC10LvRjNC90LDRjyDRg9GC0LjQu9C40YLQsCDRgtC40L/QsC5cbiAqINCd0LAg0LLRhdC+0LQg0L/RgNC40L3QuNC80LDQtdGCINC90LXQutC40Lkg0YLQuNC/IFQsINCy0L7Qt9Cy0YDQsNGJ0LDQtdGCINGC0L7Qu9GM0LrQviDRgdGC0YDQvtC60L7QstGL0LUg0LrQu9GO0YfQuCDRjdGC0L7Qs9C+INGC0LjQv9CwLlxuICovXG5leHBvcnQgdHlwZSBQcm9wZXJ0eWVzS2V5czxUPiA9IFQgZXh0ZW5kcyB1bmRlZmluZWQgfCBudWxsIHwgbnVtYmVyIHwgYm9vbGVhbiB8IHN5bWJvbCB8IE9ic2VydmFibGU8dW5rbm93bj4gP1xuICBuZXZlciA6XG4gIFQgZXh0ZW5kcyBzdHJpbmcgP1xuICBUIDogVCBleHRlbmRzIEFycmF5PGluZmVyIFU+ID9cbiAgUHJvcGVydHllc0tleXM8VT4gOlxuICB7XG4gICAgWyBLIGluIGtleW9mIFQgXS0/OiBLIGV4dGVuZHMgc3RyaW5nID9cbiAgICBUWyBLIF0gZXh0ZW5kcyAoc3RyaW5nIHwgbnVtYmVyIHwgYm9vbGVhbiB8IHN5bWJvbCB8IHVuZGVmaW5lZCB8IG51bGwpID9cbiAgICBLIDpcbiAgICBUWyBLIF0gZXh0ZW5kcyBPYnNlcnZhYmxlPHVua25vd24+ID9cbiAgICBuZXZlciA6XG4gICAgVFsgSyBdIGV4dGVuZHMgQXJyYXk8aW5mZXIgVT4gP1xuICAgIGAkeyBLIH1JdGVtcy4keyBQcm9wZXJ0eWVzS2V5czxVPiB9YCB8IGAkeyBLIH1JdGVtc2AgfCBLIDpcbiAgICBgJHsgSyB9LiR7IFByb3BlcnR5ZXNLZXlzPFRbIEsgXT4gfWAgfCBLIDogbmV2ZXJcbiAgfVsga2V5b2YgVCBdO1xuLyoqXG4gKiDQo9C/0YDQvtGJ0LXQvdC90LDRjyDQt9Cw0L/QuNGB0Ywg0LTQu9GPINGC0LjQv9CwINC+0LHRitC10LrRgtCwIEZvcm1Hcm91cCwg0L7QsdGA0LDQt9C+0LLQsNC90L3QvtCz0L4g0LjQtyDRgtC40L/QsCBULlxuICovXG5leHBvcnQgdHlwZSBGb3JtR3JvdXBUeXBlPFQ+ID0gRm9ybUdyb3VwPHsgWyBLIGluIFN0cmluZ0tleXM8VD4gXTogU2NhbkZvcm1UeXBlPFRbIEsgXT47IH0+O1xuXG4vKipcbiAqINCj0L3QuNCy0LXRgNGB0LDQu9GM0L3Ri9C5INGC0LjQvy3Rg9GC0LjQu9C40YLQsC5cbiAqINCU0LvRjyDQu9GO0LHQvtCz0L4g0YLQuNC/0LAg0KIg0LLRi9Cy0L7QtNC40YIg0L/RgNCw0LLQuNC70YzQvdGL0Lkg0YLQuNC/INGB0L7Qt9C00LDQstCw0LXQvNC+0Lkg0YTQvtGA0LzRiywg0LLQutC70Y7Rh9Cw0Y8g0LvRjtCx0L7QuSDRg9GA0L7QstC10L3RjCDQstC70L7QttC10L3QvdC+0YHRgtC4LlxuICog0JLQkNCW0J3QniFcbiAqINCn0YLQvtCx0Ysg0LjQt9Cx0LXQttCw0YLRjCDQvtGI0LjQsdC60Lgg0L/QtdGA0LXQv9C+0LvQvdC10L3QuNGPINGB0YLRjdC60LAg0LLRi9C30L7QstC+0LIg0LIg0YDQtdC60YPRgNGB0LjQstC90L7QvCDQv9GA0L7RhtC10YHRgdC1INGB0L7Qt9C00LDQvdC40Y8g0YTQvtGA0LzRiywg0LTQu9GPINC70Y7QsdGL0YVcbiAqIE9ic2VydmFibGUt0LfQvdCw0YfQtdC90LjQuSAoINCyINGCLtGHLiwg0Log0L/RgNC40LzQtdGA0YMsIFN1YmplY3QgICog0LggRXZlbnRFbWl0dGVyKSDRgdC+0L7RgtCy0LXRgtGB0YLQstGD0Y7RidC40Lkg0Y3Qu9C10LzQtdC90YIg0YTQvtGA0LzRiyDQvdC1INGB0L7Qt9C00LDQtdGC0YHRjy5cbiAqIFNjYW5Gb3JtVHlwZSDRjdGC0L4g0YLQsNC60LbQtSDRg9GH0LjRgtGL0LLQsNC10YIuXG4gKi9cbmV4cG9ydCB0eXBlIFNjYW5Gb3JtVHlwZTxUPiA9IFQgZXh0ZW5kcyBBYnN0cmFjdENvbnRyb2w8dW5rbm93biwgdW5rbm93bj4gP1xuICBUIDpcbiAgVCBleHRlbmRzIG51bGwgfCB1bmRlZmluZWQgP1xuICBuZXZlciA6XG4gIFQgZXh0ZW5kcyBBcnJheTxpbmZlciBVPiA/XG4gIEZvcm1BcnJheTxTY2FuRm9ybVR5cGU8VT4+IDpcbiAgVCBleHRlbmRzIChzdHJpbmcgfCBudW1iZXIgfCBib29sZWFuIHwgc3ltYm9sIHwgbnVsbCB8IHVuZGVmaW5lZCkgP1xuICBGb3JtQ29udHJvbDxUPiA6XG4gIEZvcm1Hcm91cFR5cGU8VD47XG5cbmZ1bmN0aW9uIGdldFZhbGlkYXRvcnNPck51bGw8VCBleHRlbmRzIFZhbGlkYXRvckZuW10gfCBBc3luY1ZhbGlkYXRvckZuW10gfCBudWxsPihcbiAga2V5OiBzdHJpbmcsIGtleXNWYWxpZGF0b3I/OiBNYXA8c3RyaW5nLCBUPiwgYWRkTGlmdDogYm9vbGVhbiA9IGZhbHNlXG4pOiBUIHwgdW5kZWZpbmVkIHwgbnVsbCB7XG4gIGNvbnN0IHJlc3VsdCA9IGtleXNWYWxpZGF0b3IgJiYga2V5c1ZhbGlkYXRvci5oYXMoa2V5KSA/IGtleXNWYWxpZGF0b3IuZ2V0KGtleSkgOiBudWxsO1xuICBpZiAoYWRkTGlmdCkge1xuICAgIGlmIChyZXN1bHQgJiYgQXJyYXkuaXNBcnJheShyZXN1bHQpKSB7XG4gICAgICAoPFZhbGlkYXRvckZuW10+IHJlc3VsdCkucHVzaCg8VmFsaWRhdG9yRm4+IGxpZnRFcnJvcnMpO1xuICAgICAgcmV0dXJuIDxUPiByZXN1bHQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiByZXN1bHQgPyByZXN1bHQgOiA8VD5bIGxpZnRFcnJvcnMgXTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfTtcbn1cblxuZnVuY3Rpb24gbWFrZUZvcm1Hcm91cDxUPihcbiAgc291cmNlOiBULFxuICBpbnRlcm5hbEtleTogc3RyaW5nLFxuICBrZXlzVmFsaWRhdG9yPzogTWFwPENvbnRyb2xzTmFtZXM8VD4sIFZhbGlkYXRvckZuW10gfCBudWxsPixcbiAgYXN5bmNLZXlzVmFsaWRhdG9yPzogTWFwPENvbnRyb2xzTmFtZXM8VD4sIEFzeW5jVmFsaWRhdG9yRm5bXSB8IG51bGw+XG4pOiBGb3JtR3JvdXBUeXBlPFQ+IHtcbiAgcmV0dXJuIHNvdXJjZSBpbnN0YW5jZW9mIEZvcm1Hcm91cDx7IFsgSyBpbiBTdHJpbmdLZXlzPFQ+IF06IFNjYW5Gb3JtVHlwZTxUWyBLIF0+OyB9PiA/XG4gICAgc291cmNlIDpcbiAgICAoPFsgU3RyaW5nS2V5czxUPiwgVFsgU3RyaW5nS2V5czxUPiBdIF1bXT4gT2JqZWN0LmVudHJpZXMoc291cmNlKSkucmVkdWNlKFxuICAgICAgKGFjY3VtdWxhdG9yOiBGb3JtR3JvdXAsIGVudHJ5OiBbIFN0cmluZ0tleXM8VD4sIFRbIFN0cmluZ0tleXM8VD4gXSBdKSA9PiB7XG4gICAgICAgIGNvbnN0IGtleSA9IGVudHJ5WyAwIF07XG4gICAgICAgIGNvbnN0IHZhbHVlID0gZW50cnlbIDEgXTtcbiAgICAgICAgaWYgKCEodmFsdWUgaW5zdGFuY2VvZiBPYnNlcnZhYmxlKSkge1xuICAgICAgICAgIGFjY3VtdWxhdG9yLmFkZENvbnRyb2woXG4gICAgICAgICAgICBrZXksXG4gICAgICAgICAgICAhIXZhbHVlICYmIChcbiAgICAgICAgICAgICAgdmFsdWUgaW5zdGFuY2VvZiBGb3JtR3JvdXAgfHwgdmFsdWUgaW5zdGFuY2VvZiBGb3JtQXJyYXkgfHwgdmFsdWUgaW5zdGFuY2VvZiBGb3JtQ29udHJvbFxuICAgICAgICAgICAgKSA/XG4gICAgICAgICAgICAgIDxTY2FuRm9ybVR5cGU8VFsgU3RyaW5nS2V5czxUPiBdPj4gdmFsdWUgOlxuICAgICAgICAgICAgICBtYWtlRm9ybTxUWyBTdHJpbmdLZXlzPFQ+IF0+KFxuICAgICAgICAgICAgICAgIHZhbHVlLFxuICAgICAgICAgICAgICAgIDxNYXA8Q29udHJvbHNOYW1lczxUWyBTdHJpbmdLZXlzPFQ+IF0+LCBWYWxpZGF0b3JGbltdIHwgbnVsbD4+IG1ha2VOZXdtYWluTWFwPFZhbGlkYXRvckZuW10gfCBudWxsLCBUPihrZXksIGtleXNWYWxpZGF0b3IpLFxuICAgICAgICAgICAgICAgIDxNYXA8Q29udHJvbHNOYW1lczxUWyBTdHJpbmdLZXlzPFQ+IF0+LCBBc3luY1ZhbGlkYXRvckZuW10gfCBudWxsPj4gbWFrZU5ld21haW5NYXA8QXN5bmNWYWxpZGF0b3JGbltdIHwgbnVsbCwgVD4oa2V5LCBhc3luY0tleXNWYWxpZGF0b3IpLFxuICAgICAgICAgICAgICApXG4gICAgICAgICAgKTtcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIDxGb3JtR3JvdXBUeXBlPFQ+PiBhY2N1bXVsYXRvcjtcbiAgICAgIH0sIG5ldyBGb3JtR3JvdXA8eyBbIEsgaW4gU3RyaW5nS2V5czxUPiBdOiBTY2FuRm9ybVR5cGU8VFsgSyBdPjsgfT4oPHsgWyBLIGluIFN0cmluZ0tleXM8VD4gXTogU2NhbkZvcm1UeXBlPFRbIEsgXT47IH0+IHt9LFxuICAgICAgICBnZXRWYWxpZGF0b3JzT3JOdWxsKGludGVybmFsS2V5LCBrZXlzVmFsaWRhdG9yLCB0cnVlKSxcbiAgICAgICAgZ2V0VmFsaWRhdG9yc09yTnVsbChpbnRlcm5hbEtleSwgYXN5bmNLZXlzVmFsaWRhdG9yLCBmYWxzZSlcbiAgICAgIClcbiAgICApO1xufVxuXG5mdW5jdGlvbiBtYWtlTmV3bWFpbk1hcDxUIGV4dGVuZHMgVmFsaWRhdG9yRm5bXSB8IEFzeW5jVmFsaWRhdG9yRm5bXSB8IG51bGwsIFA+KFxuICBrZXk6IFN0cmluZ0tleXM8UD4sIG9sZE1hcD86IE1hcDxzdHJpbmcsIFQ+LFxuKTogTWFwPHN0cmluZywgVD4gfCB1bmRlZmluZWQge1xuICBpZiAoIW9sZE1hcCB8fCBrZXkgPT09ICdtYWluJyB8fCBrZXkgPT09ICdtYWluSXRlbXMnKSB7XG4gICAgcmV0dXJuIG9sZE1hcDtcbiAgfSBlbHNlIHtcbiAgICBpZiAoIW9sZE1hcC5oYXMoa2V5KSAmJiAhb2xkTWFwLmhhcyhgJHsga2V5IH1JdGVtc2ApKSB7XG4gICAgICByZXR1cm4gbmV3IE1hcDxzdHJpbmcsIFQ+KFxuICAgICAgICBBcnJheS5mcm9tKFxuICAgICAgICAgIG9sZE1hcC5lbnRyaWVzKClcbiAgICAgICAgKS5maWx0ZXIoXG4gICAgICAgICAgaXRlbSA9PiBpdGVtWyAwIF0gIT09ICdtYWluJyAmJiBpdGVtWyAwIF0gIT09ICdtYWluSXRlbXMnXG4gICAgICAgICkubWFwKFxuICAgICAgICAgIChbIGVudHJ5S2V5LCBlbnRyeVZhbHVlIF0pID0+IFsgZW50cnlLZXkuc3RhcnRzV2l0aChgJHsga2V5IH0uYCkgPyBlbnRyeUtleS5yZXBsYWNlKGAkeyBrZXkgfS5gLCAnJykgOiBlbnRyeUtleSwgZW50cnlWYWx1ZSBdXG4gICAgICAgIClcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGZpbHRlclByZWRpY2F0ZSA9IG9sZE1hcC5oYXMoJ21haW4nKSA/XG4gICAgICAgIG9sZE1hcC5oYXMoJ21haW5JdGVtcycpID9cbiAgICAgICAgICAoaXRlbTogWyBzdHJpbmcsIFQgXSkgPT4gaXRlbVsgMCBdICE9PSBrZXkgJiYgaXRlbVsgMCBdICE9PSAnbWFpbicgJiYgaXRlbVsgMCBdICE9PSAnbWFpbkl0ZW1zJyA6XG4gICAgICAgICAgKGl0ZW06IFsgc3RyaW5nLCBUIF0pID0+IGl0ZW1bIDAgXSAhPT0ga2V5ICYmIGl0ZW1bIDAgXSAhPT0gJ21haW4nIDpcbiAgICAgICAgb2xkTWFwLmhhcygnbWFpbkl0ZW1zJykgP1xuICAgICAgICAgIChpdGVtOiBbIHN0cmluZywgVCBdKSA9PiBpdGVtWyAwIF0gIT09IGtleSAmJiBpdGVtWyAwIF0gIT09ICdtYWluSXRlbXMnIDpcbiAgICAgICAgICAoaXRlbTogWyBzdHJpbmcsIFQgXSkgPT4gaXRlbVsgMCBdICE9PSBrZXk7XG4gICAgICBjb25zdCBuZXdNYWluVmFsaWRhdG9yc0FycmF5OiBbIHN0cmluZywgVCBdW10gPSBvbGRNYXAuaGFzKGtleSkgP1xuICAgICAgICBvbGRNYXAuaGFzKGAkeyBrZXkgfUl0ZW1zYCkgP1xuICAgICAgICAgIFtcbiAgICAgICAgICAgIFsgJ21haW4nLCBvbGRNYXAuZ2V0KGtleSkhIF0sXG4gICAgICAgICAgICBbICdtYWluSXRlbXMnLCBvbGRNYXAuZ2V0KGAkeyBrZXkgfUl0ZW1zYCkhIF1cbiAgICAgICAgICBdIDpcbiAgICAgICAgICBbXG4gICAgICAgICAgICBbICdtYWluJywgb2xkTWFwLmdldChrZXkpISBdLFxuICAgICAgICAgIF0gOlxuICAgICAgICBvbGRNYXAuaGFzKGAkeyBrZXkgfUl0ZW1zYCkgP1xuICAgICAgICAgIFtcbiAgICAgICAgICAgIFsgJ21haW5JdGVtcycsIG9sZE1hcC5nZXQoYCR7IGtleSB9SXRlbXNgKSEgXVxuICAgICAgICAgIF0gOlxuICAgICAgICAgIFtdO1xuICAgICAgcmV0dXJuIG5ldyBNYXA8c3RyaW5nLCBUPihbXG4gICAgICAgIC4uLm5ld01haW5WYWxpZGF0b3JzQXJyYXksXG4gICAgICAgIC4uLkFycmF5LmZyb20oXG4gICAgICAgICAgb2xkTWFwLmVudHJpZXMoKVxuICAgICAgICApLmZpbHRlcihmaWx0ZXJQcmVkaWNhdGUpLm1hcDxbIHN0cmluZywgVCBdPihcbiAgICAgICAgICAoWyBlbnRyeUtleSwgZW50cnlWYWx1ZSBdKSA9PiBbIGVudHJ5S2V5LnN0YXJ0c1dpdGgoYCR7IGtleSB9LmApID8gZW50cnlLZXkucmVwbGFjZShgJHsga2V5IH0uYCwgJycpIDogZW50cnlLZXksIGVudHJ5VmFsdWUgXVxuICAgICAgICApXG4gICAgICBdKTtcbiAgICB9O1xuICB9O1xufVxuXG4vKipcbkBmdW5jdGlvbiBtYWtlRm9ybTxUPlxuICDQpNCw0LHRgNC40YfQvdCw0Y8g0YTRg9C90LrRhtC40Y8g0LTQu9GPINGB0L7Qt9C00LDQvdC40Y8gQW5ndWxhciBSZWFjdGl2ZSBGb3JtLlxu0JIg0L7RgtC70LjRh9C40LUg0L7RgiDRgdGC0LDQvdC00LDRgNGC0L3QvtCz0L4gRm9ybUJ1aWxkZXIgLSDQsCDQsiDQv9Cw0LrQtdGC0LUgQGFuZ3VsYXIvZm9ybXMsINC/0YDQuCDRgdC+0LfQtNCw0L3QuNC4INGE0L7RgNC80Ysg0LjQtyDRgdC70L7QttC90YvRhSDQvtCx0YrQtdC60YLQvtCyLFxu0YHQvtGF0YDQsNC90Y/QtdGC0YHRjyDQstC70L7QttC10L3QvdC+0YHRgtGMINC60L7QvdGC0YDQvtC70L7QsiAtINC60LDQttC00YvQuSDQstC70L7QttC10L3QvdGL0Lkg0L7QsdGK0LXQutGCINC/0YDQtdCy0YDQsNGJ0LDQtdGC0YHRjyDQstC+INCy0LvQvtC20LXQvdC90YPRjiBGb3JtR3JvdXAsXG4gINC+0LHRi9GH0L3Ri9C1INGB0LLQvtC50YHRgtCy0LAg0L7QsdGK0LXQutGC0L7QsiDRgdGC0LDQvdC+0LLRj9GC0YHRjyBGb3JtQ29udHJvbCAtINCw0LzQuCwg0LAg0LzQsNGB0YHQuNCy0YsgLSBGb3JtQXJyYXkgLSDQvNC4Llxu0J/RgNC4INGN0YLQvtC8INGB0L7Qt9C00LDQstCw0LXQvNCw0Y8g0YTQvtGA0LzQsCDQuNC80LXQtdGCINCx0L7Qu9C10LUg0YHRgtGA0L7Qs9GD0Y4g0YLQuNC/0LjQt9Cw0YbQuNGOLlxuXG4gINCS0JDQltCd0J4hXG4gICDQp9GC0L7QsdGLINC40LfQsdC10LbQsNGC0Ywg0L7RiNC40LHQutC4INC/0LXRgNC10L/QvtC70L3QtdC90LjRjyDRgdGC0Y3QutCwINCy0YvQt9C+0LLQvtCyINCyINGA0LXQutGD0YDRgdC40LLQvdC+0Lwg0L/RgNC+0YbQtdGB0YHQtSDRgdC+0LfQtNCw0L3QuNGPINGE0L7RgNC80YssINC00LvRjyDQu9GO0LHRi9GFO1xuT2JzZXJ2YWJsZSAtINC30L3QsNGH0LXQvdC40Lko0LIg0YIu0YcuLCDQuiDQv9GA0LjQvNC10YDRgywgU3ViamVjdCAqINC4IEV2ZW50RW1pdHRlcikg0YHQvtC+0YLQstC10YLRgdGC0LLRg9GO0YnQuNC5INGN0LvQtdC80LXQvdGCINGE0L7RgNC80Ysg0L3QtSDRgdC+0LfQtNCw0LXRgtGB0Y8uXG4gKiBAcGFyYW0gc291cmNlICDQuNGB0YLQvtGH0L3QuNC6INC00LDQvdC90YvRhSDRgtC40L/QsCBUINC00LvRjyDRgdC+0LfQtNCw0L3QuNGPINGE0L7RgNC80YsuXG4gKiBAcGFyYW0ga2V5c1ZhbGlkYXRvciDQvtCx0YrQtdC60YIgTWFwINGBINC60L7QvdGE0LjQs9GD0YDQsNGG0LjQtdC5INGB0LjQvdGF0YDQvtC90L3Ri9GFINCy0LDQu9C40LTQsNGC0L7RgNC+0LIg0LrQvtC90YLRgNC+0LvQvtCyINGE0L7RgNC80YsuXG4gKiDQkiDQutCw0YfQtdGB0YLQstC1INC60LvRjtGH0LXQuSDQvNC+0LPRg9GCINCx0YvRgtGMINGD0LrQsNC30LDQvdGLINGB0LvQtdC00YPRjtGJ0LjQtSDQt9C90LDRh9C10L3QuNGPOlxuICogIFByb3BlcnR5ZXNLZXlzPFQ+IC0g0YHRgtGA0L7QutC+0LLRi9C1INC60LvRjtGH0Lgg0LIg0YLQuNC/0LUgVCwg0LLQutC70Y7Rh9Cw0Y8g0YHRgtGA0L7QutC+0LLRi9C1INC60LvRjtGH0Lgg0LLRgdC10YUg0LLQu9C+0LbQtdC90L3Ri9GFINGC0LjQv9C+0LIsINGA0LDQt9C00LXQu9C10L3QvdGL0LUgXCIuXCIgLSDRgtC+0YfQutC+0LkuXG4gICAg0J3QsNC/0YDQuNC80LXRgCDQuNC80LXQtdGC0YHRjyDRgtCw0LrQvtC5INGC0LjQvzpcbiAgICBgYGB0c1xuICAgICAgICAgICAgICAgICAgICBpbnRlcmZhY2UgVXNlciB7XG4gICAgICAgICAgICAgICAgICAgICAgZmlyc3RuYW1lOiBzdHJpbmc7XG4gICAgICAgICAgICAgICAgICAgICAgbGFzdG5hbWU6IHN0cmluZztcbiAgICAgICAgICAgICAgICAgICAgICBwaG9uZTogIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvZGU6IHN0cmluZztcbiAgICAgICAgICAgICAgICAgICAgICAgIG51bWJlcjogc3RyaW5nO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgYGBgXG4gICAg0JTQu9GPINGE0L7RgNC80YssINC60L7RgtC+0YDQsNGPINCx0YPQtNC10YIg0YHQvtC30LTQsNC90LAg0LjQtyDQvtCx0YrQtdC60YLQsCBVc2VyINCyINC60L7QvdGE0LjQs9GD0YDQsNGG0LjQuCDQstCw0LvQuNC00LDRgtC+0YDQvtCyINC90LDQt9Cy0LDQvdC40Y8g0LrQvtC90YLRgNC+0LvQvtCyINC80L7QttC90L4g0LHRg9C00LXRgiDRg9C60LDQt9Cw0YLRjCDRgtCw0Lo6XG4gICAgYGxhc3RuYW1lYCDQuNC70LhgcGhvbmVgLCDQuNC70LhgcGhvbmUuY29kZWAuXG5cbiAgICdtYWluJyAtINGB0L/QtdGG0LjQsNC70YzQvdC+0LUg0LfQvdCw0YfQtdC90LjQtSwg0Y/QstC70Y/RjtGJ0LXQtdGB0Y8g0L/RgNC40LfQvdCw0LrQvtC8INGC0L7Qs9C+LCDRh9GC0L4g0LzQsNGB0YHQuNCyINCy0LDQu9C40LTQsNGC0L7RgNC+0LIg0L3QtdC+0LHRhdC+0LTQuNC80L5cbiAgICDQvdCw0LfQvdCw0YfQuNGC0Ywg0YHQsNC80L7QvNGDINC+0LHRitC10LrRgtGDINGE0L7RgNC80YssINCwINC90LUg0LLQu9C+0LbQtdC90YvQvCDQutC+0L3RgtGA0L7Qu9Cw0LwuXG5cbiAgICdtYWluSXRlbXMnIC0g0LjRgdC/0L7Qu9GM0LfRg9C10YLRgdGPINGC0L7Qu9GM0LrQviDQtdGB0LvQuCBzb3VyY2Ug0Y/QstC70Y/QtdGC0YHRjyDQvNCw0YHRgdC40LLQvtC8LiDQodC/0LXRhtC40LDQu9GM0L3QvtC1INC30L3QsNGH0LXQvdC40LUsINGP0LLQu9GP0Y7RidC10LXRgdGPINC/0YDQuNC30L3QsNC60L7QvCDRgtC+0LPQvixcbiAg0YfRgtC+INC80LDRgdGB0LjQsiDQstCw0LvQuNC00LDRgtC+0YDQvtCyINC90LXQvtCx0YXQvtC00LjQvNC+INC90LDQt9C90LDRh9C40YLRjCDQtNC70Y8g0LLRgdC10YUg0Y3Qu9C10LzQtdC90YLQvtCyINC80LDRgdGB0LjQstCwIEZvcm1BcnJheS5cbiAqIEBwYXJhbSBhc3luY0tleXNWYWxpZGF0b3Ig0L7QsdGK0LXQutGCIE1hcCwg0LDQvdCw0LvQvtCz0LjRh9C90YvQuSBrZXlzVmFsaWRhdG9yLCDQvdC+INC00LvRjyDQsNGB0LjQvdGF0YDQvtC90L3Ri9GFINCy0LDQu9C40LTQsNGC0L7RgNC+0LJcbiAqIEByZXR1cm5zINC+0LHRitC10LrRgiDRgtC40L/QuNC30LjRgNC+0LLQsNC90L3QvtC5INGE0L7RgNC80YsgLSBGb3JtR3JvdXAsIEZvcm1BcnJheSDQuNC70LggRm9ybUNvbnRyb2wg0LIg0LfQsNCy0LjRgdC40LzQvtGB0YLQuCDQvtGCINGC0LjQv9CwINC30L3QsNGH0LXQvdC40Y8gc291cmNlLlxuICovXG5leHBvcnQgZnVuY3Rpb24gbWFrZUZvcm08VD4oXG4gIHNvdXJjZTogVCxcbiAga2V5c1ZhbGlkYXRvcj86IE1hcDxDb250cm9sc05hbWVzPFQ+LCBWYWxpZGF0b3JGbltdIHwgbnVsbD4sXG4gIGFzeW5jS2V5c1ZhbGlkYXRvcj86IE1hcDxDb250cm9sc05hbWVzPFQ+LCBBc3luY1ZhbGlkYXRvckZuW10gfCBudWxsPixcbik6IFNjYW5Gb3JtVHlwZTxUPiB7XG4gIGNvbnN0IGZvcm0gPSAhIXNvdXJjZSAmJiAodHlwZW9mIHNvdXJjZSA9PT0gJ29iamVjdCcgfHwgdHlwZW9mIHNvdXJjZSA9PT0gJ2Z1bmN0aW9uJykgP1xuICAgIHNvdXJjZSBpbnN0YW5jZW9mIEFycmF5PHVua25vd24+ID9cbiAgICAgIG5ldyBGb3JtQXJyYXkoXG4gICAgICAgIHNvdXJjZS5tYXAoXG4gICAgICAgICAgKGl0ZW06IHVua25vd24pID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGl0ZW1Gb3JtID0gbWFrZUZvcm0oXG4gICAgICAgICAgICAgIGl0ZW0sXG4gICAgICAgICAgICAgIDxNYXA8Q29udHJvbHNOYW1lczx1bmtub3duPiwgVmFsaWRhdG9yRm5bXSB8IG51bGw+PiBtYWtlTmV3bWFpbk1hcCgnbWFpbkl0ZW1zJywga2V5c1ZhbGlkYXRvciksXG4gICAgICAgICAgICAgIDxNYXA8Q29udHJvbHNOYW1lczx1bmtub3duPiwgQXN5bmNWYWxpZGF0b3JGbltdIHwgbnVsbD4+IG1ha2VOZXdtYWluTWFwKCdtYWluSXRlbXMnLCBhc3luY0tleXNWYWxpZGF0b3IpXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgcmV0dXJuIGl0ZW1Gb3JtO1xuICAgICAgICAgIH0pLFxuICAgICAgICBnZXRWYWxpZGF0b3JzT3JOdWxsKCdtYWluJywga2V5c1ZhbGlkYXRvciwgdHJ1ZSksXG4gICAgICAgIGdldFZhbGlkYXRvcnNPck51bGwoJ21haW4nLCBhc3luY0tleXNWYWxpZGF0b3IsIGZhbHNlKVxuICAgICAgKSA6XG4gICAgICBtYWtlRm9ybUdyb3VwPFQ+KHNvdXJjZSwgJ21haW4nLCBrZXlzVmFsaWRhdG9yLCBhc3luY0tleXNWYWxpZGF0b3IpIDpcbiAgICBuZXcgRm9ybUNvbnRyb2w8VCB8IG51bGw+KFxuICAgICAgISFzb3VyY2UgJiYgdHlwZW9mIHNvdXJjZSA9PSAnc3RyaW5nJyAmJiAoc291cmNlLmluY2x1ZGVzKCcwMDAxLTAxLTAxJykgfHwgc291cmNlLmluY2x1ZGVzKCcxOTcwLTAxLTAxJykpID8gbnVsbCA6IHNvdXJjZVxuICAgICAgLFxuICAgICAgZ2V0VmFsaWRhdG9yc09yTnVsbCgnbWFpbicsIGtleXNWYWxpZGF0b3IsIGZhbHNlKSxcbiAgICAgIGdldFZhbGlkYXRvcnNPck51bGwoJ21haW4nLCBhc3luY0tleXNWYWxpZGF0b3IsIGZhbHNlKVxuICAgICk7XG4gIHJldHVybiA8U2NhbkZvcm1UeXBlPFQ+PiBmb3JtO1xufTtcblxuZnVuY3Rpb24gbGlmdEVycm9ycyhjb250cm9sOiBBYnN0cmFjdENvbnRyb2wpOiBWYWxpZGF0aW9uRXJyb3JzIHwgbnVsbCB7XG4gIGlmIChjb250cm9sIGluc3RhbmNlb2YgRm9ybUNvbnRyb2wpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfSBlbHNlIHtcbiAgICBjb25zdCBhbGxDb250cm9scyA9IGNvbnRyb2wgaW5zdGFuY2VvZiBGb3JtR3JvdXAgP1xuICAgICAgT2JqZWN0LnZhbHVlcyhjb250cm9sLmNvbnRyb2xzKSA6XG4gICAgICBjb250cm9sIGluc3RhbmNlb2YgRm9ybUFycmF5ID9cbiAgICAgICAgY29udHJvbC5jb250cm9scyA6XG4gICAgICAgIFtdO1xuICAgIGNvbnN0IGludmFsaWRDb250cm9scyA9IGFsbENvbnRyb2xzLmZpbHRlcihjb250cm9sID0+IGNvbnRyb2wuc3RhdHVzID09PSAnSU5WQUxJRCcpO1xuICAgIHJldHVybiBpbnZhbGlkQ29udHJvbHMubGVuZ3RoID09PSAwID8gbnVsbCA6IGludmFsaWRDb250cm9scy5yZWR1Y2UoXG4gICAgICAoYWNjdW11bGF0b3IsIGN1cnJlbnQpID0+IHtcbiAgICAgICAgaWYgKGN1cnJlbnQuZXJyb3JzKSB7XG4gICAgICAgICAgYWRkVmFsaWRhdGlvbkVycm9ycyhjdXJyZW50LmVycm9ycywgYWNjdW11bGF0b3IpO1xuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gYWNjdW11bGF0b3I7XG4gICAgICB9LCA8VmFsaWRhdGlvbkVycm9ycz4ge31cbiAgICApO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBsaWZ0VmFsaWRhdGlvbkVycm9ycyhjb250cm9sOiBBYnN0cmFjdENvbnRyb2wpOiBWYWxpZGF0aW9uRXJyb3JzIHwgbnVsbCB7XG4gIGNvbnN0IGFsbENvbnRyb2xzID0gY29udHJvbCBpbnN0YW5jZW9mIEZvcm1Hcm91cCA/XG4gICAgT2JqZWN0LnZhbHVlcyhjb250cm9sLmNvbnRyb2xzKSA6XG4gICAgY29udHJvbCBpbnN0YW5jZW9mIEZvcm1BcnJheSA/XG4gICAgICBjb250cm9sLmNvbnRyb2xzIDpcbiAgICAgIFtdO1xuICBjb25zdCBpbnZhbGlkQ29udHJvbHMgPSBhbGxDb250cm9scy5maWx0ZXIoY29udHJvbCA9PiBjb250cm9sLnN0YXR1cyA9PT0gJ0lOVkFMSUQnKTtcbiAgY29uc3QgZXJyb3JzOiBWYWxpZGF0aW9uRXJyb3JzID0gaW52YWxpZENvbnRyb2xzLmxlbmd0aCA9PT0gMCA/IHt9IDogaW52YWxpZENvbnRyb2xzLnJlZHVjZShcbiAgICAoYWNjdW11bGF0b3IsIGN1cnJlbnQpID0+IHtcbiAgICAgIGlmIChjdXJyZW50LmVycm9ycykge1xuICAgICAgICBhZGRWYWxpZGF0aW9uRXJyb3JzKGN1cnJlbnQuZXJyb3JzLCBhY2N1bXVsYXRvcik7XG4gICAgICB9O1xuICAgICAgY29uc3QgaW5uZXJFcnJvcnMgPSBsaWZ0VmFsaWRhdGlvbkVycm9ycyhjdXJyZW50KTtcbiAgICAgIGlmIChpbm5lckVycm9ycykge1xuICAgICAgICBhZGRWYWxpZGF0aW9uRXJyb3JzKGlubmVyRXJyb3JzLCBhY2N1bXVsYXRvcik7XG4gICAgICB9O1xuICAgICAgcmV0dXJuIGFjY3VtdWxhdG9yO1xuICAgIH0sIDxWYWxpZGF0aW9uRXJyb3JzPiB7fVxuICApO1xuICByZXR1cm4gT2JqZWN0LnZhbHVlcyhlcnJvcnMpLmxlbmd0aCA9PT0gMCA/IG51bGwgOiBlcnJvcnM7XG59O1xuXG5mdW5jdGlvbiBhZGRWYWxpZGF0aW9uRXJyb3JzKGFkZGl0aW9uRXJyb3JzOiBWYWxpZGF0aW9uRXJyb3JzLCBjdXJyZW50RXJyb3JzOiBWYWxpZGF0aW9uRXJyb3JzKSB7XG4gIE9iamVjdC5lbnRyaWVzKGFkZGl0aW9uRXJyb3JzKS5mb3JFYWNoKFxuICAgIGVudHJ5ID0+IGN1cnJlbnRFcnJvcnNbIGVudHJ5WyAwIF0gXSA9IGVudHJ5WyAxIF1cbiAgKTtcbn0iXX0=