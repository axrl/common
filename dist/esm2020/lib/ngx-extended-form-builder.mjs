import { FormGroup, FormArray, FormControl } from "@angular/forms";
import { Observable } from "rxjs";
function getValidatorsOrNull(key, keysValidator, addLift = false) {
    const result = keysValidator && keysValidator.has(key) ? keysValidator.get(key) : null;
    if (addLift) {
        if (result && Array.isArray(result)) {
            result.push(liftErrors);
            return result;
        }
        else {
            return result ? result : [liftErrors];
        }
    }
    else {
        return result;
    }
    ;
}
function makeFormGroup(source, internalKey, keysValidator, asyncKeysValidator) {
    return source instanceof (FormGroup) ?
        source :
        Object.entries(source).reduce((accumulator, entry) => {
            const key = entry[0];
            const value = entry[1];
            if (!(value instanceof Observable)) {
                accumulator.addControl(key, !!value && (value instanceof FormGroup || value instanceof FormArray || value instanceof (FormControl)) ?
                    value :
                    makeForm(value, makeNewMainFormValidatorsMap(key, keysValidator), makeNewMainFormValidatorsMap(key, asyncKeysValidator)));
            }
            ;
            return accumulator;
        }, new FormGroup({}, getValidatorsOrNull(internalKey, keysValidator, true), getValidatorsOrNull(internalKey, asyncKeysValidator, false)));
}
function makeNewMainFormValidatorsMap(key, oldMap) {
    if (!oldMap || key === 'mainFormValidators' || key === 'mainFormValidatorsItems') {
        return oldMap;
    }
    else {
        if (!oldMap.has(key) && !oldMap.has(`${key}Items`)) {
            return new Map(Array.from(oldMap.entries()).filter(item => item[0] !== 'mainFormValidators' && item[0] !== 'mainFormValidatorsItems').map(([entryKey, entryValue]) => [entryKey.startsWith(`${key}.`) ? entryKey.replace(`${key}.`, '') : entryKey, entryValue]));
        }
        else {
            const filterPredicate = oldMap.has('mainFormValidators') ?
                oldMap.has('mainFormValidatorsItems') ?
                    (item) => item[0] !== key && item[0] !== 'mainFormValidators' && item[0] !== 'mainFormValidatorsItems' :
                    (item) => item[0] !== key && item[0] !== 'mainFormValidators' :
                oldMap.has('mainFormValidatorsItems') ?
                    (item) => item[0] !== key && item[0] !== 'mainFormValidatorsItems' :
                    (item) => item[0] !== key;
            const newMainValidatorsArray = oldMap.has(key) ?
                oldMap.has(`${key}Items`) ?
                    [
                        ['mainFormValidators', oldMap.get(key)],
                        ['mainFormValidatorsItems', oldMap.get(`${key}Items`)]
                    ] :
                    [
                        ['mainFormValidators', oldMap.get(key)],
                    ] :
                oldMap.has(`${key}Items`) ?
                    [
                        ['mainFormValidatorsItems', oldMap.get(`${key}Items`)]
                    ] :
                    [];
            return new Map([
                ...newMainValidatorsArray,
                ...Array.from(oldMap.entries()).filter(filterPredicate).map(([entryKey, entryValue]) => [entryKey.startsWith(`${key}.`) ? entryKey.replace(`${key}.`, '') : entryKey, entryValue])
            ]);
        }
        ;
    }
    ;
}
export function makeForm(source, keysValidator, asyncKeysValidator) {
    const form = !!source && (typeof source === 'object' || typeof source === 'function') ?
        source instanceof (Array) ?
            new FormArray(source.map((item) => {
                const itemForm = makeForm(item, makeNewMainFormValidatorsMap('mainFormValidatorsItems', keysValidator), makeNewMainFormValidatorsMap('mainFormValidatorsItems', asyncKeysValidator));
                return itemForm;
            }), getValidatorsOrNull('mainFormValidators', keysValidator, true), getValidatorsOrNull('mainFormValidators', asyncKeysValidator, false)) :
            makeFormGroup(source, 'mainFormValidators', keysValidator, asyncKeysValidator) :
        new FormControl(!!source && typeof source == 'string' && (source.includes('0001-01-01') || source.includes('1970-01-01')) ? null : source, getValidatorsOrNull('mainFormValidators', keysValidator, false), getValidatorsOrNull('mainFormValidators', asyncKeysValidator, false));
    return form;
}
;
function liftErrors(control) {
    if (control instanceof FormControl) {
        return null;
    }
    else {
        const allControls = control instanceof FormGroup ?
            Object.values(control.controls) :
            control instanceof FormArray ?
                control.controls :
                [];
        const invalidControls = allControls.filter(control => control.status === 'INVALID');
        return invalidControls.length === 0 ? null : invalidControls.reduce((accumulator, current) => {
            if (current.errors) {
                addValidationErrors(current.errors, accumulator);
            }
            ;
            return accumulator;
        }, {});
    }
}
export function liftValidationErrors(control) {
    const allControls = control instanceof FormGroup ?
        Object.values(control.controls) :
        control instanceof FormArray ?
            control.controls :
            [];
    const invalidControls = allControls.filter(control => control.status === 'INVALID');
    const errors = invalidControls.length === 0 ? {} : invalidControls.reduce((accumulator, current) => {
        if (current.errors) {
            addValidationErrors(current.errors, accumulator);
        }
        ;
        const innerErrors = liftValidationErrors(current);
        if (innerErrors) {
            addValidationErrors(innerErrors, accumulator);
        }
        ;
        return accumulator;
    }, {});
    return Object.values(errors).length === 0 ? null : errors;
}
;
function addValidationErrors(additionErrors, currentErrors) {
    Object.entries(additionErrors).forEach(entry => currentErrors[entry[0]] = entry[1]);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LWV4dGVuZGVkLWZvcm0tYnVpbGRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3Byb2plY3RzL25neC1leHRlbmRlZC1mb3JtLWJ1aWxkZXIvc3JjL2xpYi9uZ3gtZXh0ZW5kZWQtZm9ybS1idWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRW5FLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUF1Q2xDLFNBQVMsbUJBQW1CLENBQzFCLEdBQVcsRUFBRSxhQUE4QixFQUFFLFVBQW1CLEtBQUs7SUFFckUsTUFBTSxNQUFNLEdBQUcsYUFBYSxJQUFJLGFBQWEsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUN2RixJQUFJLE9BQU8sRUFBRTtRQUNYLElBQUksTUFBTSxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDbEIsTUFBTyxDQUFDLElBQUksQ0FBZSxVQUFVLENBQUMsQ0FBQztZQUN4RCxPQUFXLE1BQU0sQ0FBQztTQUNuQjthQUFNO1lBQ0wsT0FBTyxNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUksQ0FBRSxVQUFVLENBQUUsQ0FBQztTQUM1QztLQUNGO1NBQU07UUFDTCxPQUFPLE1BQU0sQ0FBQztLQUNmO0lBQUEsQ0FBQztBQUNKLENBQUM7QUFFRCxTQUFTLGFBQWEsQ0FDcEIsTUFBUyxFQUNULFdBQW1CLEVBQ25CLGFBQTJELEVBQzNELGtCQUFxRTtJQUVyRSxPQUFPLE1BQU0sYUFBWSxTQUFzRCxDQUFBLENBQUMsQ0FBQztRQUMvRSxNQUFNLENBQUMsQ0FBQztRQUNrRCxNQUFNLENBQUMsT0FB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QyxhQUFhLENBQUUsS0FBSyxDQUFFLENBQUMsQ0FBRSxDQUFFLEdBQUcsS0FBSyxDQUFFLENBQUMsQ0FBRSxDQUNsRCxDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEZvcm1Hcm91cCwgRm9ybUFycmF5LCBGb3JtQ29udHJvbCB9IGZyb20gXCJAYW5ndWxhci9mb3Jtc1wiO1xuaW1wb3J0IHR5cGUgeyBWYWxpZGF0b3JGbiwgVmFsaWRhdGlvbkVycm9ycywgQXN5bmNWYWxpZGF0b3JGbiwgQWJzdHJhY3RDb250cm9sIH0gZnJvbSBcIkBhbmd1bGFyL2Zvcm1zXCI7XG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSBcInJ4anNcIjtcblxuZXhwb3J0IHR5cGUgQ29udHJvbHNOYW1lczxUPiA9ICdtYWluRm9ybVZhbGlkYXRvcnMnIHwgJ21haW5Gb3JtVmFsaWRhdG9yc0l0ZW1zJyB8IFByb3BlcnR5ZXNLZXlzPFQ+O1xuXG50eXBlIFByb3BlcnR5ZXNLZXlzPFQ+ID0gVCBleHRlbmRzIHVuZGVmaW5lZCB8IG51bGwgfCBudW1iZXIgfCBib29sZWFuIHwgc3ltYm9sID9cbiAgbmV2ZXIgOlxuICBUIGV4dGVuZHMgc3RyaW5nID9cbiAgVCA6ICB7XG4gICAgWyBLIGluIGtleW9mIFQgXS0/OiBLIGV4dGVuZHMgc3RyaW5nID9cbiAgICBUWyBLIF0gZXh0ZW5kcyAoc3RyaW5nIHwgbnVtYmVyIHwgYm9vbGVhbiB8IHN5bWJvbCkgP1xuICAgIEsgOlxuICAgIFRbIEsgXSBleHRlbmRzIHVuZGVmaW5lZCB8IG51bGwgP1xuICAgIEsgOlxuICAgIFRbIEsgXSBleHRlbmRzIE9ic2VydmFibGU8YW55PiA/XG4gICAgbmV2ZXIgOlxuICAgIFRbIEsgXSBleHRlbmRzIEFycmF5PGluZmVyIFU+ID9cbiAgICBLIHwgYCR7IEsgfUl0ZW1zYCB8IGAkeyBLIH0uJHsgUHJvcGVydHllc0tleXM8VT4gfWAgOlxuICAgIEsgfCBgJHsgSyB9LiR7IFByb3BlcnR5ZXNLZXlzPFRbIEsgXT4gfWAgOlxuICAgIG5ldmVyXG4gIH1bIGtleW9mIFQgXTtcblxudHlwZSBBcnJheUVsZW1lbnQ8VD4gPSBUIGV4dGVuZHMgQXJyYXk8aW5mZXIgVT4gPyBVIDogbmV2ZXI7XG5leHBvcnQgdHlwZSBGb3JtR3JvdXBUeXBlPFQ+ID0gRm9ybUdyb3VwPHsgWyBLIGluIChrZXlvZiBUICYgc3RyaW5nKSBdOiBTY2FuRm9ybVR5cGU8VFsgSyBdPjsgfT47XG5cbmV4cG9ydCB0eXBlIFNjYW5Gb3JtVHlwZTxUPiA9IFQgZXh0ZW5kcyBGb3JtR3JvdXA8aW5mZXIgVT4gP1xuICBGb3JtR3JvdXA8VT4gOlxuICBUIGV4dGVuZHMgRm9ybUFycmF5PGluZmVyIFU+ID9cbiAgRm9ybUFycmF5PFU+IDpcbiAgVCBleHRlbmRzIEZvcm1Db250cm9sPGluZmVyIFU+ID9cbiAgRm9ybUNvbnRyb2w8VT4gOlxuICBUIGV4dGVuZHMgQXJyYXk8aW5mZXIgVT4gP1xuICBGb3JtQXJyYXk8U2NhbkZvcm1UeXBlPFU+PiA6XG4gIFQgZXh0ZW5kcyBudWxsIHwgdW5kZWZpbmVkID9cbiAgbmV2ZXIgOlxuICBUIGV4dGVuZHMgKHN0cmluZyB8IG51bWJlciB8IGJvb2xlYW4gfCBzeW1ib2wgfCBudWxsIHwgdW5kZWZpbmVkKSA/IEZvcm1Db250cm9sPFQgfCBudWxsPiA6XG4gIEZvcm1Hcm91cFR5cGU8VD47XG5cbnR5cGUgSW5uZXJUeXBlPFQsIEsgZXh0ZW5kcyBrZXlvZiBUPiA9IFRbIEsgXTtcblxuZnVuY3Rpb24gZ2V0VmFsaWRhdG9yc09yTnVsbDxUIGV4dGVuZHMgVmFsaWRhdG9yRm5bXSB8IEFzeW5jVmFsaWRhdG9yRm5bXSB8IG51bGw+KFxuICBrZXk6IHN0cmluZywga2V5c1ZhbGlkYXRvcj86IE1hcDxzdHJpbmcsIFQ+LCBhZGRMaWZ0OiBib29sZWFuID0gZmFsc2Vcbik6IFQgfCB1bmRlZmluZWQgfCBudWxsIHtcbiAgY29uc3QgcmVzdWx0ID0ga2V5c1ZhbGlkYXRvciAmJiBrZXlzVmFsaWRhdG9yLmhhcyhrZXkpID8ga2V5c1ZhbGlkYXRvci5nZXQoa2V5KSA6IG51bGw7XG4gIGlmIChhZGRMaWZ0KSB7XG4gICAgaWYgKHJlc3VsdCAmJiBBcnJheS5pc0FycmF5KHJlc3VsdCkpIHtcbiAgICAgICg8VmFsaWRhdG9yRm5bXT4gcmVzdWx0KS5wdXNoKDxWYWxpZGF0b3JGbj4gbGlmdEVycm9ycyk7XG4gICAgICByZXR1cm4gPFQ+IHJlc3VsdDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHJlc3VsdCA/IHJlc3VsdCA6IDxUPlsgbGlmdEVycm9ycyBdO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9O1xufVxuXG5mdW5jdGlvbiBtYWtlRm9ybUdyb3VwPFQ+KFxuICBzb3VyY2U6IFQsXG4gIGludGVybmFsS2V5OiBzdHJpbmcsXG4gIGtleXNWYWxpZGF0b3I/OiBNYXA8Q29udHJvbHNOYW1lczxUPiwgVmFsaWRhdG9yRm5bXSB8IG51bGw+LFxuICBhc3luY0tleXNWYWxpZGF0b3I/OiBNYXA8Q29udHJvbHNOYW1lczxUPiwgQXN5bmNWYWxpZGF0b3JGbltdIHwgbnVsbD5cbik6IEZvcm1Hcm91cFR5cGU8VD4ge1xuICByZXR1cm4gc291cmNlIGluc3RhbmNlb2YgRm9ybUdyb3VwPHsgWyBLIGluIGtleW9mIFQgXTogU2NhbkZvcm1UeXBlPFRbIEsgXT47IH0+ID9cbiAgICBzb3VyY2UgOlxuICAgICg8WyBzdHJpbmcgJiBrZXlvZiBULCBJbm5lclR5cGU8VCwgc3RyaW5nICYga2V5b2YgVD4gXVtdPiBPYmplY3QuZW50cmllcyhzb3VyY2UpKS5yZWR1Y2UoXG4gICAgICAoYWNjdW11bGF0b3I6IEZvcm1Hcm91cCwgZW50cnk6IFsgc3RyaW5nICYga2V5b2YgVCwgSW5uZXJUeXBlPFQsIHN0cmluZyAmIGtleW9mIFQ+IF0pID0+IHtcbiAgICAgICAgY29uc3Qga2V5ID0gZW50cnlbIDAgXTtcbiAgICAgICAgY29uc3QgdmFsdWUgPSBlbnRyeVsgMSBdO1xuICAgICAgICBpZiAoISh2YWx1ZSBpbnN0YW5jZW9mIE9ic2VydmFibGUpKSB7XG4gICAgICAgICAgYWNjdW11bGF0b3IuYWRkQ29udHJvbChcbiAgICAgICAgICAgIGtleSxcbiAgICAgICAgICAgICEhdmFsdWUgJiYgKFxuICAgICAgICAgICAgICB2YWx1ZSBpbnN0YW5jZW9mIEZvcm1Hcm91cCB8fCB2YWx1ZSBpbnN0YW5jZW9mIEZvcm1BcnJheSB8fCB2YWx1ZSBpbnN0YW5jZW9mIEZvcm1Db250cm9sPElubmVyVHlwZTxULCBzdHJpbmcgJiBrZXlvZiBUPiB8IG51bGw+XG4gICAgICAgICAgICApID9cbiAgICAgICAgICAgICAgPFNjYW5Gb3JtVHlwZTxJbm5lclR5cGU8VCwgc3RyaW5nICYga2V5b2YgVD4+PiA8dW5rbm93bj4gdmFsdWUgOlxuICAgICAgICAgICAgICBtYWtlRm9ybTxJbm5lclR5cGU8VCwgc3RyaW5nICYga2V5b2YgVD4+KFxuICAgICAgICAgICAgICAgIHZhbHVlLFxuICAgICAgICAgICAgICAgIDxNYXA8Q29udHJvbHNOYW1lczxJbm5lclR5cGU8VCwgc3RyaW5nICYga2V5b2YgVD4+LCBWYWxpZGF0b3JGbltdIHwgbnVsbD4+IG1ha2VOZXdNYWluRm9ybVZhbGlkYXRvcnNNYXA8VmFsaWRhdG9yRm5bXSB8IG51bGwsIFQ+KGtleSwga2V5c1ZhbGlkYXRvciksXG4gICAgICAgICAgICAgICAgPE1hcDxDb250cm9sc05hbWVzPElubmVyVHlwZTxULCBzdHJpbmcgJiBrZXlvZiBUPj4sIEFzeW5jVmFsaWRhdG9yRm5bXSB8IG51bGw+PiBtYWtlTmV3TWFpbkZvcm1WYWxpZGF0b3JzTWFwPEFzeW5jVmFsaWRhdG9yRm5bXSB8IG51bGwsIFQ+KGtleSwgYXN5bmNLZXlzVmFsaWRhdG9yKSxcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICk7XG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiA8Rm9ybUdyb3VwVHlwZTxUPj4gYWNjdW11bGF0b3I7XG4gICAgICB9LCBuZXcgRm9ybUdyb3VwPHsgWyBLIGluIGtleW9mIFQgXTogU2NhbkZvcm1UeXBlPFRbIEsgXT47IH0+KDx7IFsgSyBpbiBrZXlvZiBUIF06IFNjYW5Gb3JtVHlwZTxUWyBLIF0+OyB9PiB7fSxcbiAgICAgICAgZ2V0VmFsaWRhdG9yc09yTnVsbChpbnRlcm5hbEtleSwga2V5c1ZhbGlkYXRvciwgdHJ1ZSksXG4gICAgICAgIGdldFZhbGlkYXRvcnNPck51bGwoaW50ZXJuYWxLZXksIGFzeW5jS2V5c1ZhbGlkYXRvciwgZmFsc2UpXG4gICAgICApXG4gICAgKTtcbn1cblxuZnVuY3Rpb24gbWFrZU5ld01haW5Gb3JtVmFsaWRhdG9yc01hcDxUIGV4dGVuZHMgVmFsaWRhdG9yRm5bXSB8IEFzeW5jVmFsaWRhdG9yRm5bXSB8IG51bGwsIFA+KFxuICBrZXk6IHN0cmluZyAmIGtleW9mIFAsIG9sZE1hcD86IE1hcDxzdHJpbmcsIFQ+LFxuKTogTWFwPHN0cmluZywgVD4gfCB1bmRlZmluZWQge1xuICBpZiAoIW9sZE1hcCB8fCBrZXkgPT09ICdtYWluRm9ybVZhbGlkYXRvcnMnIHx8IGtleSA9PT0gJ21haW5Gb3JtVmFsaWRhdG9yc0l0ZW1zJykge1xuICAgIHJldHVybiBvbGRNYXA7XG4gIH0gZWxzZSB7XG4gICAgaWYgKCFvbGRNYXAuaGFzKGtleSkgJiYgIW9sZE1hcC5oYXMoYCR7IGtleSB9SXRlbXNgKSkge1xuICAgICAgcmV0dXJuIG5ldyBNYXA8c3RyaW5nLCBUPihcbiAgICAgICAgQXJyYXkuZnJvbShcbiAgICAgICAgICBvbGRNYXAuZW50cmllcygpXG4gICAgICAgICkuZmlsdGVyKFxuICAgICAgICAgIGl0ZW0gPT4gaXRlbVsgMCBdICE9PSAnbWFpbkZvcm1WYWxpZGF0b3JzJyAmJiBpdGVtWyAwIF0gIT09ICdtYWluRm9ybVZhbGlkYXRvcnNJdGVtcydcbiAgICAgICAgKS5tYXAoXG4gICAgICAgICAgKFsgZW50cnlLZXksIGVudHJ5VmFsdWUgXSkgPT4gWyBlbnRyeUtleS5zdGFydHNXaXRoKGAkeyBrZXkgfS5gKSA/IGVudHJ5S2V5LnJlcGxhY2UoYCR7IGtleSB9LmAsICcnKSA6IGVudHJ5S2V5LCBlbnRyeVZhbHVlIF1cbiAgICAgICAgKVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgZmlsdGVyUHJlZGljYXRlID0gb2xkTWFwLmhhcygnbWFpbkZvcm1WYWxpZGF0b3JzJykgP1xuICAgICAgICBvbGRNYXAuaGFzKCdtYWluRm9ybVZhbGlkYXRvcnNJdGVtcycpID9cbiAgICAgICAgICAoaXRlbTogWyBzdHJpbmcsIFQgXSkgPT4gaXRlbVsgMCBdICE9PSBrZXkgJiYgaXRlbVsgMCBdICE9PSAnbWFpbkZvcm1WYWxpZGF0b3JzJyAmJiBpdGVtWyAwIF0gIT09ICdtYWluRm9ybVZhbGlkYXRvcnNJdGVtcycgOlxuICAgICAgICAgIChpdGVtOiBbIHN0cmluZywgVCBdKSA9PiBpdGVtWyAwIF0gIT09IGtleSAmJiBpdGVtWyAwIF0gIT09ICdtYWluRm9ybVZhbGlkYXRvcnMnIDpcbiAgICAgICAgb2xkTWFwLmhhcygnbWFpbkZvcm1WYWxpZGF0b3JzSXRlbXMnKSA/XG4gICAgICAgICAgKGl0ZW06IFsgc3RyaW5nLCBUIF0pID0+IGl0ZW1bIDAgXSAhPT0ga2V5ICYmIGl0ZW1bIDAgXSAhPT0gJ21haW5Gb3JtVmFsaWRhdG9yc0l0ZW1zJyA6XG4gICAgICAgICAgKGl0ZW06IFsgc3RyaW5nLCBUIF0pID0+IGl0ZW1bIDAgXSAhPT0ga2V5O1xuICAgICAgY29uc3QgbmV3TWFpblZhbGlkYXRvcnNBcnJheTogWyBzdHJpbmcsIFQgXVtdID0gb2xkTWFwLmhhcyhrZXkpID9cbiAgICAgICAgb2xkTWFwLmhhcyhgJHsga2V5IH1JdGVtc2ApID9cbiAgICAgICAgICBbXG4gICAgICAgICAgICBbICdtYWluRm9ybVZhbGlkYXRvcnMnLCBvbGRNYXAuZ2V0KGtleSkhIF0sXG4gICAgICAgICAgICBbICdtYWluRm9ybVZhbGlkYXRvcnNJdGVtcycsIG9sZE1hcC5nZXQoYCR7IGtleSB9SXRlbXNgKSEgXVxuICAgICAgICAgIF0gOlxuICAgICAgICAgIFtcbiAgICAgICAgICAgIFsgJ21haW5Gb3JtVmFsaWRhdG9ycycsIG9sZE1hcC5nZXQoa2V5KSEgXSxcbiAgICAgICAgICBdIDpcbiAgICAgICAgb2xkTWFwLmhhcyhgJHsga2V5IH1JdGVtc2ApID9cbiAgICAgICAgICBbXG4gICAgICAgICAgICBbICdtYWluRm9ybVZhbGlkYXRvcnNJdGVtcycsIG9sZE1hcC5nZXQoYCR7IGtleSB9SXRlbXNgKSEgXVxuICAgICAgICAgIF0gOlxuICAgICAgICAgIFtdO1xuICAgICAgcmV0dXJuIG5ldyBNYXA8c3RyaW5nLCBUPihbXG4gICAgICAgIC4uLm5ld01haW5WYWxpZGF0b3JzQXJyYXksXG4gICAgICAgIC4uLkFycmF5LmZyb20oXG4gICAgICAgICAgb2xkTWFwLmVudHJpZXMoKVxuICAgICAgICApLmZpbHRlcihmaWx0ZXJQcmVkaWNhdGUpLm1hcDxbIHN0cmluZywgVCBdPihcbiAgICAgICAgICAoWyBlbnRyeUtleSwgZW50cnlWYWx1ZSBdKSA9PiBbIGVudHJ5S2V5LnN0YXJ0c1dpdGgoYCR7IGtleSB9LmApID8gZW50cnlLZXkucmVwbGFjZShgJHsga2V5IH0uYCwgJycpIDogZW50cnlLZXksIGVudHJ5VmFsdWUgXVxuICAgICAgICApXG4gICAgICBdKTtcbiAgICB9O1xuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbWFrZUZvcm08VD4oXG4gIHNvdXJjZTogVCxcbiAga2V5c1ZhbGlkYXRvcj86IE1hcDxDb250cm9sc05hbWVzPFQ+LCBWYWxpZGF0b3JGbltdIHwgbnVsbD4sXG4gIGFzeW5jS2V5c1ZhbGlkYXRvcj86IE1hcDxDb250cm9sc05hbWVzPFQ+LCBBc3luY1ZhbGlkYXRvckZuW10gfCBudWxsPixcbik6IFNjYW5Gb3JtVHlwZTxUPiB7XG4gIGNvbnN0IGZvcm0gPSAhIXNvdXJjZSAmJiAodHlwZW9mIHNvdXJjZSA9PT0gJ29iamVjdCcgfHwgdHlwZW9mIHNvdXJjZSA9PT0gJ2Z1bmN0aW9uJykgP1xuICAgIHNvdXJjZSBpbnN0YW5jZW9mIEFycmF5PEFycmF5RWxlbWVudDxUPj4gP1xuICAgICAgbmV3IEZvcm1BcnJheShcbiAgICAgICAgc291cmNlLm1hcChcbiAgICAgICAgICAoaXRlbTogQXJyYXlFbGVtZW50PFQ+KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBpdGVtRm9ybSA9IG1ha2VGb3JtKFxuICAgICAgICAgICAgICBpdGVtLFxuICAgICAgICAgICAgICA8TWFwPENvbnRyb2xzTmFtZXM8QXJyYXlFbGVtZW50PFQ+PiwgVmFsaWRhdG9yRm5bXSB8IG51bGw+PiBtYWtlTmV3TWFpbkZvcm1WYWxpZGF0b3JzTWFwKCdtYWluRm9ybVZhbGlkYXRvcnNJdGVtcycsIGtleXNWYWxpZGF0b3IpLFxuICAgICAgICAgICAgICA8TWFwPENvbnRyb2xzTmFtZXM8QXJyYXlFbGVtZW50PFQ+PiwgQXN5bmNWYWxpZGF0b3JGbltdIHwgbnVsbD4+IG1ha2VOZXdNYWluRm9ybVZhbGlkYXRvcnNNYXAoJ21haW5Gb3JtVmFsaWRhdG9yc0l0ZW1zJywgYXN5bmNLZXlzVmFsaWRhdG9yKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHJldHVybiBpdGVtRm9ybTtcbiAgICAgICAgICB9KSxcbiAgICAgICAgZ2V0VmFsaWRhdG9yc09yTnVsbCgnbWFpbkZvcm1WYWxpZGF0b3JzJywga2V5c1ZhbGlkYXRvciwgdHJ1ZSksXG4gICAgICAgIGdldFZhbGlkYXRvcnNPck51bGwoJ21haW5Gb3JtVmFsaWRhdG9ycycsIGFzeW5jS2V5c1ZhbGlkYXRvciwgZmFsc2UpXG4gICAgICApIDpcbiAgICAgIG1ha2VGb3JtR3JvdXA8VD4oc291cmNlLCAnbWFpbkZvcm1WYWxpZGF0b3JzJywga2V5c1ZhbGlkYXRvciwgYXN5bmNLZXlzVmFsaWRhdG9yKSA6XG4gICAgbmV3IEZvcm1Db250cm9sPFQgfCBudWxsPihcbiAgICAgICEhc291cmNlICYmIHR5cGVvZiBzb3VyY2UgPT0gJ3N0cmluZycgJiYgKHNvdXJjZS5pbmNsdWRlcygnMDAwMS0wMS0wMScpIHx8IHNvdXJjZS5pbmNsdWRlcygnMTk3MC0wMS0wMScpKSA/IG51bGwgOiBzb3VyY2VcbiAgICAgICxcbiAgICAgIGdldFZhbGlkYXRvcnNPck51bGwoJ21haW5Gb3JtVmFsaWRhdG9ycycsIGtleXNWYWxpZGF0b3IsIGZhbHNlKSxcbiAgICAgIGdldFZhbGlkYXRvcnNPck51bGwoJ21haW5Gb3JtVmFsaWRhdG9ycycsIGFzeW5jS2V5c1ZhbGlkYXRvciwgZmFsc2UpXG4gICAgKTtcbiAgcmV0dXJuIDxTY2FuRm9ybVR5cGU8VD4+IGZvcm07XG59O1xuXG5mdW5jdGlvbiBsaWZ0RXJyb3JzKGNvbnRyb2w6IEFic3RyYWN0Q29udHJvbCk6IFZhbGlkYXRpb25FcnJvcnMgfCBudWxsIHtcbiAgaWYgKGNvbnRyb2wgaW5zdGFuY2VvZiBGb3JtQ29udHJvbCkge1xuICAgIHJldHVybiBudWxsO1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IGFsbENvbnRyb2xzID0gY29udHJvbCBpbnN0YW5jZW9mIEZvcm1Hcm91cCA/XG4gICAgICBPYmplY3QudmFsdWVzKGNvbnRyb2wuY29udHJvbHMpIDpcbiAgICAgIGNvbnRyb2wgaW5zdGFuY2VvZiBGb3JtQXJyYXkgP1xuICAgICAgICBjb250cm9sLmNvbnRyb2xzIDpcbiAgICAgICAgW107XG4gICAgY29uc3QgaW52YWxpZENvbnRyb2xzID0gYWxsQ29udHJvbHMuZmlsdGVyKGNvbnRyb2wgPT4gY29udHJvbC5zdGF0dXMgPT09ICdJTlZBTElEJyk7XG4gICAgcmV0dXJuIGludmFsaWRDb250cm9scy5sZW5ndGggPT09IDAgPyBudWxsIDogaW52YWxpZENvbnRyb2xzLnJlZHVjZShcbiAgICAgIChhY2N1bXVsYXRvciwgY3VycmVudCkgPT4ge1xuICAgICAgICBpZiAoY3VycmVudC5lcnJvcnMpIHtcbiAgICAgICAgICBhZGRWYWxpZGF0aW9uRXJyb3JzKGN1cnJlbnQuZXJyb3JzLCBhY2N1bXVsYXRvcik7XG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBhY2N1bXVsYXRvcjtcbiAgICAgIH0sIDxWYWxpZGF0aW9uRXJyb3JzPiB7fVxuICAgICk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGxpZnRWYWxpZGF0aW9uRXJyb3JzKGNvbnRyb2w6IEFic3RyYWN0Q29udHJvbCk6IFZhbGlkYXRpb25FcnJvcnMgfCBudWxsIHtcbiAgY29uc3QgYWxsQ29udHJvbHMgPSBjb250cm9sIGluc3RhbmNlb2YgRm9ybUdyb3VwID9cbiAgICBPYmplY3QudmFsdWVzKGNvbnRyb2wuY29udHJvbHMpIDpcbiAgICBjb250cm9sIGluc3RhbmNlb2YgRm9ybUFycmF5ID9cbiAgICAgIGNvbnRyb2wuY29udHJvbHMgOlxuICAgICAgW107XG4gIGNvbnN0IGludmFsaWRDb250cm9scyA9IGFsbENvbnRyb2xzLmZpbHRlcihjb250cm9sID0+IGNvbnRyb2wuc3RhdHVzID09PSAnSU5WQUxJRCcpO1xuICBjb25zdCBlcnJvcnM6IFZhbGlkYXRpb25FcnJvcnMgPSBpbnZhbGlkQ29udHJvbHMubGVuZ3RoID09PSAwID8ge30gOiBpbnZhbGlkQ29udHJvbHMucmVkdWNlKFxuICAgIChhY2N1bXVsYXRvciwgY3VycmVudCkgPT4ge1xuICAgICAgaWYgKGN1cnJlbnQuZXJyb3JzKSB7XG4gICAgICAgIGFkZFZhbGlkYXRpb25FcnJvcnMoY3VycmVudC5lcnJvcnMsIGFjY3VtdWxhdG9yKTtcbiAgICAgIH07XG4gICAgICBjb25zdCBpbm5lckVycm9ycyA9IGxpZnRWYWxpZGF0aW9uRXJyb3JzKGN1cnJlbnQpO1xuICAgICAgaWYgKGlubmVyRXJyb3JzKSB7XG4gICAgICAgIGFkZFZhbGlkYXRpb25FcnJvcnMoaW5uZXJFcnJvcnMsIGFjY3VtdWxhdG9yKTtcbiAgICAgIH07XG4gICAgICByZXR1cm4gYWNjdW11bGF0b3I7XG4gICAgfSwgPFZhbGlkYXRpb25FcnJvcnM+IHt9XG4gICk7XG4gIHJldHVybiBPYmplY3QudmFsdWVzKGVycm9ycykubGVuZ3RoID09PSAwID8gbnVsbCA6IGVycm9ycztcbn07XG5cbmZ1bmN0aW9uIGFkZFZhbGlkYXRpb25FcnJvcnMoYWRkaXRpb25FcnJvcnM6IFZhbGlkYXRpb25FcnJvcnMsIGN1cnJlbnRFcnJvcnM6IFZhbGlkYXRpb25FcnJvcnMpIHtcbiAgT2JqZWN0LmVudHJpZXMoYWRkaXRpb25FcnJvcnMpLmZvckVhY2goXG4gICAgZW50cnkgPT4gY3VycmVudEVycm9yc1sgZW50cnlbIDAgXSBdID0gZW50cnlbIDEgXVxuICApO1xufSJdfQ==