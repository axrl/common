import { FormGroup, FormArray, FormControl } from "@angular/forms";
import { Observable } from "rxjs";
;
function getValidatorsOrNull(key, keysValidator, addLift = false) {
    const result = keysValidator && keysValidator.has(key) ? keysValidator.get(key) : null;
    if (addLift) {
        if (result && Array.isArray(result)) {
            result.push(liftErrors);
            return result;
        }
        else {
            return result ? result : [liftErrors];
        }
    }
    else {
        return result;
    }
    ;
}
function makeFormGroup(source, internalKey, keysValidator, asyncKeysValidator) {
    return source instanceof FormGroup ? source : Object.entries(source).reduce((accumulator, entry) => {
        const key = entry[0];
        const value = entry[1];
        if (!(value instanceof Observable)) {
            accumulator.addControl(key, !!value && value instanceof FormControl || value instanceof FormGroup || value instanceof FormArray ?
                value :
                makeForm(value, makeNewMainFormValidatorsMap(key, keysValidator), makeNewMainFormValidatorsMap(key, asyncKeysValidator)));
        }
        ;
        return accumulator;
    }, new FormGroup({}, getValidatorsOrNull(internalKey, keysValidator, true), getValidatorsOrNull(internalKey, asyncKeysValidator, false)));
}
function makeNewMainFormValidatorsMap(key, oldMap) {
    if (!oldMap || key === 'mainFormValidators' || key === 'mainFormValidatorsItems') {
        return oldMap;
    }
    else {
        if (!oldMap.has(key) && !oldMap.has(`${key}Items`)) {
            return new Map(Array.from(oldMap.entries()).filter(item => item[0] !== 'mainFormValidators' && item[0] !== 'mainFormValidatorsItems').map(([entryKey, entryValue]) => [entryKey.startsWith(`${key}.`) ? entryKey.replace(`${key}.`, '') : entryKey, entryValue]));
        }
        else {
            const filterPredicate = oldMap.has('mainFormValidators') ?
                oldMap.has('mainFormValidatorsItems') ?
                    (item) => item[0] !== key && item[0] !== 'mainFormValidators' && item[0] !== 'mainFormValidatorsItems' :
                    (item) => item[0] !== key && item[0] !== 'mainFormValidators' :
                oldMap.has('mainFormValidatorsItems') ?
                    (item) => item[0] !== key && item[0] !== 'mainFormValidatorsItems' :
                    (item) => item[0] !== key;
            const newMainValidatorsArray = oldMap.has(key) ?
                oldMap.has(`${key}Items`) ?
                    [
                        ['mainFormValidators', oldMap.get(key)],
                        ['mainFormValidatorsItems', oldMap.get(`${key}Items`)]
                    ] :
                    [
                        ['mainFormValidators', oldMap.get(key)],
                    ] :
                oldMap.has(`${key}Items`) ?
                    [
                        ['mainFormValidatorsItems', oldMap.get(`${key}Items`)]
                    ] :
                    [];
            return new Map([
                ...newMainValidatorsArray,
                ...Array.from(oldMap.entries()).filter(filterPredicate).map(([entryKey, entryValue]) => [entryKey.startsWith(`${key}.`) ? entryKey.replace(`${key}.`, '') : entryKey, entryValue])
            ]);
        }
        ;
    }
    ;
}
export function makeForm(source, keysValidator, asyncKeysValidator) {
    const form = !!source && (typeof source === 'object' || typeof source === 'function') ?
        source instanceof Array ?
            new FormArray(source.map(item => {
                const itemForm = makeForm(item, makeNewMainFormValidatorsMap('mainFormValidatorsItems', keysValidator), makeNewMainFormValidatorsMap('mainFormValidatorsItems', asyncKeysValidator));
                return itemForm;
            }), getValidatorsOrNull('mainFormValidators', keysValidator, true), getValidatorsOrNull('mainFormValidators', asyncKeysValidator, false)) :
            makeFormGroup(source, 'mainFormValidators', keysValidator, asyncKeysValidator) :
        new FormControl({
            disabled: keysValidator?.has('mainFormValidators') && 'disabled' in (keysValidator.get('mainFormValidators')) ?
                keysValidator.get('mainFormValidators').disabled :
                false,
            value: !!source && typeof source == 'string' && (source.includes('0001-01-01') || source.includes('1970-01-01')) ? null : source
        }, getValidatorsOrNull('mainFormValidators', keysValidator, false), getValidatorsOrNull('mainFormValidators', asyncKeysValidator, false));
    return form;
}
;
function liftErrors(control) {
    if (control instanceof FormControl) {
        return null;
    }
    else {
        const allControls = control instanceof FormGroup ?
            Object.values(control.controls) :
            control instanceof FormArray ?
                control.controls :
                [];
        const invalidControls = allControls.filter(control => control.status === 'INVALID');
        return invalidControls.length === 0 ? null : invalidControls.reduce((accumulator, current) => {
            if (current.errors) {
                addValidationErrors(current.errors, accumulator);
            }
            ;
            return accumulator;
        }, {});
    }
}
export function liftValidationErrors(control) {
    const allControls = control instanceof FormGroup ?
        Object.values(control.controls) :
        control instanceof FormArray ?
            control.controls :
            [];
    const invalidControls = allControls.filter(control => control.status === 'INVALID');
    const errors = invalidControls.length === 0 ? {} : invalidControls.reduce((accumulator, current) => {
        if (current.errors) {
            addValidationErrors(current.errors, accumulator);
        }
        ;
        const innerErrors = liftValidationErrors(current);
        if (innerErrors) {
            addValidationErrors(innerErrors, accumulator);
        }
        ;
        return accumulator;
    }, {});
    return Object.values(errors).length === 0 ? null : errors;
}
;
function addValidationErrors(additionErrors, currentErrors) {
    Object.entries(additionErrors).forEach(entry => currentErrors[entry[0]] = entry[1]);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LWV4dGVuZGVkLWZvcm0tYnVpbGRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3Byb2plY3RzL25neC1leHRlbmRlZC1mb3JtLWJ1aWxkZXIvc3JjL2xpYi9uZ3gtZXh0ZW5kZWQtZm9ybS1idWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRW5FLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFJakMsQ0FBQztBQUVGLFNBQVMsbUJBQW1CLENBQzFCLEdBQVcsRUFBRSxhQUE4QixFQUFFLFVBQW1CLEtBQUs7SUFFckUsTUFBTSxNQUFNLEdBQUcsYUFBYSxJQUFJLGFBQWEsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUN2RixJQUFJLE9BQU8sRUFBRTtRQUNYLElBQUksTUFBTSxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDbkIsTUFBTyxDQUFDLElBQUksQ0FBYyxVQUFVLENBQUMsQ0FBQztZQUN0RCxPQUFVLE1BQU0sQ0FBQztTQUNsQjthQUFNO1lBQ0wsT0FBTyxNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQTtTQUN6QztLQUNGO1NBQU07UUFDTCxPQUFPLE1BQU0sQ0FBQztLQUNmO0lBQUEsQ0FBQztBQUNKLENBQUM7QUFFRCxTQUFTLGFBQWEsQ0FDcEIsTUFBVyxFQUNYLFdBQW1CLEVBQ25CLGFBQTBFLEVBQzFFLGtCQUEyRDtJQUUzRCxPQUFPLE1BQU0sWUFBWSxTQUFTLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLE9B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LENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7QUFDNUQsQ0FBQztBQUFBLENBQUM7QUFFRixTQUFTLG1CQUFtQixDQUFDLGNBQWdDLEVBQUUsYUFBK0I7SUFDNUYsTUFBTSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQyxPQUFPLENBQ3BDLEtBQUssQ0FBQyxFQUFFLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FDNUMsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBGb3JtR3JvdXAsIEZvcm1BcnJheSwgRm9ybUNvbnRyb2wgfSBmcm9tIFwiQGFuZ3VsYXIvZm9ybXNcIjtcbmltcG9ydCB0eXBlIHsgVmFsaWRhdG9yRm4sIFZhbGlkYXRpb25FcnJvcnMsIEFic3RyYWN0Q29udHJvbCwgQXN5bmNWYWxpZGF0b3JGbiwgQWJzdHJhY3RDb250cm9sT3B0aW9ucyB9IGZyb20gXCJAYW5ndWxhci9mb3Jtc1wiO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gXCJyeGpzXCI7XG5cbmludGVyZmFjZSBFeHRlbmRlZENvbnRyb2xPcHRpb25zIGV4dGVuZHMgQWJzdHJhY3RDb250cm9sT3B0aW9ucyB7XG4gIGRpc2FibGVkPzogYm9vbGVhbixcbn07XG5cbmZ1bmN0aW9uIGdldFZhbGlkYXRvcnNPck51bGw8VCBleHRlbmRzIFZhbGlkYXRvckZuW10gfCBBc3luY1ZhbGlkYXRvckZuW10gfCBFeHRlbmRlZENvbnRyb2xPcHRpb25zIHwgbnVsbD4oXG4gIGtleTogc3RyaW5nLCBrZXlzVmFsaWRhdG9yPzogTWFwPHN0cmluZywgVD4sIGFkZExpZnQ6IGJvb2xlYW4gPSBmYWxzZVxuKTogVCB8IHVuZGVmaW5lZCB8IG51bGwge1xuICBjb25zdCByZXN1bHQgPSBrZXlzVmFsaWRhdG9yICYmIGtleXNWYWxpZGF0b3IuaGFzKGtleSkgPyBrZXlzVmFsaWRhdG9yLmdldChrZXkpIDogbnVsbDtcbiAgaWYgKGFkZExpZnQpIHtcbiAgICBpZiAocmVzdWx0ICYmIEFycmF5LmlzQXJyYXkocmVzdWx0KSkge1xuICAgICAgKDxWYWxpZGF0b3JGbltdPnJlc3VsdCkucHVzaCg8VmFsaWRhdG9yRm4+bGlmdEVycm9ycyk7XG4gICAgICByZXR1cm4gPFQ+cmVzdWx0O1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gcmVzdWx0ID8gcmVzdWx0IDogPFQ+W2xpZnRFcnJvcnNdXG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH07XG59XG5cbmZ1bmN0aW9uIG1ha2VGb3JtR3JvdXAoXG4gIHNvdXJjZTogYW55LFxuICBpbnRlcm5hbEtleTogc3RyaW5nLFxuICBrZXlzVmFsaWRhdG9yPzogTWFwPHN0cmluZywgVmFsaWRhdG9yRm5bXSB8IEV4dGVuZGVkQ29udHJvbE9wdGlvbnMgfCBudWxsPixcbiAgYXN5bmNLZXlzVmFsaWRhdG9yPzogTWFwPHN0cmluZywgQXN5bmNWYWxpZGF0b3JGbltdIHwgbnVsbD5cbik6IEZvcm1Hcm91cCB7XG4gIHJldHVybiBzb3VyY2UgaW5zdGFuY2VvZiBGb3JtR3JvdXAgPyBzb3VyY2UgOiBPYmplY3QuZW50cmllcyhzb3VyY2UpLnJlZHVjZShcbiAgICAoYWNjdW11bGF0b3I6IEZvcm1Hcm91cCwgZW50cnk6IFtzdHJpbmcsIHVua25vd25dKSA9PiB7XG4gICAgICBjb25zdCBrZXkgPSBlbnRyeVswXTtcbiAgICAgIGNvbnN0IHZhbHVlID0gZW50cnlbMV07XG4gICAgICBpZiAoISh2YWx1ZSBpbnN0YW5jZW9mIE9ic2VydmFibGUpKSB7XG4gICAgICAgIGFjY3VtdWxhdG9yLmFkZENvbnRyb2woXG4gICAgICAgICAga2V5LFxuICAgICAgICAgICEhdmFsdWUgJiYgdmFsdWUgaW5zdGFuY2VvZiBGb3JtQ29udHJvbCB8fCB2YWx1ZSBpbnN0YW5jZW9mIEZvcm1Hcm91cCB8fCB2YWx1ZSBpbnN0YW5jZW9mIEZvcm1BcnJheSA/XG4gICAgICAgICAgICB2YWx1ZSA6XG4gICAgICAgICAgICBtYWtlRm9ybShcbiAgICAgICAgICAgICAgdmFsdWUsXG4gICAgICAgICAgICAgIG1ha2VOZXdNYWluRm9ybVZhbGlkYXRvcnNNYXAoa2V5LCBrZXlzVmFsaWRhdG9yKSxcbiAgICAgICAgICAgICAgbWFrZU5ld01haW5Gb3JtVmFsaWRhdG9yc01hcChrZXksIGFzeW5jS2V5c1ZhbGlkYXRvciksXG4gICAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgICB9O1xuICAgICAgcmV0dXJuIGFjY3VtdWxhdG9yO1xuICAgIH0sIG5ldyBGb3JtR3JvdXAoe30sXG4gICAgICBnZXRWYWxpZGF0b3JzT3JOdWxsKGludGVybmFsS2V5LCBrZXlzVmFsaWRhdG9yLCB0cnVlKSxcbiAgICAgIGdldFZhbGlkYXRvcnNPck51bGwoaW50ZXJuYWxLZXksIGFzeW5jS2V5c1ZhbGlkYXRvciwgZmFsc2UpXG4gICAgKVxuICApO1xufVxuXG5mdW5jdGlvbiBtYWtlTmV3TWFpbkZvcm1WYWxpZGF0b3JzTWFwPFQgZXh0ZW5kcyBWYWxpZGF0b3JGbltdIHwgQXN5bmNWYWxpZGF0b3JGbltdIHwgRXh0ZW5kZWRDb250cm9sT3B0aW9ucyB8IG51bGw+KFxuICBrZXk6IHN0cmluZywgb2xkTWFwPzogTWFwPHN0cmluZywgVD4sXG4pOiBNYXA8c3RyaW5nLCBUPiB8IHVuZGVmaW5lZCB7XG4gIGlmICghb2xkTWFwIHx8IGtleSA9PT0gJ21haW5Gb3JtVmFsaWRhdG9ycycgfHwga2V5ID09PSAnbWFpbkZvcm1WYWxpZGF0b3JzSXRlbXMnKSB7XG4gICAgcmV0dXJuIG9sZE1hcDtcbiAgfSBlbHNlIHtcbiAgICBpZiAoIW9sZE1hcC5oYXMoa2V5KSAmJiAhb2xkTWFwLmhhcyhgJHtrZXl9SXRlbXNgKSkge1xuICAgICAgcmV0dXJuIG5ldyBNYXA8c3RyaW5nLCBUPihcbiAgICAgICAgQXJyYXkuZnJvbShcbiAgICAgICAgICBvbGRNYXAuZW50cmllcygpXG4gICAgICAgICkuZmlsdGVyKFxuICAgICAgICAgIGl0ZW0gPT4gaXRlbVswXSAhPT0gJ21haW5Gb3JtVmFsaWRhdG9ycycgJiYgaXRlbVswXSAhPT0gJ21haW5Gb3JtVmFsaWRhdG9yc0l0ZW1zJ1xuICAgICAgICApLm1hcChcbiAgICAgICAgICAoW2VudHJ5S2V5LCBlbnRyeVZhbHVlXSkgPT4gW2VudHJ5S2V5LnN0YXJ0c1dpdGgoYCR7a2V5fS5gKSA/IGVudHJ5S2V5LnJlcGxhY2UoYCR7a2V5fS5gLCAnJykgOiBlbnRyeUtleSwgZW50cnlWYWx1ZV1cbiAgICAgICAgKVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgZmlsdGVyUHJlZGljYXRlID0gb2xkTWFwLmhhcygnbWFpbkZvcm1WYWxpZGF0b3JzJykgP1xuICAgICAgICBvbGRNYXAuaGFzKCdtYWluRm9ybVZhbGlkYXRvcnNJdGVtcycpID9cbiAgICAgICAgICAoaXRlbTogW3N0cmluZywgVF0pID0+IGl0ZW1bMF0gIT09IGtleSAmJiBpdGVtWzBdICE9PSAnbWFpbkZvcm1WYWxpZGF0b3JzJyAmJiBpdGVtWzBdICE9PSAnbWFpbkZvcm1WYWxpZGF0b3JzSXRlbXMnIDpcbiAgICAgICAgICAoaXRlbTogW3N0cmluZywgVF0pID0+IGl0ZW1bMF0gIT09IGtleSAmJiBpdGVtWzBdICE9PSAnbWFpbkZvcm1WYWxpZGF0b3JzJyA6XG4gICAgICAgIG9sZE1hcC5oYXMoJ21haW5Gb3JtVmFsaWRhdG9yc0l0ZW1zJykgP1xuICAgICAgICAgIChpdGVtOiBbc3RyaW5nLCBUXSkgPT4gaXRlbVswXSAhPT0ga2V5ICYmIGl0ZW1bMF0gIT09ICdtYWluRm9ybVZhbGlkYXRvcnNJdGVtcycgOlxuICAgICAgICAgIChpdGVtOiBbc3RyaW5nLCBUXSkgPT4gaXRlbVswXSAhPT0ga2V5O1xuICAgICAgY29uc3QgbmV3TWFpblZhbGlkYXRvcnNBcnJheTogW3N0cmluZywgVF1bXSA9IG9sZE1hcC5oYXMoa2V5KSA/XG4gICAgICAgIG9sZE1hcC5oYXMoYCR7a2V5fUl0ZW1zYCkgP1xuICAgICAgICAgIFtcbiAgICAgICAgICAgIFsnbWFpbkZvcm1WYWxpZGF0b3JzJywgb2xkTWFwLmdldChrZXkpIV0sXG4gICAgICAgICAgICBbJ21haW5Gb3JtVmFsaWRhdG9yc0l0ZW1zJywgb2xkTWFwLmdldChgJHtrZXl9SXRlbXNgKSFdXG4gICAgICAgICAgXSA6XG4gICAgICAgICAgW1xuICAgICAgICAgICAgWydtYWluRm9ybVZhbGlkYXRvcnMnLCBvbGRNYXAuZ2V0KGtleSkhXSxcbiAgICAgICAgICBdIDpcbiAgICAgICAgb2xkTWFwLmhhcyhgJHtrZXl9SXRlbXNgKSA/XG4gICAgICAgICAgW1xuICAgICAgICAgICAgWydtYWluRm9ybVZhbGlkYXRvcnNJdGVtcycsIG9sZE1hcC5nZXQoYCR7a2V5fUl0ZW1zYCkhXVxuICAgICAgICAgIF0gOlxuICAgICAgICAgIFtdO1xuICAgICAgcmV0dXJuIG5ldyBNYXA8c3RyaW5nLCBUPihbXG4gICAgICAgIC4uLm5ld01haW5WYWxpZGF0b3JzQXJyYXksXG4gICAgICAgIC4uLkFycmF5LmZyb20oXG4gICAgICAgICAgb2xkTWFwLmVudHJpZXMoKVxuICAgICAgICApLmZpbHRlcihmaWx0ZXJQcmVkaWNhdGUpLm1hcDxbc3RyaW5nLCBUXT4oXG4gICAgICAgICAgKFtlbnRyeUtleSwgZW50cnlWYWx1ZV0pID0+IFtlbnRyeUtleS5zdGFydHNXaXRoKGAke2tleX0uYCkgPyBlbnRyeUtleS5yZXBsYWNlKGAke2tleX0uYCwgJycpIDogZW50cnlLZXksIGVudHJ5VmFsdWVdXG4gICAgICAgIClcbiAgICAgIF0pO1xuICAgIH07XG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtYWtlRm9ybTxULFxuICBSIGV4dGVuZHMgKFQgZXh0ZW5kcyBBcnJheTxhbnk+ID8gRm9ybUFycmF5IDogVCBleHRlbmRzIHN0cmluZyB8IG51bWJlciB8IGJvb2xlYW4gfCBzeW1ib2wgfCBudWxsIHwgdW5kZWZpbmVkID8gRm9ybUNvbnRyb2wgOiBGb3JtR3JvdXBcbiAgKT4oXG4gICAgc291cmNlOiBULFxuICAgIGtleXNWYWxpZGF0b3I/OiBNYXA8c3RyaW5nLCBWYWxpZGF0b3JGbltdIHwgRXh0ZW5kZWRDb250cm9sT3B0aW9ucyB8IG51bGw+LFxuICAgIGFzeW5jS2V5c1ZhbGlkYXRvcj86IE1hcDxzdHJpbmcsIEFzeW5jVmFsaWRhdG9yRm5bXSB8IG51bGw+LFxuKTogUiB7XG4gIGNvbnN0IGZvcm0gPSAhIXNvdXJjZSAmJiAodHlwZW9mIHNvdXJjZSA9PT0gJ29iamVjdCcgfHwgdHlwZW9mIHNvdXJjZSA9PT0gJ2Z1bmN0aW9uJykgP1xuICAgIHNvdXJjZSBpbnN0YW5jZW9mIEFycmF5ID9cbiAgICAgIG5ldyBGb3JtQXJyYXkoXG4gICAgICAgIHNvdXJjZS5tYXAoXG4gICAgICAgICAgaXRlbSA9PiB7XG4gICAgICAgICAgICBjb25zdCBpdGVtRm9ybSA9IG1ha2VGb3JtKFxuICAgICAgICAgICAgICBpdGVtLFxuICAgICAgICAgICAgICBtYWtlTmV3TWFpbkZvcm1WYWxpZGF0b3JzTWFwKCdtYWluRm9ybVZhbGlkYXRvcnNJdGVtcycsIGtleXNWYWxpZGF0b3IpLFxuICAgICAgICAgICAgICBtYWtlTmV3TWFpbkZvcm1WYWxpZGF0b3JzTWFwKCdtYWluRm9ybVZhbGlkYXRvcnNJdGVtcycsIGFzeW5jS2V5c1ZhbGlkYXRvcilcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICByZXR1cm4gaXRlbUZvcm07XG4gICAgICAgICAgfSksXG4gICAgICAgIGdldFZhbGlkYXRvcnNPck51bGwoJ21haW5Gb3JtVmFsaWRhdG9ycycsIGtleXNWYWxpZGF0b3IsIHRydWUpLFxuICAgICAgICBnZXRWYWxpZGF0b3JzT3JOdWxsKCdtYWluRm9ybVZhbGlkYXRvcnMnLCBhc3luY0tleXNWYWxpZGF0b3IsIGZhbHNlKVxuICAgICAgKSA6XG4gICAgICBtYWtlRm9ybUdyb3VwKHNvdXJjZSwgJ21haW5Gb3JtVmFsaWRhdG9ycycsIGtleXNWYWxpZGF0b3IsIGFzeW5jS2V5c1ZhbGlkYXRvcikgOlxuICAgIG5ldyBGb3JtQ29udHJvbCh7XG4gICAgICBkaXNhYmxlZDoga2V5c1ZhbGlkYXRvcj8uaGFzKCdtYWluRm9ybVZhbGlkYXRvcnMnKSAmJiAnZGlzYWJsZWQnIGluIChrZXlzVmFsaWRhdG9yLmdldCgnbWFpbkZvcm1WYWxpZGF0b3JzJykhKSA/XG4gICAgICAgICg8RXh0ZW5kZWRDb250cm9sT3B0aW9ucz5rZXlzVmFsaWRhdG9yLmdldCgnbWFpbkZvcm1WYWxpZGF0b3JzJykpLmRpc2FibGVkIDpcbiAgICAgICAgZmFsc2UsXG4gICAgICB2YWx1ZTogISFzb3VyY2UgJiYgdHlwZW9mIHNvdXJjZSA9PSAnc3RyaW5nJyAmJiAoc291cmNlLmluY2x1ZGVzKCcwMDAxLTAxLTAxJykgfHwgc291cmNlLmluY2x1ZGVzKCcxOTcwLTAxLTAxJykpID8gbnVsbCA6IHNvdXJjZVxuICAgIH0sXG4gICAgICBnZXRWYWxpZGF0b3JzT3JOdWxsKCdtYWluRm9ybVZhbGlkYXRvcnMnLCBrZXlzVmFsaWRhdG9yLCBmYWxzZSksXG4gICAgICBnZXRWYWxpZGF0b3JzT3JOdWxsKCdtYWluRm9ybVZhbGlkYXRvcnMnLCBhc3luY0tleXNWYWxpZGF0b3IsIGZhbHNlKVxuICAgICk7XG4gIHJldHVybiA8Uj5mb3JtO1xufTtcblxuZnVuY3Rpb24gbGlmdEVycm9ycyhjb250cm9sOiBBYnN0cmFjdENvbnRyb2wpOiBWYWxpZGF0aW9uRXJyb3JzIHwgbnVsbCB7XG4gIGlmIChjb250cm9sIGluc3RhbmNlb2YgRm9ybUNvbnRyb2wpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfSBlbHNlIHtcbiAgICBjb25zdCBhbGxDb250cm9scyA9IGNvbnRyb2wgaW5zdGFuY2VvZiBGb3JtR3JvdXAgP1xuICAgICAgT2JqZWN0LnZhbHVlcyhjb250cm9sLmNvbnRyb2xzKSA6XG4gICAgICBjb250cm9sIGluc3RhbmNlb2YgRm9ybUFycmF5ID9cbiAgICAgICAgY29udHJvbC5jb250cm9scyA6XG4gICAgICAgIFtdO1xuICAgIGNvbnN0IGludmFsaWRDb250cm9scyA9IGFsbENvbnRyb2xzLmZpbHRlcihjb250cm9sID0+IGNvbnRyb2wuc3RhdHVzID09PSAnSU5WQUxJRCcpO1xuICAgIHJldHVybiBpbnZhbGlkQ29udHJvbHMubGVuZ3RoID09PSAwID8gbnVsbCA6IGludmFsaWRDb250cm9scy5yZWR1Y2UoXG4gICAgICAoYWNjdW11bGF0b3IsIGN1cnJlbnQpID0+IHtcbiAgICAgICAgaWYgKGN1cnJlbnQuZXJyb3JzKSB7XG4gICAgICAgICAgYWRkVmFsaWRhdGlvbkVycm9ycyhjdXJyZW50LmVycm9ycywgYWNjdW11bGF0b3IpO1xuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gYWNjdW11bGF0b3I7XG4gICAgICB9LCA8VmFsaWRhdGlvbkVycm9ycz57fVxuICAgICk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGxpZnRWYWxpZGF0aW9uRXJyb3JzKGNvbnRyb2w6IEFic3RyYWN0Q29udHJvbCk6IFZhbGlkYXRpb25FcnJvcnMgfCBudWxsIHtcbiAgY29uc3QgYWxsQ29udHJvbHMgPSBjb250cm9sIGluc3RhbmNlb2YgRm9ybUdyb3VwID9cbiAgICBPYmplY3QudmFsdWVzKGNvbnRyb2wuY29udHJvbHMpIDpcbiAgICBjb250cm9sIGluc3RhbmNlb2YgRm9ybUFycmF5ID9cbiAgICAgIGNvbnRyb2wuY29udHJvbHMgOlxuICAgICAgW107XG4gIGNvbnN0IGludmFsaWRDb250cm9scyA9IGFsbENvbnRyb2xzLmZpbHRlcihjb250cm9sID0+IGNvbnRyb2wuc3RhdHVzID09PSAnSU5WQUxJRCcpO1xuICBjb25zdCBlcnJvcnM6IFZhbGlkYXRpb25FcnJvcnMgPSBpbnZhbGlkQ29udHJvbHMubGVuZ3RoID09PSAwID8ge30gOiBpbnZhbGlkQ29udHJvbHMucmVkdWNlKFxuICAgIChhY2N1bXVsYXRvciwgY3VycmVudCkgPT4ge1xuICAgICAgaWYgKGN1cnJlbnQuZXJyb3JzKSB7XG4gICAgICAgIGFkZFZhbGlkYXRpb25FcnJvcnMoY3VycmVudC5lcnJvcnMsIGFjY3VtdWxhdG9yKTtcbiAgICAgIH07XG4gICAgICBjb25zdCBpbm5lckVycm9ycyA9IGxpZnRWYWxpZGF0aW9uRXJyb3JzKGN1cnJlbnQpO1xuICAgICAgaWYgKGlubmVyRXJyb3JzKSB7XG4gICAgICAgIGFkZFZhbGlkYXRpb25FcnJvcnMoaW5uZXJFcnJvcnMsIGFjY3VtdWxhdG9yKTtcbiAgICAgIH07XG4gICAgICByZXR1cm4gYWNjdW11bGF0b3I7XG4gICAgfSwgPFZhbGlkYXRpb25FcnJvcnM+e31cbiAgKTtcbiAgcmV0dXJuIE9iamVjdC52YWx1ZXMoZXJyb3JzKS5sZW5ndGggPT09IDAgPyBudWxsIDogZXJyb3JzO1xufTtcblxuZnVuY3Rpb24gYWRkVmFsaWRhdGlvbkVycm9ycyhhZGRpdGlvbkVycm9yczogVmFsaWRhdGlvbkVycm9ycywgY3VycmVudEVycm9yczogVmFsaWRhdGlvbkVycm9ycykge1xuICBPYmplY3QuZW50cmllcyhhZGRpdGlvbkVycm9ycykuZm9yRWFjaChcbiAgICBlbnRyeSA9PiBjdXJyZW50RXJyb3JzW2VudHJ5WzBdXSA9IGVudHJ5WzFdXG4gICk7XG59Il19