import { FormGroup, FormArray, FormControl } from "@angular/forms";
import { Observable } from "rxjs";
;
//function getValidatorsOrNull(key: string, keysValidator?: Map<string, AsyncValidatorFn[] | null>, internal?: boolean): AsyncValidatorFn[] | null
//function getValidatorsOrNull(key: string, keysValidator?: Map<string, ValidatorFn[] | ExtendedControlOptions | null>, internal?: boolean): ValidatorFn[] | ExtendedControlOptions | null
function getValidatorsOrNull(key, keysValidator) {
    return keysValidator && keysValidator.has(key) ? keysValidator.get(key) : null;
}
function makeFormGroup(source, internalKey, keysValidator, asyncKeysValidator) {
    return source instanceof FormGroup ? source : Object.entries(source).reduce((accumulator, entry) => {
        const key = entry[0];
        const value = entry[1];
        if (!(value instanceof Observable)) {
            accumulator.addControl(key, !!value && value instanceof FormControl || value instanceof FormGroup || value instanceof FormArray ?
                value :
                makeForm(value, makeNewMainFormValidatorsMap(key, keysValidator), makeNewMainFormValidatorsMap(key, asyncKeysValidator)));
        }
        ;
        return accumulator;
    }, new FormGroup({}, getValidatorsOrNull(internalKey, keysValidator), getValidatorsOrNull(internalKey, asyncKeysValidator)));
}
function makeNewMainFormValidatorsMap(key, oldMap) {
    if (!oldMap || key === 'mainFormValidators' || key === 'mainFormValidatorsItems') {
        return oldMap;
    }
    else {
        if (!oldMap.has(key) && !oldMap.has(`${key}Items`)) {
            return new Map(Array.from(oldMap.entries()).filter(item => item[0] !== 'mainFormValidators' && item[0] !== 'mainFormValidatorsItems'));
        }
        else {
            const filterPredicate = oldMap.has('mainFormValidators') ?
                oldMap.has('mainFormValidatorsItems') ?
                    (item) => item[0] !== key && item[0] !== 'mainFormValidators' && item[0] !== 'mainFormValidatorsItems' :
                    (item) => item[0] !== key && item[0] !== 'mainFormValidators' :
                oldMap.has('mainFormValidatorsItems') ?
                    (item) => item[0] !== key && item[0] !== 'mainFormValidatorsItems' :
                    (item) => item[0] !== key;
            const newMainValidatorsArray = oldMap.has(key) ?
                oldMap.has(`${key}Items`) ?
                    [
                        ['mainFormValidators', oldMap.get(key)],
                        ['mainFormValidatorsItems', oldMap.get(`${key}Items`)]
                    ] :
                    [
                        ['mainFormValidators', oldMap.get(key)],
                    ] :
                oldMap.has(`${key}Items`) ?
                    [
                        ['mainFormValidatorsItems', oldMap.get(`${key}Items`)]
                    ] :
                    [];
            return new Map([
                ...newMainValidatorsArray,
                ...Array.from(oldMap.entries()).filter(filterPredicate)
            ]);
        }
        ;
    }
    ;
}
export function makeForm(source, keysValidator, asyncKeysValidator) {
    const form = !!source && (typeof source === 'object' || typeof source === 'function') ?
        source instanceof Array ?
            new FormArray(source.map(item => {
                const itemForm = makeForm(item, makeNewMainFormValidatorsMap('mainFormValidatorsItems', keysValidator), makeNewMainFormValidatorsMap('mainFormValidatorsItems', asyncKeysValidator));
                return itemForm;
            }), getValidatorsOrNull('mainFormValidators', keysValidator), getValidatorsOrNull('mainFormValidators', asyncKeysValidator)) :
            makeFormGroup(source, 'mainFormValidators', keysValidator, asyncKeysValidator) :
        new FormControl({
            disabled: keysValidator?.has('mainFormValidators') && 'disabled' in (keysValidator.get('mainFormValidators')) ?
                keysValidator.get('mainFormValidators').disabled :
                false,
            value: !!source && typeof source == 'string' && (source.includes('0001-01-01') || source.includes('1970-01-01')) ? null : source
        }, getValidatorsOrNull('mainFormValidators', keysValidator), getValidatorsOrNull('mainFormValidators', asyncKeysValidator));
    return form;
}
;
export function liftValidationErrors(control) {
    const allControls = control instanceof FormGroup ?
        Object.values(control.controls) :
        control instanceof FormArray ?
            control.controls :
            [];
    const invalidControls = allControls.filter(control => control.status === 'INVALID');
    const errors = invalidControls.length === 0 ? {} : invalidControls.reduce((accumulator, current) => {
        if (current.errors) {
            addValidationErrors(current.errors, accumulator);
        }
        ;
        const innerErrors = liftValidationErrors(current);
        if (innerErrors) {
            addValidationErrors(innerErrors, accumulator);
        }
        ;
        return accumulator;
    }, {});
    return Object.values(errors).length === 0 ? null : errors;
}
;
function addValidationErrors(additionErrors, currentErrors) {
    Object.entries(additionErrors).forEach(entry => currentErrors[entry[0]] = entry[1]);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LWV4dGVuZGVkLWZvcm0tYnVpbGRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3Byb2plY3RzL25neC1leHRlbmRlZC1mb3JtLWJ1aWxkZXIvc3JjL2xpYi9uZ3gtZXh0ZW5kZWQtZm9ybS1idWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRW5FLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFJakMsQ0FBQztBQUVGLGtKQUFrSjtBQUNsSiwwTEFBMEw7QUFDMUwsU0FBUyxtQkFBbUIsQ0FDMUIsR0FBVyxFQUFFLGFBQThCO0lBRTNDLE9BQU8sYUFBYSxJQUFJLGFBQWEsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQTtBQUNoRixDQUFDO0FBRUQsU0FBUyxhQUFhLENBQ3BCLE1BQVcsRUFDWCxXQUFtQixFQUNuQixhQUEwRSxFQUMxRSxrQkFBMkQ7SUFFM0QsT0FBTyxNQUFNLFlBQVksU0FBUyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBTSxDQUN6RSxDQUFDLFdBQXNCLEVBQUUsS0FBd0IsRUFBRSxFQUFFO1FBQ25ELE1BQU0sR0FBRyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNyQixNQUFNLEtBQUssR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdkIsSUFBSSxDQUFDLENBQUMsS0FBSyxZQUFZLFVBQVUsQ0FBQyxFQUFFO1lBQ2xDLFdBQVcsQ0FBQyxVQUFVLENBQ3BCLEdBQUcsRUFDSCxDQUFDLENBQUMsS0FBSyxJQUFJLEtBQUssWUFB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Q0FBQyxNQUFNLENBQ3pGLENBQUMsV0FBVyxFQUFFLE9BQU8sRUFBRSxFQUFFO1FBQ3ZCLElBQUksT0FBTyxDQUFDLE1BQU0sRUFBRTtZQUNsQixtQkFBbUIsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLFdBQVcsQ0FBQyxDQUFDO1NBQ2xEO1FBQUEsQ0FBQztRQUNGLE1BQU0sV0FBVyxHQUFHLG9CQUFvQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ2xELElBQUksV0FBVyxFQUFFO1lBQ2YsbUJBQW1CLENBQUMsV0FBVyxFQUFFLFdBQVcsQ0FBQyxDQUFDO1NBQy9DO1FBQUEsQ0FBQztRQUNGLE9BQU8sV0FBVyxDQUFDO0lBQ3JCLENBQUMsRUFBb0IsRUFBRSxDQUN4QixDQUFDO0lBQ0YsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO0FBQzVELENBQUM7QUFBQSxDQUFDO0FBRUYsU0FBUyxtQkFBbUIsQ0FBQyxjQUFnQyxFQUFFLGFBQStCO0lBQzVGLE1BQU0sQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUMsT0FBTyxDQUNwQyxLQUFLLENBQUMsRUFBRSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQzVDLENBQUM7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRm9ybUdyb3VwLCBGb3JtQXJyYXksIEZvcm1Db250cm9sIH0gZnJvbSBcIkBhbmd1bGFyL2Zvcm1zXCI7XG5pbXBvcnQgdHlwZSB7IFZhbGlkYXRvckZuLCBWYWxpZGF0aW9uRXJyb3JzLCBBYnN0cmFjdENvbnRyb2wsIEFzeW5jVmFsaWRhdG9yRm4sIEFic3RyYWN0Q29udHJvbE9wdGlvbnMgfSBmcm9tIFwiQGFuZ3VsYXIvZm9ybXNcIjtcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tIFwicnhqc1wiO1xuXG5pbnRlcmZhY2UgRXh0ZW5kZWRDb250cm9sT3B0aW9ucyBleHRlbmRzIEFic3RyYWN0Q29udHJvbE9wdGlvbnMge1xuICBkaXNhYmxlZD86IGJvb2xlYW4sXG59O1xuXG4vL2Z1bmN0aW9uIGdldFZhbGlkYXRvcnNPck51bGwoa2V5OiBzdHJpbmcsIGtleXNWYWxpZGF0b3I/OiBNYXA8c3RyaW5nLCBBc3luY1ZhbGlkYXRvckZuW10gfCBudWxsPiwgaW50ZXJuYWw/OiBib29sZWFuKTogQXN5bmNWYWxpZGF0b3JGbltdIHwgbnVsbFxuLy9mdW5jdGlvbiBnZXRWYWxpZGF0b3JzT3JOdWxsKGtleTogc3RyaW5nLCBrZXlzVmFsaWRhdG9yPzogTWFwPHN0cmluZywgVmFsaWRhdG9yRm5bXSB8IEV4dGVuZGVkQ29udHJvbE9wdGlvbnMgfCBudWxsPiwgaW50ZXJuYWw/OiBib29sZWFuKTogVmFsaWRhdG9yRm5bXSB8IEV4dGVuZGVkQ29udHJvbE9wdGlvbnMgfCBudWxsXG5mdW5jdGlvbiBnZXRWYWxpZGF0b3JzT3JOdWxsPFQgZXh0ZW5kcyBWYWxpZGF0b3JGbltdIHwgQXN5bmNWYWxpZGF0b3JGbltdIHwgRXh0ZW5kZWRDb250cm9sT3B0aW9ucyB8IG51bGw+KFxuICBrZXk6IHN0cmluZywga2V5c1ZhbGlkYXRvcj86IE1hcDxzdHJpbmcsIFQ+XG4pOiBUIHwgdW5kZWZpbmVkIHwgbnVsbCB7XG4gIHJldHVybiBrZXlzVmFsaWRhdG9yICYmIGtleXNWYWxpZGF0b3IuaGFzKGtleSkgPyBrZXlzVmFsaWRhdG9yLmdldChrZXkpIDogbnVsbFxufVxuXG5mdW5jdGlvbiBtYWtlRm9ybUdyb3VwKFxuICBzb3VyY2U6IGFueSxcbiAgaW50ZXJuYWxLZXk6IHN0cmluZyxcbiAga2V5c1ZhbGlkYXRvcj86IE1hcDxzdHJpbmcsIFZhbGlkYXRvckZuW10gfCBFeHRlbmRlZENvbnRyb2xPcHRpb25zIHwgbnVsbD4sXG4gIGFzeW5jS2V5c1ZhbGlkYXRvcj86IE1hcDxzdHJpbmcsIEFzeW5jVmFsaWRhdG9yRm5bXSB8IG51bGw+XG4pOiBGb3JtR3JvdXAge1xuICByZXR1cm4gc291cmNlIGluc3RhbmNlb2YgRm9ybUdyb3VwID8gc291cmNlIDogT2JqZWN0LmVudHJpZXMoc291cmNlKS5yZWR1Y2UoXG4gICAgKGFjY3VtdWxhdG9yOiBGb3JtR3JvdXAsIGVudHJ5OiBbc3RyaW5nLCB1bmtub3duXSkgPT4ge1xuICAgICAgY29uc3Qga2V5ID0gZW50cnlbMF07XG4gICAgICBjb25zdCB2YWx1ZSA9IGVudHJ5WzFdO1xuICAgICAgaWYgKCEodmFsdWUgaW5zdGFuY2VvZiBPYnNlcnZhYmxlKSkge1xuICAgICAgICBhY2N1bXVsYXRvci5hZGRDb250cm9sKFxuICAgICAgICAgIGtleSxcbiAgICAgICAgICAhIXZhbHVlICYmIHZhbHVlIGluc3RhbmNlb2YgRm9ybUNvbnRyb2wgfHwgdmFsdWUgaW5zdGFuY2VvZiBGb3JtR3JvdXAgfHwgdmFsdWUgaW5zdGFuY2VvZiBGb3JtQXJyYXkgP1xuICAgICAgICAgICAgdmFsdWUgOlxuICAgICAgICAgICAgbWFrZUZvcm0oXG4gICAgICAgICAgICAgIHZhbHVlLFxuICAgICAgICAgICAgICBtYWtlTmV3TWFpbkZvcm1WYWxpZGF0b3JzTWFwKGtleSwga2V5c1ZhbGlkYXRvciksXG4gICAgICAgICAgICAgIG1ha2VOZXdNYWluRm9ybVZhbGlkYXRvcnNNYXAoa2V5LCBhc3luY0tleXNWYWxpZGF0b3IpLFxuICAgICAgICAgICAgKVxuICAgICAgICApO1xuICAgICAgfTtcbiAgICAgIHJldHVybiBhY2N1bXVsYXRvcjtcbiAgICB9LCBuZXcgRm9ybUdyb3VwKHt9LFxuICAgICAgZ2V0VmFsaWRhdG9yc09yTnVsbChpbnRlcm5hbEtleSwga2V5c1ZhbGlkYXRvciksXG4gICAgICBnZXRWYWxpZGF0b3JzT3JOdWxsKGludGVybmFsS2V5LCBhc3luY0tleXNWYWxpZGF0b3IpXG4gICAgKVxuICApO1xufVxuXG5mdW5jdGlvbiBtYWtlTmV3TWFpbkZvcm1WYWxpZGF0b3JzTWFwPFQgZXh0ZW5kcyBWYWxpZGF0b3JGbltdIHwgQXN5bmNWYWxpZGF0b3JGbltdIHwgRXh0ZW5kZWRDb250cm9sT3B0aW9ucyB8IG51bGw+KFxuICBrZXk6IHN0cmluZywgb2xkTWFwPzogTWFwPHN0cmluZywgVD4sXG4pOiBNYXA8c3RyaW5nLCBUPiB8IHVuZGVmaW5lZCB7XG4gIGlmICghb2xkTWFwIHx8IGtleSA9PT0gJ21haW5Gb3JtVmFsaWRhdG9ycycgfHwga2V5ID09PSAnbWFpbkZvcm1WYWxpZGF0b3JzSXRlbXMnKSB7XG4gICAgcmV0dXJuIG9sZE1hcDtcbiAgfSBlbHNlIHtcbiAgICBpZiAoIW9sZE1hcC5oYXMoa2V5KSAmJiAhb2xkTWFwLmhhcyhgJHtrZXl9SXRlbXNgKSkge1xuICAgICAgcmV0dXJuIG5ldyBNYXA8c3RyaW5nLCBUPihcbiAgICAgICAgQXJyYXkuZnJvbShcbiAgICAgICAgICBvbGRNYXAuZW50cmllcygpXG4gICAgICAgICkuZmlsdGVyKFxuICAgICAgICAgIGl0ZW0gPT4gaXRlbVswXSAhPT0gJ21haW5Gb3JtVmFsaWRhdG9ycycgJiYgaXRlbVswXSAhPT0gJ21haW5Gb3JtVmFsaWRhdG9yc0l0ZW1zJ1xuICAgICAgICApXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBmaWx0ZXJQcmVkaWNhdGUgPSBvbGRNYXAuaGFzKCdtYWluRm9ybVZhbGlkYXRvcnMnKSA/XG4gICAgICAgIG9sZE1hcC5oYXMoJ21haW5Gb3JtVmFsaWRhdG9yc0l0ZW1zJykgP1xuICAgICAgICAgIChpdGVtOiBbc3RyaW5nLCBUXSkgPT4gaXRlbVswXSAhPT0ga2V5ICYmIGl0ZW1bMF0gIT09ICdtYWluRm9ybVZhbGlkYXRvcnMnICYmIGl0ZW1bMF0gIT09ICdtYWluRm9ybVZhbGlkYXRvcnNJdGVtcycgOlxuICAgICAgICAgIChpdGVtOiBbc3RyaW5nLCBUXSkgPT4gaXRlbVswXSAhPT0ga2V5ICYmIGl0ZW1bMF0gIT09ICdtYWluRm9ybVZhbGlkYXRvcnMnIDpcbiAgICAgICAgb2xkTWFwLmhhcygnbWFpbkZvcm1WYWxpZGF0b3JzSXRlbXMnKSA/XG4gICAgICAgICAgKGl0ZW06IFtzdHJpbmcsIFRdKSA9PiBpdGVtWzBdICE9PSBrZXkgJiYgaXRlbVswXSAhPT0gJ21haW5Gb3JtVmFsaWRhdG9yc0l0ZW1zJyA6XG4gICAgICAgICAgKGl0ZW06IFtzdHJpbmcsIFRdKSA9PiBpdGVtWzBdICE9PSBrZXk7XG4gICAgICBjb25zdCBuZXdNYWluVmFsaWRhdG9yc0FycmF5OiBbc3RyaW5nLCBUXVtdID0gb2xkTWFwLmhhcyhrZXkpID9cbiAgICAgICAgb2xkTWFwLmhhcyhgJHtrZXl9SXRlbXNgKSA/XG4gICAgICAgICAgW1xuICAgICAgICAgICAgWydtYWluRm9ybVZhbGlkYXRvcnMnLCBvbGRNYXAuZ2V0KGtleSkhXSxcbiAgICAgICAgICAgIFsnbWFpbkZvcm1WYWxpZGF0b3JzSXRlbXMnLCBvbGRNYXAuZ2V0KGAke2tleX1JdGVtc2ApIV1cbiAgICAgICAgICBdIDpcbiAgICAgICAgICBbXG4gICAgICAgICAgICBbJ21haW5Gb3JtVmFsaWRhdG9ycycsIG9sZE1hcC5nZXQoa2V5KSFdLFxuICAgICAgICAgIF0gOlxuICAgICAgICBvbGRNYXAuaGFzKGAke2tleX1JdGVtc2ApID9cbiAgICAgICAgICBbXG4gICAgICAgICAgICBbJ21haW5Gb3JtVmFsaWRhdG9yc0l0ZW1zJywgb2xkTWFwLmdldChgJHtrZXl9SXRlbXNgKSFdXG4gICAgICAgICAgXSA6XG4gICAgICAgICAgW107XG4gICAgICByZXR1cm4gbmV3IE1hcDxzdHJpbmcsIFQ+KFtcbiAgICAgICAgLi4ubmV3TWFpblZhbGlkYXRvcnNBcnJheSxcbiAgICAgICAgLi4uQXJyYXkuZnJvbShcbiAgICAgICAgICBvbGRNYXAuZW50cmllcygpXG4gICAgICAgICkuZmlsdGVyKGZpbHRlclByZWRpY2F0ZSlcbiAgICAgIF0pO1xuICAgIH07XG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtYWtlRm9ybTxUIGV4dGVuZHMgdW5rbm93biwgUiBleHRlbmRzIChUIGV4dGVuZHMgQXJyYXk8YW55PiA/IEZvcm1BcnJheSA6IFQgZXh0ZW5kcyBzdHJpbmcgfCBudW1iZXIgfCBib29sZWFuIHwgc3ltYm9sID8gRm9ybUNvbnRyb2wgOiBGb3JtR3JvdXApPihcbiAgc291cmNlOiBULFxuICBrZXlzVmFsaWRhdG9yPzogTWFwPHN0cmluZywgVmFsaWRhdG9yRm5bXSB8IEV4dGVuZGVkQ29udHJvbE9wdGlvbnMgfCBudWxsPixcbiAgYXN5bmNLZXlzVmFsaWRhdG9yPzogTWFwPHN0cmluZywgQXN5bmNWYWxpZGF0b3JGbltdIHwgbnVsbD4sXG4pOiBSIHtcbiAgY29uc3QgZm9ybSA9ICEhc291cmNlICYmICh0eXBlb2Ygc291cmNlID09PSAnb2JqZWN0JyB8fCB0eXBlb2Ygc291cmNlID09PSAnZnVuY3Rpb24nKSA/XG4gICAgc291cmNlIGluc3RhbmNlb2YgQXJyYXkgP1xuICAgICAgbmV3IEZvcm1BcnJheShcbiAgICAgICAgc291cmNlLm1hcChcbiAgICAgICAgICBpdGVtID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGl0ZW1Gb3JtID0gbWFrZUZvcm0oXG4gICAgICAgICAgICAgIGl0ZW0sXG4gICAgICAgICAgICAgIG1ha2VOZXdNYWluRm9ybVZhbGlkYXRvcnNNYXAoJ21haW5Gb3JtVmFsaWRhdG9yc0l0ZW1zJywga2V5c1ZhbGlkYXRvciksXG4gICAgICAgICAgICAgIG1ha2VOZXdNYWluRm9ybVZhbGlkYXRvcnNNYXAoJ21haW5Gb3JtVmFsaWRhdG9yc0l0ZW1zJywgYXN5bmNLZXlzVmFsaWRhdG9yKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHJldHVybiBpdGVtRm9ybTtcbiAgICAgICAgICB9KSxcbiAgICAgICAgZ2V0VmFsaWRhdG9yc09yTnVsbCgnbWFpbkZvcm1WYWxpZGF0b3JzJywga2V5c1ZhbGlkYXRvciksXG4gICAgICAgIGdldFZhbGlkYXRvcnNPck51bGwoJ21haW5Gb3JtVmFsaWRhdG9ycycsIGFzeW5jS2V5c1ZhbGlkYXRvcilcbiAgICAgICkgOlxuICAgICAgbWFrZUZvcm1Hcm91cChzb3VyY2UsICdtYWluRm9ybVZhbGlkYXRvcnMnLCBrZXlzVmFsaWRhdG9yLCBhc3luY0tleXNWYWxpZGF0b3IpIDpcbiAgICBuZXcgRm9ybUNvbnRyb2woe1xuICAgICAgZGlzYWJsZWQ6IGtleXNWYWxpZGF0b3I/LmhhcygnbWFpbkZvcm1WYWxpZGF0b3JzJykgJiYgJ2Rpc2FibGVkJyBpbiAoa2V5c1ZhbGlkYXRvci5nZXQoJ21haW5Gb3JtVmFsaWRhdG9ycycpISkgP1xuICAgICAgICAoPEV4dGVuZGVkQ29udHJvbE9wdGlvbnM+a2V5c1ZhbGlkYXRvci5nZXQoJ21haW5Gb3JtVmFsaWRhdG9ycycpKS5kaXNhYmxlZCA6XG4gICAgICAgIGZhbHNlLFxuICAgICAgdmFsdWU6ICEhc291cmNlICYmIHR5cGVvZiBzb3VyY2UgPT0gJ3N0cmluZycgJiYgKHNvdXJjZS5pbmNsdWRlcygnMDAwMS0wMS0wMScpIHx8IHNvdXJjZS5pbmNsdWRlcygnMTk3MC0wMS0wMScpKSA/IG51bGwgOiBzb3VyY2VcbiAgICB9LFxuICAgICAgZ2V0VmFsaWRhdG9yc09yTnVsbCgnbWFpbkZvcm1WYWxpZGF0b3JzJywga2V5c1ZhbGlkYXRvciksXG4gICAgICBnZXRWYWxpZGF0b3JzT3JOdWxsKCdtYWluRm9ybVZhbGlkYXRvcnMnLCBhc3luY0tleXNWYWxpZGF0b3IpXG4gICAgKTtcbiAgcmV0dXJuIDxSPmZvcm07XG59O1xuXG5leHBvcnQgZnVuY3Rpb24gbGlmdFZhbGlkYXRpb25FcnJvcnMoY29udHJvbDogQWJzdHJhY3RDb250cm9sKTogVmFsaWRhdGlvbkVycm9ycyB8IG51bGwge1xuICBjb25zdCBhbGxDb250cm9scyA9IGNvbnRyb2wgaW5zdGFuY2VvZiBGb3JtR3JvdXAgP1xuICAgIE9iamVjdC52YWx1ZXMoY29udHJvbC5jb250cm9scykgOlxuICAgIGNvbnRyb2wgaW5zdGFuY2VvZiBGb3JtQXJyYXkgP1xuICAgICAgY29udHJvbC5jb250cm9scyA6XG4gICAgICBbXTtcbiAgY29uc3QgaW52YWxpZENvbnRyb2xzID0gYWxsQ29udHJvbHMuZmlsdGVyKGNvbnRyb2wgPT4gY29udHJvbC5zdGF0dXMgPT09ICdJTlZBTElEJyk7XG4gIGNvbnN0IGVycm9yczogVmFsaWRhdGlvbkVycm9ycyA9IGludmFsaWRDb250cm9scy5sZW5ndGggPT09IDAgPyB7fSA6IGludmFsaWRDb250cm9scy5yZWR1Y2UoXG4gICAgKGFjY3VtdWxhdG9yLCBjdXJyZW50KSA9PiB7XG4gICAgICBpZiAoY3VycmVudC5lcnJvcnMpIHtcbiAgICAgICAgYWRkVmFsaWRhdGlvbkVycm9ycyhjdXJyZW50LmVycm9ycywgYWNjdW11bGF0b3IpO1xuICAgICAgfTtcbiAgICAgIGNvbnN0IGlubmVyRXJyb3JzID0gbGlmdFZhbGlkYXRpb25FcnJvcnMoY3VycmVudCk7XG4gICAgICBpZiAoaW5uZXJFcnJvcnMpIHtcbiAgICAgICAgYWRkVmFsaWRhdGlvbkVycm9ycyhpbm5lckVycm9ycywgYWNjdW11bGF0b3IpO1xuICAgICAgfTtcbiAgICAgIHJldHVybiBhY2N1bXVsYXRvcjtcbiAgICB9LCA8VmFsaWRhdGlvbkVycm9ycz57fVxuICApO1xuICByZXR1cm4gT2JqZWN0LnZhbHVlcyhlcnJvcnMpLmxlbmd0aCA9PT0gMCA/IG51bGwgOiBlcnJvcnM7XG59O1xuXG5mdW5jdGlvbiBhZGRWYWxpZGF0aW9uRXJyb3JzKGFkZGl0aW9uRXJyb3JzOiBWYWxpZGF0aW9uRXJyb3JzLCBjdXJyZW50RXJyb3JzOiBWYWxpZGF0aW9uRXJyb3JzKSB7XG4gIE9iamVjdC5lbnRyaWVzKGFkZGl0aW9uRXJyb3JzKS5mb3JFYWNoKFxuICAgIGVudHJ5ID0+IGN1cnJlbnRFcnJvcnNbZW50cnlbMF1dID0gZW50cnlbMV1cbiAgKTtcbn0iXX0=