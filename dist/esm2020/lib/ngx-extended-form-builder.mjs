import { FormGroup, FormArray, FormControl } from "@angular/forms";
import { Observable } from "rxjs";
function getValidatorsOrNull(key, keysValidator, addLift = false) {
    const result = keysValidator && keysValidator.has(key) ? keysValidator.get(key) : null;
    if (addLift) {
        if (result && Array.isArray(result)) {
            result.push(liftErrors);
            return result;
        }
        else {
            return result ? result : [liftErrors];
        }
    }
    else {
        return result;
    }
    ;
}
function makeFormGroup(source, internalKey, keysValidator, asyncKeysValidator) {
    return source instanceof (FormGroup) ?
        source :
        Object.entries(source).reduce((accumulator, entry) => {
            const key = entry[0];
            const value = entry[1];
            if (!(value instanceof Observable)) {
                accumulator.addControl(key, !!value && (value instanceof FormGroup || value instanceof FormArray || value instanceof FormControl) ?
                    value :
                    makeForm(value, makeNewMainFormValidatorsMap(key, keysValidator), makeNewMainFormValidatorsMap(key, asyncKeysValidator)));
            }
            ;
            return accumulator;
        }, new FormGroup({}, getValidatorsOrNull(internalKey, keysValidator, true), getValidatorsOrNull(internalKey, asyncKeysValidator, false)));
}
function makeNewMainFormValidatorsMap(key, oldMap) {
    if (!oldMap || key === 'mainFormValidators' || key === 'mainFormValidatorsItems') {
        return oldMap;
    }
    else {
        if (!oldMap.has(key) && !oldMap.has(`${key}Items`)) {
            return new Map(Array.from(oldMap.entries()).filter(item => item[0] !== 'mainFormValidators' && item[0] !== 'mainFormValidatorsItems').map(([entryKey, entryValue]) => [entryKey.startsWith(`${key}.`) ? entryKey.replace(`${key}.`, '') : entryKey, entryValue]));
        }
        else {
            const filterPredicate = oldMap.has('mainFormValidators') ?
                oldMap.has('mainFormValidatorsItems') ?
                    (item) => item[0] !== key && item[0] !== 'mainFormValidators' && item[0] !== 'mainFormValidatorsItems' :
                    (item) => item[0] !== key && item[0] !== 'mainFormValidators' :
                oldMap.has('mainFormValidatorsItems') ?
                    (item) => item[0] !== key && item[0] !== 'mainFormValidatorsItems' :
                    (item) => item[0] !== key;
            const newMainValidatorsArray = oldMap.has(key) ?
                oldMap.has(`${key}Items`) ?
                    [
                        ['mainFormValidators', oldMap.get(key)],
                        ['mainFormValidatorsItems', oldMap.get(`${key}Items`)]
                    ] :
                    [
                        ['mainFormValidators', oldMap.get(key)],
                    ] :
                oldMap.has(`${key}Items`) ?
                    [
                        ['mainFormValidatorsItems', oldMap.get(`${key}Items`)]
                    ] :
                    [];
            return new Map([
                ...newMainValidatorsArray,
                ...Array.from(oldMap.entries()).filter(filterPredicate).map(([entryKey, entryValue]) => [entryKey.startsWith(`${key}.`) ? entryKey.replace(`${key}.`, '') : entryKey, entryValue])
            ]);
        }
        ;
    }
    ;
}
/**
@function makeForm < T >
  Фабричная функция для создания Angular Reactive Form.
В отличие от стандартного FormBuilder - а в пакете @angular/forms, при создании формы из сложных объектов,
сохраняется вложенность контролов - каждый вложенный объект превращается во вложенную FormGroup,
  обычные свойства объектов становятся FormControl - ами, а массивы - FormArray - ми.
При этом создаваемая форма имеет более строгую типизацию.

  ВАЖНО!
   Чтобы избежать ошибки переполнения стэка вызовов в рекурсивном процессе создания формы, для любых;
Observable - значений(в т.ч., к примеру, Subject * и EventEmitter) соответствующий элемент формы не создается.
 * @param source  источник данных типа T для создания формы.
 * @param keysValidator объект Map с конфигурацией синхронных валидаторов контролов формы.
 * В качестве ключей могут быть указаны следующие значения:
 *  PropertyesKeys<T> - строковые ключи в типе T, включая строковые ключи всех вложенных типов, разделенные "." - точкой.
    Например имеется такой тип:
    ```ts
                    interface User {
                      firstname: string;
                      lastname: string;
                      phone:  {
                        code: string;
                        number: string;
                        }
                      };
    ```
    Для формы, которая будет создана из объекта User в конфигурации валидаторов названия контролов можно будет указать так:
    `lastname` или`phone`, или`phone.code`.

   'mainFormValidators' - специальное значение, являющееся признаком того, что массив валидаторов необходимо
    назначить самому объекту формы, а не вложеным контролам.

   'mainFormValidatorsItems' - используется только если source является массивом. Специальное значение, являющееся признаком того,
  что массив валидаторов необходимо назначить для всех элементов массива FormArray.
 * @param asyncKeysValidator объект Map, аналогичный keysValidator, но для асинхронных валидаторов
 * @returns объект типизированной формы - FormGroup, FormArray или FormControl в зависимости от типа значения source.
 */
export function makeForm(source, keysValidator, asyncKeysValidator) {
    const form = !!source && (typeof source === 'object' || typeof source === 'function') ?
        source instanceof (Array) ?
            new FormArray(source.map((item) => {
                const itemForm = makeForm(item, makeNewMainFormValidatorsMap('mainFormValidatorsItems', keysValidator), makeNewMainFormValidatorsMap('mainFormValidatorsItems', asyncKeysValidator));
                return itemForm;
            }), getValidatorsOrNull('mainFormValidators', keysValidator, true), getValidatorsOrNull('mainFormValidators', asyncKeysValidator, false)) :
            makeFormGroup(source, 'mainFormValidators', keysValidator, asyncKeysValidator) :
        new FormControl(!!source && typeof source == 'string' && (source.includes('0001-01-01') || source.includes('1970-01-01')) ? null : source, getValidatorsOrNull('mainFormValidators', keysValidator, false), getValidatorsOrNull('mainFormValidators', asyncKeysValidator, false));
    return form;
}
;
function liftErrors(control) {
    if (control instanceof FormControl) {
        return null;
    }
    else {
        const allControls = control instanceof FormGroup ?
            Object.values(control.controls) :
            control instanceof FormArray ?
                control.controls :
                [];
        const invalidControls = allControls.filter(control => control.status === 'INVALID');
        return invalidControls.length === 0 ? null : invalidControls.reduce((accumulator, current) => {
            if (current.errors) {
                addValidationErrors(current.errors, accumulator);
            }
            ;
            return accumulator;
        }, {});
    }
}
export function liftValidationErrors(control) {
    const allControls = control instanceof FormGroup ?
        Object.values(control.controls) :
        control instanceof FormArray ?
            control.controls :
            [];
    const invalidControls = allControls.filter(control => control.status === 'INVALID');
    const errors = invalidControls.length === 0 ? {} : invalidControls.reduce((accumulator, current) => {
        if (current.errors) {
            addValidationErrors(current.errors, accumulator);
        }
        ;
        const innerErrors = liftValidationErrors(current);
        if (innerErrors) {
            addValidationErrors(innerErrors, accumulator);
        }
        ;
        return accumulator;
    }, {});
    return Object.values(errors).length === 0 ? null : errors;
}
;
function addValidationErrors(additionErrors, currentErrors) {
    Object.entries(additionErrors).forEach(entry => currentErrors[entry[0]] = entry[1]);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LWV4dGVuZGVkLWZvcm0tYnVpbGRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3Byb2plY3RzL25neC1leHRlbmRlZC1mb3JtLWJ1aWxkZXIvc3JjL2xpYi9uZ3gtZXh0ZW5kZWQtZm9ybS1idWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRW5FLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUF1RGxDLFNBQVMsbUJBQW1CLENBQzFCLEdBQVcsRUFBRSxhQUE4QixFQUFFLFVBQW1CLEtBQUs7SUFFckUsTUFBTSxNQUFNLEdBQUcsYUFBYSxJQUFJLGFBQWEsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUN2RixJQUFJLE9BQU8sRUFBRTtRQUNYLElBQUksTUFBTSxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDbEIsTUFBTyxDQUFDLElBQUksQ0FBZSxVQUFVLENBQUMsQ0FBQztZQUN4RCxPQUFXLE1BQU0sQ0FBQztTQUNuQjthQUFNO1lBQ0wsT0FBTyxNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUksQ0FBRSxVQUFVLENBQUUsQ0FBQztTQUM1QztLQUNGO1NBQU07UUFDTCxPQUFPLE1BQU0sQ0FBQztLQUNmO0lBQUEsQ0FBQztBQUNKLENBQUM7QUFFRCxTQUFTLGFBQWEsQ0FDcEIsTUFBUyxFQUNULFdBQW1CLEVBQ25CLGFBQTJELEVBQzNELGtCQUFxRTtJQUVyRSxPQUFPLE1BQU0sYUFBWSxTQUE0RCxDQUFBLENBQUMsQ0FBQztRQUNyRixNQUFNLENBQUMsQ0FBQztRQUNtQyxNQUFNLENBQUMsT0FB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LENBQUMsT0FBTyxDQUNwQyxLQUFLLENBQUMsRUFBRSxDQUFDLGFBQWEsQ0FBRSxLQUFLLENBQUUsQ0FBQyxDQUFFLENBQUUsR0FBRyxLQUFLLENBQUUsQ0FBQyxDQUFFLENBQ2xELENBQUM7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRm9ybUdyb3VwLCBGb3JtQXJyYXksIEZvcm1Db250cm9sIH0gZnJvbSBcIkBhbmd1bGFyL2Zvcm1zXCI7XG5pbXBvcnQgdHlwZSB7IFZhbGlkYXRvckZuLCBWYWxpZGF0aW9uRXJyb3JzLCBBc3luY1ZhbGlkYXRvckZuLCBBYnN0cmFjdENvbnRyb2wgfSBmcm9tIFwiQGFuZ3VsYXIvZm9ybXNcIjtcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tIFwicnhqc1wiO1xuXG4vKipcbiAqINCS0YHQv9C+0LzQvtCz0LDRgtC10LvRjNC90LDRjyDRg9GC0LjQu9C40YLQsCDRgtC40L/QsC5cbiAqINCd0LAg0LLRhdC+0LQg0L/RgNC40L3QuNC80LDQtdGCINC90LXQutC40Lkg0YLQuNC/IFQsINCy0L7Qt9Cy0YDQsNGJ0LDQtdGCINGB0L/QuNGB0L7QuiDRgtC+0LvRjNC60L4g0YHRgtGA0L7QutC+0LLRi9GFINC60LvRjtGH0LXQuSDRjdGC0L7Qs9C+INGC0LjQv9CwLCDQv9GA0Lgg0Y3RgtC+0Lwg0LfQvdCw0YfQtdC90LjRjyDRjdGC0LjRhSDQutC70Y7Rh9C10Lkg0L3QtSDRj9Cy0LvRj9GO0YLRgdGPIE9ic2VydmFibGUuXG4gKi9cbmV4cG9ydCB0eXBlIFN0cmluZ0tleXM8VD4gPSB7IFsgSyBpbiBrZXlvZiBUIF06IEsgZXh0ZW5kcyBzdHJpbmcgPyBUWyBLIF0gZXh0ZW5kcyBPYnNlcnZhYmxlPHVua25vd24+ID8gbmV2ZXIgOiBLIDogbmV2ZXI7IH1bIGtleW9mIFQgXTtcblxuLyoqXG4gKiDQktGB0L/QvtC80L7Qs9Cw0YLQtdC70YzQvdGL0LkgYWxpYXMt0YLQuNC/INC60LvRjtGH0LXQuSDQsiDQvtCx0YrQtdC60YLQtSBNYXAsINGB0L7QtNC10YDQttCw0YnQtdC8INC60L7QvdGE0LjQs9GD0YDQsNGG0LjRjiDQstCw0LvQuNC00LDRgtC+0YDQvtCyINC60L7QvdGC0YDQvtC70L7Qsi5cbiAqL1xuZXhwb3J0IHR5cGUgQ29udHJvbHNOYW1lczxUPiA9ICdtYWluRm9ybVZhbGlkYXRvcnMnIHwgJ21haW5Gb3JtVmFsaWRhdG9yc0l0ZW1zJyB8IFByb3BlcnR5ZXNLZXlzPFQ+O1xuXG4vKipcbiAqINCS0YHQv9C+0LzQvtCz0LDRgtC10LvRjNC90LDRjyDRg9GC0LjQu9C40YLQsCDRgtC40L/QsC5cbiAqINCd0LAg0LLRhdC+0LQg0L/RgNC40L3QuNC80LDQtdGCINC90LXQutC40Lkg0YLQuNC/IFQsINCy0L7Qt9Cy0YDQsNGJ0LDQtdGCINGC0L7Qu9GM0LrQviDRgdGC0YDQvtC60L7QstGL0LUg0LrQu9GO0YfQuCDRjdGC0L7Qs9C+INGC0LjQv9CwLlxuICovXG5leHBvcnQgdHlwZSBQcm9wZXJ0eWVzS2V5czxUPiA9IFQgZXh0ZW5kcyB1bmRlZmluZWQgfCBudWxsIHwgbnVtYmVyIHwgYm9vbGVhbiB8IHN5bWJvbCB8IE9ic2VydmFibGU8dW5rbm93bj4gP1xuICBuZXZlciA6XG4gIFQgZXh0ZW5kcyBzdHJpbmcgP1xuICBUIDoge1xuICAgIFsgSyBpbiBrZXlvZiBUIF0tPzogSyBleHRlbmRzIHN0cmluZyA/XG4gICAgVFsgSyBdIGV4dGVuZHMgKHN0cmluZyB8IG51bWJlciB8IGJvb2xlYW4gfCBzeW1ib2wgfCB1bmRlZmluZWQgfCBudWxsKSA/XG4gICAgSyA6XG4gICAgVFsgSyBdIGV4dGVuZHMgT2JzZXJ2YWJsZTx1bmtub3duPiA/XG4gICAgbmV2ZXIgOlxuICAgIFRbIEsgXSBleHRlbmRzIEFycmF5PGluZmVyIFU+ID9cbiAgICBLIHwgYCR7IEsgfUl0ZW1zYCB8IGAkeyBLIH0uJHsgUHJvcGVydHllc0tleXM8VT4gfWAgOlxuICAgIEsgfCBgJHsgSyB9LiR7IFByb3BlcnR5ZXNLZXlzPFRbIEsgXT4gfWAgOlxuICAgIG5ldmVyXG4gIH1bIGtleW9mIFQgXTtcblxuLyoqXG4gKiDQo9C/0YDQvtGJ0LXQvdC90LDRjyDQt9Cw0L/QuNGB0Ywg0LTQu9GPINGC0LjQv9CwINC+0LHRitC10LrRgtCwIEZvcm1Hcm91cCwg0L7QsdGA0LDQt9C+0LLQsNC90L3QvtCz0L4g0LjQtyDRgtC40L/QsCBULlxuICovXG5leHBvcnQgdHlwZSBGb3JtR3JvdXBUeXBlPFQ+ID0gRm9ybUdyb3VwPHsgWyBLIGluIFN0cmluZ0tleXM8VD4gXTogU2NhbkZvcm1UeXBlPFRbIEsgXT47IH0+O1xuXG4vKipcbiAqINCj0L3QuNCy0LXRgNGB0LDQu9GM0L3Ri9C5INGC0LjQvy3Rg9GC0LjQu9C40YLQsC5cbiAqINCU0LvRjyDQu9GO0LHQvtCz0L4g0YLQuNC/0LAg0KIg0LLRi9Cy0L7QtNC40YIg0L/RgNCw0LLQuNC70YzQvdGL0Lkg0YLQuNC/INGB0L7Qt9C00LDQstCw0LXQvNC+0Lkg0YTQvtGA0LzRiywg0LLQutC70Y7Rh9Cw0Y8g0LvRjtCx0L7QuSDRg9GA0L7QstC10L3RjCDQstC70L7QttC10L3QvdC+0YHRgtC4LlxuICog0JLQkNCW0J3QniFcbiAqINCn0YLQvtCx0Ysg0LjQt9Cx0LXQttCw0YLRjCDQvtGI0LjQsdC60Lgg0L/QtdGA0LXQv9C+0LvQvdC10L3QuNGPINGB0YLRjdC60LAg0LLRi9C30L7QstC+0LIg0LIg0YDQtdC60YPRgNGB0LjQstC90L7QvCDQv9GA0L7RhtC10YHRgdC1INGB0L7Qt9C00LDQvdC40Y8g0YTQvtGA0LzRiywg0LTQu9GPINC70Y7QsdGL0YVcbiAqIE9ic2VydmFibGUt0LfQvdCw0YfQtdC90LjQuSAoINCyINGCLtGHLiwg0Log0L/RgNC40LzQtdGA0YMsIFN1YmplY3QgICog0LggRXZlbnRFbWl0dGVyKSDRgdC+0L7RgtCy0LXRgtGB0YLQstGD0Y7RidC40Lkg0Y3Qu9C10LzQtdC90YIg0YTQvtGA0LzRiyDQvdC1INGB0L7Qt9C00LDQtdGC0YHRjy5cbiAqIFNjYW5Gb3JtVHlwZSDRjdGC0L4g0YLQsNC60LbQtSDRg9GH0LjRgtGL0LLQsNC10YIuXG4gKi9cbmV4cG9ydCB0eXBlIFNjYW5Gb3JtVHlwZTxUPiA9IFQgZXh0ZW5kcyBGb3JtR3JvdXAgfCBGb3JtQ29udHJvbCB8IEZvcm1BcnJheSA/XG4gIFQgOlxuICBUIGV4dGVuZHMgbnVsbCB8IHVuZGVmaW5lZCA/XG4gIG5ldmVyIDpcbiAgVCBleHRlbmRzIEFycmF5PGluZmVyIFU+ID9cbiAgRm9ybUFycmF5PFNjYW5Gb3JtVHlwZTxVPj4gOlxuICBUIGV4dGVuZHMgKHN0cmluZyB8IG51bWJlciB8IGJvb2xlYW4gfCBzeW1ib2wgfCBudWxsIHwgdW5kZWZpbmVkKSA/XG4gIEZvcm1Db250cm9sPFQ+IDpcbiAgRm9ybUdyb3VwVHlwZTxUPjtcblxuZnVuY3Rpb24gZ2V0VmFsaWRhdG9yc09yTnVsbDxUIGV4dGVuZHMgVmFsaWRhdG9yRm5bXSB8IEFzeW5jVmFsaWRhdG9yRm5bXSB8IG51bGw+KFxuICBrZXk6IHN0cmluZywga2V5c1ZhbGlkYXRvcj86IE1hcDxzdHJpbmcsIFQ+LCBhZGRMaWZ0OiBib29sZWFuID0gZmFsc2Vcbik6IFQgfCB1bmRlZmluZWQgfCBudWxsIHtcbiAgY29uc3QgcmVzdWx0ID0ga2V5c1ZhbGlkYXRvciAmJiBrZXlzVmFsaWRhdG9yLmhhcyhrZXkpID8ga2V5c1ZhbGlkYXRvci5nZXQoa2V5KSA6IG51bGw7XG4gIGlmIChhZGRMaWZ0KSB7XG4gICAgaWYgKHJlc3VsdCAmJiBBcnJheS5pc0FycmF5KHJlc3VsdCkpIHtcbiAgICAgICg8VmFsaWRhdG9yRm5bXT4gcmVzdWx0KS5wdXNoKDxWYWxpZGF0b3JGbj4gbGlmdEVycm9ycyk7XG4gICAgICByZXR1cm4gPFQ+IHJlc3VsdDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHJlc3VsdCA/IHJlc3VsdCA6IDxUPlsgbGlmdEVycm9ycyBdO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9O1xufVxuXG5mdW5jdGlvbiBtYWtlRm9ybUdyb3VwPFQ+KFxuICBzb3VyY2U6IFQsXG4gIGludGVybmFsS2V5OiBzdHJpbmcsXG4gIGtleXNWYWxpZGF0b3I/OiBNYXA8Q29udHJvbHNOYW1lczxUPiwgVmFsaWRhdG9yRm5bXSB8IG51bGw+LFxuICBhc3luY0tleXNWYWxpZGF0b3I/OiBNYXA8Q29udHJvbHNOYW1lczxUPiwgQXN5bmNWYWxpZGF0b3JGbltdIHwgbnVsbD5cbik6IEZvcm1Hcm91cFR5cGU8VD4ge1xuICByZXR1cm4gc291cmNlIGluc3RhbmNlb2YgRm9ybUdyb3VwPHsgWyBLIGluIFN0cmluZ0tleXM8VD4gXTogU2NhbkZvcm1UeXBlPFRbIEsgXT47IH0+ID9cbiAgICBzb3VyY2UgOlxuICAgICg8WyBTdHJpbmdLZXlzPFQ+LCBUWyBTdHJpbmdLZXlzPFQ+IF0gXVtdPiBPYmplY3QuZW50cmllcyhzb3VyY2UpKS5yZWR1Y2UoXG4gICAgICAoYWNjdW11bGF0b3I6IEZvcm1Hcm91cCwgZW50cnk6IFsgU3RyaW5nS2V5czxUPiwgVFsgU3RyaW5nS2V5czxUPiBdIF0pID0+IHtcbiAgICAgICAgY29uc3Qga2V5ID0gZW50cnlbIDAgXTtcbiAgICAgICAgY29uc3QgdmFsdWUgPSBlbnRyeVsgMSBdO1xuICAgICAgICBpZiAoISh2YWx1ZSBpbnN0YW5jZW9mIE9ic2VydmFibGUpKSB7XG4gICAgICAgICAgYWNjdW11bGF0b3IuYWRkQ29udHJvbChcbiAgICAgICAgICAgIGtleSxcbiAgICAgICAgICAgICEhdmFsdWUgJiYgKFxuICAgICAgICAgICAgICB2YWx1ZSBpbnN0YW5jZW9mIEZvcm1Hcm91cCB8fCB2YWx1ZSBpbnN0YW5jZW9mIEZvcm1BcnJheSB8fCB2YWx1ZSBpbnN0YW5jZW9mIEZvcm1Db250cm9sXG4gICAgICAgICAgICApID9cbiAgICAgICAgICAgICAgdmFsdWUgOlxuICAgICAgICAgICAgICBtYWtlRm9ybTxUWyBTdHJpbmdLZXlzPFQ+IF0+KFxuICAgICAgICAgICAgICAgIHZhbHVlLFxuICAgICAgICAgICAgICAgIDxNYXA8Q29udHJvbHNOYW1lczxUWyBTdHJpbmdLZXlzPFQ+IF0+LCBWYWxpZGF0b3JGbltdIHwgbnVsbD4+IG1ha2VOZXdNYWluRm9ybVZhbGlkYXRvcnNNYXA8VmFsaWRhdG9yRm5bXSB8IG51bGwsIFQ+KGtleSwga2V5c1ZhbGlkYXRvciksXG4gICAgICAgICAgICAgICAgPE1hcDxDb250cm9sc05hbWVzPFRbIFN0cmluZ0tleXM8VD4gXT4sIEFzeW5jVmFsaWRhdG9yRm5bXSB8IG51bGw+PiBtYWtlTmV3TWFpbkZvcm1WYWxpZGF0b3JzTWFwPEFzeW5jVmFsaWRhdG9yRm5bXSB8IG51bGwsIFQ+KGtleSwgYXN5bmNLZXlzVmFsaWRhdG9yKSxcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICk7XG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiA8Rm9ybUdyb3VwVHlwZTxUPj4gYWNjdW11bGF0b3I7XG4gICAgICB9LCBuZXcgRm9ybUdyb3VwPHsgWyBLIGluIFN0cmluZ0tleXM8VD4gXTogU2NhbkZvcm1UeXBlPFRbIEsgXT47IH0+KDx7IFsgSyBpbiBTdHJpbmdLZXlzPFQ+IF06IFNjYW5Gb3JtVHlwZTxUWyBLIF0+OyB9PiB7fSxcbiAgICAgICAgZ2V0VmFsaWRhdG9yc09yTnVsbChpbnRlcm5hbEtleSwga2V5c1ZhbGlkYXRvciwgdHJ1ZSksXG4gICAgICAgIGdldFZhbGlkYXRvcnNPck51bGwoaW50ZXJuYWxLZXksIGFzeW5jS2V5c1ZhbGlkYXRvciwgZmFsc2UpXG4gICAgICApXG4gICAgKTtcbn1cblxuZnVuY3Rpb24gbWFrZU5ld01haW5Gb3JtVmFsaWRhdG9yc01hcDxUIGV4dGVuZHMgVmFsaWRhdG9yRm5bXSB8IEFzeW5jVmFsaWRhdG9yRm5bXSB8IG51bGwsIFA+KFxuICBrZXk6IFN0cmluZ0tleXM8UD4sIG9sZE1hcD86IE1hcDxzdHJpbmcsIFQ+LFxuKTogTWFwPHN0cmluZywgVD4gfCB1bmRlZmluZWQge1xuICBpZiAoIW9sZE1hcCB8fCBrZXkgPT09ICdtYWluRm9ybVZhbGlkYXRvcnMnIHx8IGtleSA9PT0gJ21haW5Gb3JtVmFsaWRhdG9yc0l0ZW1zJykge1xuICAgIHJldHVybiBvbGRNYXA7XG4gIH0gZWxzZSB7XG4gICAgaWYgKCFvbGRNYXAuaGFzKGtleSkgJiYgIW9sZE1hcC5oYXMoYCR7IGtleSB9SXRlbXNgKSkge1xuICAgICAgcmV0dXJuIG5ldyBNYXA8c3RyaW5nLCBUPihcbiAgICAgICAgQXJyYXkuZnJvbShcbiAgICAgICAgICBvbGRNYXAuZW50cmllcygpXG4gICAgICAgICkuZmlsdGVyKFxuICAgICAgICAgIGl0ZW0gPT4gaXRlbVsgMCBdICE9PSAnbWFpbkZvcm1WYWxpZGF0b3JzJyAmJiBpdGVtWyAwIF0gIT09ICdtYWluRm9ybVZhbGlkYXRvcnNJdGVtcydcbiAgICAgICAgKS5tYXAoXG4gICAgICAgICAgKFsgZW50cnlLZXksIGVudHJ5VmFsdWUgXSkgPT4gWyBlbnRyeUtleS5zdGFydHNXaXRoKGAkeyBrZXkgfS5gKSA/IGVudHJ5S2V5LnJlcGxhY2UoYCR7IGtleSB9LmAsICcnKSA6IGVudHJ5S2V5LCBlbnRyeVZhbHVlIF1cbiAgICAgICAgKVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgZmlsdGVyUHJlZGljYXRlID0gb2xkTWFwLmhhcygnbWFpbkZvcm1WYWxpZGF0b3JzJykgP1xuICAgICAgICBvbGRNYXAuaGFzKCdtYWluRm9ybVZhbGlkYXRvcnNJdGVtcycpID9cbiAgICAgICAgICAoaXRlbTogWyBzdHJpbmcsIFQgXSkgPT4gaXRlbVsgMCBdICE9PSBrZXkgJiYgaXRlbVsgMCBdICE9PSAnbWFpbkZvcm1WYWxpZGF0b3JzJyAmJiBpdGVtWyAwIF0gIT09ICdtYWluRm9ybVZhbGlkYXRvcnNJdGVtcycgOlxuICAgICAgICAgIChpdGVtOiBbIHN0cmluZywgVCBdKSA9PiBpdGVtWyAwIF0gIT09IGtleSAmJiBpdGVtWyAwIF0gIT09ICdtYWluRm9ybVZhbGlkYXRvcnMnIDpcbiAgICAgICAgb2xkTWFwLmhhcygnbWFpbkZvcm1WYWxpZGF0b3JzSXRlbXMnKSA/XG4gICAgICAgICAgKGl0ZW06IFsgc3RyaW5nLCBUIF0pID0+IGl0ZW1bIDAgXSAhPT0ga2V5ICYmIGl0ZW1bIDAgXSAhPT0gJ21haW5Gb3JtVmFsaWRhdG9yc0l0ZW1zJyA6XG4gICAgICAgICAgKGl0ZW06IFsgc3RyaW5nLCBUIF0pID0+IGl0ZW1bIDAgXSAhPT0ga2V5O1xuICAgICAgY29uc3QgbmV3TWFpblZhbGlkYXRvcnNBcnJheTogWyBzdHJpbmcsIFQgXVtdID0gb2xkTWFwLmhhcyhrZXkpID9cbiAgICAgICAgb2xkTWFwLmhhcyhgJHsga2V5IH1JdGVtc2ApID9cbiAgICAgICAgICBbXG4gICAgICAgICAgICBbICdtYWluRm9ybVZhbGlkYXRvcnMnLCBvbGRNYXAuZ2V0KGtleSkhIF0sXG4gICAgICAgICAgICBbICdtYWluRm9ybVZhbGlkYXRvcnNJdGVtcycsIG9sZE1hcC5nZXQoYCR7IGtleSB9SXRlbXNgKSEgXVxuICAgICAgICAgIF0gOlxuICAgICAgICAgIFtcbiAgICAgICAgICAgIFsgJ21haW5Gb3JtVmFsaWRhdG9ycycsIG9sZE1hcC5nZXQoa2V5KSEgXSxcbiAgICAgICAgICBdIDpcbiAgICAgICAgb2xkTWFwLmhhcyhgJHsga2V5IH1JdGVtc2ApID9cbiAgICAgICAgICBbXG4gICAgICAgICAgICBbICdtYWluRm9ybVZhbGlkYXRvcnNJdGVtcycsIG9sZE1hcC5nZXQoYCR7IGtleSB9SXRlbXNgKSEgXVxuICAgICAgICAgIF0gOlxuICAgICAgICAgIFtdO1xuICAgICAgcmV0dXJuIG5ldyBNYXA8c3RyaW5nLCBUPihbXG4gICAgICAgIC4uLm5ld01haW5WYWxpZGF0b3JzQXJyYXksXG4gICAgICAgIC4uLkFycmF5LmZyb20oXG4gICAgICAgICAgb2xkTWFwLmVudHJpZXMoKVxuICAgICAgICApLmZpbHRlcihmaWx0ZXJQcmVkaWNhdGUpLm1hcDxbIHN0cmluZywgVCBdPihcbiAgICAgICAgICAoWyBlbnRyeUtleSwgZW50cnlWYWx1ZSBdKSA9PiBbIGVudHJ5S2V5LnN0YXJ0c1dpdGgoYCR7IGtleSB9LmApID8gZW50cnlLZXkucmVwbGFjZShgJHsga2V5IH0uYCwgJycpIDogZW50cnlLZXksIGVudHJ5VmFsdWUgXVxuICAgICAgICApXG4gICAgICBdKTtcbiAgICB9O1xuICB9O1xufVxuXG4vKipcbkBmdW5jdGlvbiBtYWtlRm9ybSA8IFQgPlxuICDQpNCw0LHRgNC40YfQvdCw0Y8g0YTRg9C90LrRhtC40Y8g0LTQu9GPINGB0L7Qt9C00LDQvdC40Y8gQW5ndWxhciBSZWFjdGl2ZSBGb3JtLlxu0JIg0L7RgtC70LjRh9C40LUg0L7RgiDRgdGC0LDQvdC00LDRgNGC0L3QvtCz0L4gRm9ybUJ1aWxkZXIgLSDQsCDQsiDQv9Cw0LrQtdGC0LUgQGFuZ3VsYXIvZm9ybXMsINC/0YDQuCDRgdC+0LfQtNCw0L3QuNC4INGE0L7RgNC80Ysg0LjQtyDRgdC70L7QttC90YvRhSDQvtCx0YrQtdC60YLQvtCyLFxu0YHQvtGF0YDQsNC90Y/QtdGC0YHRjyDQstC70L7QttC10L3QvdC+0YHRgtGMINC60L7QvdGC0YDQvtC70L7QsiAtINC60LDQttC00YvQuSDQstC70L7QttC10L3QvdGL0Lkg0L7QsdGK0LXQutGCINC/0YDQtdCy0YDQsNGJ0LDQtdGC0YHRjyDQstC+INCy0LvQvtC20LXQvdC90YPRjiBGb3JtR3JvdXAsXG4gINC+0LHRi9GH0L3Ri9C1INGB0LLQvtC50YHRgtCy0LAg0L7QsdGK0LXQutGC0L7QsiDRgdGC0LDQvdC+0LLRj9GC0YHRjyBGb3JtQ29udHJvbCAtINCw0LzQuCwg0LAg0LzQsNGB0YHQuNCy0YsgLSBGb3JtQXJyYXkgLSDQvNC4Llxu0J/RgNC4INGN0YLQvtC8INGB0L7Qt9C00LDQstCw0LXQvNCw0Y8g0YTQvtGA0LzQsCDQuNC80LXQtdGCINCx0L7Qu9C10LUg0YHRgtGA0L7Qs9GD0Y4g0YLQuNC/0LjQt9Cw0YbQuNGOLlxuXG4gINCS0JDQltCd0J4hXG4gICDQp9GC0L7QsdGLINC40LfQsdC10LbQsNGC0Ywg0L7RiNC40LHQutC4INC/0LXRgNC10L/QvtC70L3QtdC90LjRjyDRgdGC0Y3QutCwINCy0YvQt9C+0LLQvtCyINCyINGA0LXQutGD0YDRgdC40LLQvdC+0Lwg0L/RgNC+0YbQtdGB0YHQtSDRgdC+0LfQtNCw0L3QuNGPINGE0L7RgNC80YssINC00LvRjyDQu9GO0LHRi9GFO1xuT2JzZXJ2YWJsZSAtINC30L3QsNGH0LXQvdC40Lko0LIg0YIu0YcuLCDQuiDQv9GA0LjQvNC10YDRgywgU3ViamVjdCAqINC4IEV2ZW50RW1pdHRlcikg0YHQvtC+0YLQstC10YLRgdGC0LLRg9GO0YnQuNC5INGN0LvQtdC80LXQvdGCINGE0L7RgNC80Ysg0L3QtSDRgdC+0LfQtNCw0LXRgtGB0Y8uXG4gKiBAcGFyYW0gc291cmNlICDQuNGB0YLQvtGH0L3QuNC6INC00LDQvdC90YvRhSDRgtC40L/QsCBUINC00LvRjyDRgdC+0LfQtNCw0L3QuNGPINGE0L7RgNC80YsuXG4gKiBAcGFyYW0ga2V5c1ZhbGlkYXRvciDQvtCx0YrQtdC60YIgTWFwINGBINC60L7QvdGE0LjQs9GD0YDQsNGG0LjQtdC5INGB0LjQvdGF0YDQvtC90L3Ri9GFINCy0LDQu9C40LTQsNGC0L7RgNC+0LIg0LrQvtC90YLRgNC+0LvQvtCyINGE0L7RgNC80YsuXG4gKiDQkiDQutCw0YfQtdGB0YLQstC1INC60LvRjtGH0LXQuSDQvNC+0LPRg9GCINCx0YvRgtGMINGD0LrQsNC30LDQvdGLINGB0LvQtdC00YPRjtGJ0LjQtSDQt9C90LDRh9C10L3QuNGPOlxuICogIFByb3BlcnR5ZXNLZXlzPFQ+IC0g0YHRgtGA0L7QutC+0LLRi9C1INC60LvRjtGH0Lgg0LIg0YLQuNC/0LUgVCwg0LLQutC70Y7Rh9Cw0Y8g0YHRgtGA0L7QutC+0LLRi9C1INC60LvRjtGH0Lgg0LLRgdC10YUg0LLQu9C+0LbQtdC90L3Ri9GFINGC0LjQv9C+0LIsINGA0LDQt9C00LXQu9C10L3QvdGL0LUgXCIuXCIgLSDRgtC+0YfQutC+0LkuXG4gICAg0J3QsNC/0YDQuNC80LXRgCDQuNC80LXQtdGC0YHRjyDRgtCw0LrQvtC5INGC0LjQvzpcbiAgICBgYGB0c1xuICAgICAgICAgICAgICAgICAgICBpbnRlcmZhY2UgVXNlciB7XG4gICAgICAgICAgICAgICAgICAgICAgZmlyc3RuYW1lOiBzdHJpbmc7XG4gICAgICAgICAgICAgICAgICAgICAgbGFzdG5hbWU6IHN0cmluZztcbiAgICAgICAgICAgICAgICAgICAgICBwaG9uZTogIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvZGU6IHN0cmluZztcbiAgICAgICAgICAgICAgICAgICAgICAgIG51bWJlcjogc3RyaW5nO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgYGBgXG4gICAg0JTQu9GPINGE0L7RgNC80YssINC60L7RgtC+0YDQsNGPINCx0YPQtNC10YIg0YHQvtC30LTQsNC90LAg0LjQtyDQvtCx0YrQtdC60YLQsCBVc2VyINCyINC60L7QvdGE0LjQs9GD0YDQsNGG0LjQuCDQstCw0LvQuNC00LDRgtC+0YDQvtCyINC90LDQt9Cy0LDQvdC40Y8g0LrQvtC90YLRgNC+0LvQvtCyINC80L7QttC90L4g0LHRg9C00LXRgiDRg9C60LDQt9Cw0YLRjCDRgtCw0Lo6XG4gICAgYGxhc3RuYW1lYCDQuNC70LhgcGhvbmVgLCDQuNC70LhgcGhvbmUuY29kZWAuXG5cbiAgICdtYWluRm9ybVZhbGlkYXRvcnMnIC0g0YHQv9C10YbQuNCw0LvRjNC90L7QtSDQt9C90LDRh9C10L3QuNC1LCDRj9Cy0LvRj9GO0YnQtdC10YHRjyDQv9GA0LjQt9C90LDQutC+0Lwg0YLQvtCz0L4sINGH0YLQviDQvNCw0YHRgdC40LIg0LLQsNC70LjQtNCw0YLQvtGA0L7QsiDQvdC10L7QsdGF0L7QtNC40LzQvlxuICAgINC90LDQt9C90LDRh9C40YLRjCDRgdCw0LzQvtC80YMg0L7QsdGK0LXQutGC0YMg0YTQvtGA0LzRiywg0LAg0L3QtSDQstC70L7QttC10L3Ri9C8INC60L7QvdGC0YDQvtC70LDQvC5cblxuICAgJ21haW5Gb3JtVmFsaWRhdG9yc0l0ZW1zJyAtINC40YHQv9C+0LvRjNC30YPQtdGC0YHRjyDRgtC+0LvRjNC60L4g0LXRgdC70Lggc291cmNlINGP0LLQu9GP0LXRgtGB0Y8g0LzQsNGB0YHQuNCy0L7QvC4g0KHQv9C10YbQuNCw0LvRjNC90L7QtSDQt9C90LDRh9C10L3QuNC1LCDRj9Cy0LvRj9GO0YnQtdC10YHRjyDQv9GA0LjQt9C90LDQutC+0Lwg0YLQvtCz0L4sXG4gINGH0YLQviDQvNCw0YHRgdC40LIg0LLQsNC70LjQtNCw0YLQvtGA0L7QsiDQvdC10L7QsdGF0L7QtNC40LzQviDQvdCw0LfQvdCw0YfQuNGC0Ywg0LTQu9GPINCy0YHQtdGFINGN0LvQtdC80LXQvdGC0L7QsiDQvNCw0YHRgdC40LLQsCBGb3JtQXJyYXkuXG4gKiBAcGFyYW0gYXN5bmNLZXlzVmFsaWRhdG9yINC+0LHRitC10LrRgiBNYXAsINCw0L3QsNC70L7Qs9C40YfQvdGL0Lkga2V5c1ZhbGlkYXRvciwg0L3QviDQtNC70Y8g0LDRgdC40L3RhdGA0L7QvdC90YvRhSDQstCw0LvQuNC00LDRgtC+0YDQvtCyXG4gKiBAcmV0dXJucyDQvtCx0YrQtdC60YIg0YLQuNC/0LjQt9C40YDQvtCy0LDQvdC90L7QuSDRhNC+0YDQvNGLIC0gRm9ybUdyb3VwLCBGb3JtQXJyYXkg0LjQu9C4IEZvcm1Db250cm9sINCyINC30LDQstC40YHQuNC80L7RgdGC0Lgg0L7RgiDRgtC40L/QsCDQt9C90LDRh9C10L3QuNGPIHNvdXJjZS5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIG1ha2VGb3JtPFQsIEUgPSBUIGV4dGVuZHMgQXJyYXk8aW5mZXIgVT4gPyBVIDogbmV2ZXI+KFxuICBzb3VyY2U6IFQsXG4gIGtleXNWYWxpZGF0b3I/OiBNYXA8Q29udHJvbHNOYW1lczxUPiwgVmFsaWRhdG9yRm5bXSB8IG51bGw+LFxuICBhc3luY0tleXNWYWxpZGF0b3I/OiBNYXA8Q29udHJvbHNOYW1lczxUPiwgQXN5bmNWYWxpZGF0b3JGbltdIHwgbnVsbD4sXG4pOiBTY2FuRm9ybVR5cGU8VD4ge1xuICBjb25zdCBmb3JtID0gISFzb3VyY2UgJiYgKHR5cGVvZiBzb3VyY2UgPT09ICdvYmplY3QnIHx8IHR5cGVvZiBzb3VyY2UgPT09ICdmdW5jdGlvbicpID9cbiAgICBzb3VyY2UgaW5zdGFuY2VvZiBBcnJheTxFPiA/XG4gICAgICBuZXcgRm9ybUFycmF5KFxuICAgICAgICBzb3VyY2UubWFwKFxuICAgICAgICAgIChpdGVtOiBFKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBpdGVtRm9ybSA9IG1ha2VGb3JtKFxuICAgICAgICAgICAgICBpdGVtLFxuICAgICAgICAgICAgICA8TWFwPENvbnRyb2xzTmFtZXM8RT4sIFZhbGlkYXRvckZuW10gfCBudWxsPj4gbWFrZU5ld01haW5Gb3JtVmFsaWRhdG9yc01hcCgnbWFpbkZvcm1WYWxpZGF0b3JzSXRlbXMnLCBrZXlzVmFsaWRhdG9yKSxcbiAgICAgICAgICAgICAgPE1hcDxDb250cm9sc05hbWVzPEU+LCBBc3luY1ZhbGlkYXRvckZuW10gfCBudWxsPj4gbWFrZU5ld01haW5Gb3JtVmFsaWRhdG9yc01hcCgnbWFpbkZvcm1WYWxpZGF0b3JzSXRlbXMnLCBhc3luY0tleXNWYWxpZGF0b3IpXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgcmV0dXJuIGl0ZW1Gb3JtO1xuICAgICAgICAgIH0pLFxuICAgICAgICBnZXRWYWxpZGF0b3JzT3JOdWxsKCdtYWluRm9ybVZhbGlkYXRvcnMnLCBrZXlzVmFsaWRhdG9yLCB0cnVlKSxcbiAgICAgICAgZ2V0VmFsaWRhdG9yc09yTnVsbCgnbWFpbkZvcm1WYWxpZGF0b3JzJywgYXN5bmNLZXlzVmFsaWRhdG9yLCBmYWxzZSlcbiAgICAgICkgOlxuICAgICAgbWFrZUZvcm1Hcm91cDxUPihzb3VyY2UsICdtYWluRm9ybVZhbGlkYXRvcnMnLCBrZXlzVmFsaWRhdG9yLCBhc3luY0tleXNWYWxpZGF0b3IpIDpcbiAgICBuZXcgRm9ybUNvbnRyb2w8VCB8IG51bGw+KFxuICAgICAgISFzb3VyY2UgJiYgdHlwZW9mIHNvdXJjZSA9PSAnc3RyaW5nJyAmJiAoc291cmNlLmluY2x1ZGVzKCcwMDAxLTAxLTAxJykgfHwgc291cmNlLmluY2x1ZGVzKCcxOTcwLTAxLTAxJykpID8gbnVsbCA6IHNvdXJjZVxuICAgICAgLFxuICAgICAgZ2V0VmFsaWRhdG9yc09yTnVsbCgnbWFpbkZvcm1WYWxpZGF0b3JzJywga2V5c1ZhbGlkYXRvciwgZmFsc2UpLFxuICAgICAgZ2V0VmFsaWRhdG9yc09yTnVsbCgnbWFpbkZvcm1WYWxpZGF0b3JzJywgYXN5bmNLZXlzVmFsaWRhdG9yLCBmYWxzZSlcbiAgICApO1xuICByZXR1cm4gPFNjYW5Gb3JtVHlwZTxUPj4gZm9ybTtcbn07XG5cbmZ1bmN0aW9uIGxpZnRFcnJvcnMoY29udHJvbDogQWJzdHJhY3RDb250cm9sKTogVmFsaWRhdGlvbkVycm9ycyB8IG51bGwge1xuICBpZiAoY29udHJvbCBpbnN0YW5jZW9mIEZvcm1Db250cm9sKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH0gZWxzZSB7XG4gICAgY29uc3QgYWxsQ29udHJvbHMgPSBjb250cm9sIGluc3RhbmNlb2YgRm9ybUdyb3VwID9cbiAgICAgIE9iamVjdC52YWx1ZXMoY29udHJvbC5jb250cm9scykgOlxuICAgICAgY29udHJvbCBpbnN0YW5jZW9mIEZvcm1BcnJheSA/XG4gICAgICAgIGNvbnRyb2wuY29udHJvbHMgOlxuICAgICAgICBbXTtcbiAgICBjb25zdCBpbnZhbGlkQ29udHJvbHMgPSBhbGxDb250cm9scy5maWx0ZXIoY29udHJvbCA9PiBjb250cm9sLnN0YXR1cyA9PT0gJ0lOVkFMSUQnKTtcbiAgICByZXR1cm4gaW52YWxpZENvbnRyb2xzLmxlbmd0aCA9PT0gMCA/IG51bGwgOiBpbnZhbGlkQ29udHJvbHMucmVkdWNlKFxuICAgICAgKGFjY3VtdWxhdG9yLCBjdXJyZW50KSA9PiB7XG4gICAgICAgIGlmIChjdXJyZW50LmVycm9ycykge1xuICAgICAgICAgIGFkZFZhbGlkYXRpb25FcnJvcnMoY3VycmVudC5lcnJvcnMsIGFjY3VtdWxhdG9yKTtcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIGFjY3VtdWxhdG9yO1xuICAgICAgfSwgPFZhbGlkYXRpb25FcnJvcnM+IHt9XG4gICAgKTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gbGlmdFZhbGlkYXRpb25FcnJvcnMoY29udHJvbDogQWJzdHJhY3RDb250cm9sKTogVmFsaWRhdGlvbkVycm9ycyB8IG51bGwge1xuICBjb25zdCBhbGxDb250cm9scyA9IGNvbnRyb2wgaW5zdGFuY2VvZiBGb3JtR3JvdXAgP1xuICAgIE9iamVjdC52YWx1ZXMoY29udHJvbC5jb250cm9scykgOlxuICAgIGNvbnRyb2wgaW5zdGFuY2VvZiBGb3JtQXJyYXkgP1xuICAgICAgY29udHJvbC5jb250cm9scyA6XG4gICAgICBbXTtcbiAgY29uc3QgaW52YWxpZENvbnRyb2xzID0gYWxsQ29udHJvbHMuZmlsdGVyKGNvbnRyb2wgPT4gY29udHJvbC5zdGF0dXMgPT09ICdJTlZBTElEJyk7XG4gIGNvbnN0IGVycm9yczogVmFsaWRhdGlvbkVycm9ycyA9IGludmFsaWRDb250cm9scy5sZW5ndGggPT09IDAgPyB7fSA6IGludmFsaWRDb250cm9scy5yZWR1Y2UoXG4gICAgKGFjY3VtdWxhdG9yLCBjdXJyZW50KSA9PiB7XG4gICAgICBpZiAoY3VycmVudC5lcnJvcnMpIHtcbiAgICAgICAgYWRkVmFsaWRhdGlvbkVycm9ycyhjdXJyZW50LmVycm9ycywgYWNjdW11bGF0b3IpO1xuICAgICAgfTtcbiAgICAgIGNvbnN0IGlubmVyRXJyb3JzID0gbGlmdFZhbGlkYXRpb25FcnJvcnMoY3VycmVudCk7XG4gICAgICBpZiAoaW5uZXJFcnJvcnMpIHtcbiAgICAgICAgYWRkVmFsaWRhdGlvbkVycm9ycyhpbm5lckVycm9ycywgYWNjdW11bGF0b3IpO1xuICAgICAgfTtcbiAgICAgIHJldHVybiBhY2N1bXVsYXRvcjtcbiAgICB9LCA8VmFsaWRhdGlvbkVycm9ycz4ge31cbiAgKTtcbiAgcmV0dXJuIE9iamVjdC52YWx1ZXMoZXJyb3JzKS5sZW5ndGggPT09IDAgPyBudWxsIDogZXJyb3JzO1xufTtcblxuZnVuY3Rpb24gYWRkVmFsaWRhdGlvbkVycm9ycyhhZGRpdGlvbkVycm9yczogVmFsaWRhdGlvbkVycm9ycywgY3VycmVudEVycm9yczogVmFsaWRhdGlvbkVycm9ycykge1xuICBPYmplY3QuZW50cmllcyhhZGRpdGlvbkVycm9ycykuZm9yRWFjaChcbiAgICBlbnRyeSA9PiBjdXJyZW50RXJyb3JzWyBlbnRyeVsgMCBdIF0gPSBlbnRyeVsgMSBdXG4gICk7XG59Il19